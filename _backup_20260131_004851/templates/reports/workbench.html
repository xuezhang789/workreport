{% extends "base_topbar.html" %}
{% load tz %}
{% block title %}ä¸ªäººå·¥ä½œå° / Workbench{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="ä¸ªäººå·¥ä½œå° / Workbench" nav_subtitle="æ™ºèƒ½å·¥ä½œåŠ©æ‰‹ï¼Œé«˜æ•ˆç®¡ç†ä»»åŠ¡ä¸æ—¥æŠ¥ / Smart work assistant for efficient task and report management" %}{% endblock %}

{% block extra_styles %}
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #8b5cf6;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background-color: var(--bg-page);
        color: var(--text-main);
    }

    /* --- Stats Grid --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: #cbd5e1;
    }

    .stat-card.highlight {
        background: linear-gradient(135deg, var(--bg-card), #f0f9ff);
        border-color: #bfdbfe;
    }

    .stat-icon {
        font-size: 24px;
        margin-bottom: 12px;
        width: 40px;
        height: 40px;
        display: grid;
        place-items: center;
        border-radius: 10px;
        background: var(--bg-page);
    }

    .stat-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--text-main);
        line-height: 1.1;
        margin-bottom: 4px;
        display: flex;
        align-items: baseline;
        gap: 4px;
    }

    .stat-unit {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
    }

    .stat-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .stat-trend {
        margin-top: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
        background: #f1f5f9;
        color: var(--text-secondary);
        width: fit-content;
    }
    .trend-up { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .trend-down { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .trend-neutral { background: #f1f5f9; color: var(--text-secondary); }

    /* --- Dashboard Grid --- */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
    }

    /* --- Quick Actions --- */
    .section-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
    }

    .action-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: var(--bg-page);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        text-decoration: none;
        transition: var(--transition);
    }

    .action-card:hover {
        background: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .action-icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: white;
        display: grid;
        place-items: center;
        font-size: 24px;
        border: 1px solid var(--border-color);
        flex-shrink: 0;
        color: var(--primary);
    }
    
    .action-card:hover .action-icon-box {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .action-info {
        flex: 1;
    }

    .action-name {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 4px;
    }

    .action-sub {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    /* --- Standard Table --- */
    .table-container {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th, .table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
    }

    .table th {
        background: #f8fafc;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.05em;
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
    }
    .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .badge-neutral { background: #f1f5f9; color: var(--text-secondary); }

    /* --- Onboarding Banner --- */
    .onboarding-banner {
        background: linear-gradient(135deg, #ecfdf5, #f0f9ff);
        border: 1px solid #a7f3d0;
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .onboarding-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .step-item {
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .step-num {
        width: 24px; height: 24px;
        background: var(--success);
        color: white;
        border-radius: 50%;
        display: grid; place-items: center;
        font-size: 12px; font-weight: 700;
        flex-shrink: 0;
    }

    /* --- Guidance Banner --- */
    .guidance-banner {
        background: white;
        border-left: 4px solid var(--primary);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 16px;
    }
    .guidance-banner.urgent { border-left-color: var(--danger); background: #fef2f2; }
    .guidance-banner.warning { border-left-color: var(--warning); background: #fffbeb; }

    @media (max-width: 1024px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
        .stats-grid { grid-template-columns: 1fr 1fr; }
        .actions-grid { grid-template-columns: 1fr; }
    }
{% endblock %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto; padding-bottom: 40px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 800; color: var(--text-main); margin: 0 0 4px 0;">ä¸ªäººå·¥ä½œå° / Workbench</h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">{{ today|date:"Yå¹´mæœˆdæ—¥ l" }}</p>
        </div>
        <div>
            <!-- Reserved for potential global actions -->
        </div>
    </div>

    <!-- Onboarding Section -->
    {% if streak < 3 or task_stats.total == 0 %}
    <div class="onboarding-banner">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">ğŸ‰</span>
            <div>
                <h3 style="margin: 0; font-size: 18px; color: #065f46;">æ¬¢è¿ä½¿ç”¨å·¥ä½œå°ï¼/ Welcome!</h3>
                <p style="margin: 4px 0 0; color: #047857; font-size: 13px;">å®Œæˆä»¥ä¸‹æ­¥éª¤å¿«é€Ÿä¸Šæ‰‹ / Follow these steps to get started</p>
            </div>
        </div>
        <div class="onboarding-steps">
            <div class="step-item">
                <div class="step-num">1</div>
                <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">æäº¤é¦–ä»½æ—¥æŠ¥ <br><span style="font-weight:400; color:var(--text-secondary);">Submit Report</span></div>
            </div>
            <div class="step-item">
                <div class="step-num">2</div>
                <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">ç®¡ç†ä»»åŠ¡ <br><span style="font-weight:400; color:var(--text-secondary);">Manage Tasks</span></div>
            </div>
            <div class="step-item">
                <div class="step-num">3</div>
                <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">æŸ¥çœ‹æ•°æ® <br><span style="font-weight:400; color:var(--text-secondary);">View Analytics</span></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Guidance Banner -->
    {% if guidance.primary %}
    <div class="guidance-banner {{ guidance.status }}">
        <div style="font-size: 24px;">
            {% if guidance.status == 'urgent' %}ğŸš¨
            {% elif guidance.status == 'warning' %}âš ï¸
            {% elif guidance.status == 'info' %}ğŸ’¡
            {% else %}ğŸ¯{% endif %}
        </div>
        <div style="flex: 1;">
            <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 700; color: var(--text-main);">{{ guidance.primary }}</h3>
            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">{{ guidance.secondary }}</p>
            
            {% if guidance.actions %}
            <div style="display: flex; gap: 12px;">
                {% for action in guidance.actions %}
                    <a href="{% url action.url %}" class="btn {% if action.priority == 'high' %}btn-primary{% else %}btn-secondary{% endif %} btn-sm" style="text-decoration: none;">
                        {{ action.text }}
                    </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Stats Grid -->
    <div class="stats-grid">
        <!-- Today's Report Status -->
        <div class="stat-card {% if missing_today %}highlight{% endif %}" data-card="today">
            <div class="stat-icon" style="color: {% if missing_today %}var(--warning){% else %}var(--success){% endif %}; background: {% if missing_today %}#fffbeb{% else %}#ecfdf5{% endif %};">
                {% if missing_today %}âš ï¸{% else %}âœ…{% endif %}
            </div>
            <div class="stat-value" style="font-size: 20px;">
                {% if missing_today %}æœªæäº¤ / Missing{% else %}å·²æäº¤ / Done{% endif %}
            </div>
            <div class="stat-label">ä»Šæ—¥æ—¥æŠ¥ / Today</div>
            {% if missing_today %}
                <a href="{% url 'reports:daily_report_create' %}" class="stat-trend trend-down" style="text-decoration:none; margin-top: auto;">ç«‹å³æäº¤ / Submit Now &rarr;</a>
            {% else %}
                <div class="stat-trend trend-up" style="margin-top: auto;">ä¿æŒä¼˜ç§€ / Keep it up</div>
            {% endif %}
        </div>

        <!-- Task Stats -->
        <div class="stat-card" data-card="total">
            <div class="stat-icon" style="color: var(--primary);">ğŸ“‹</div>
            <div class="stat-value">{{ task_stats.total }}</div>
            <div class="stat-label">ä»»åŠ¡æ€»æ•° / Total</div>
        </div>

        <div class="stat-card" data-card="in_progress">
            <div class="stat-icon" style="color: var(--info);">ğŸš€</div>
            <div class="stat-value">{{ task_stats.in_progress }}</div>
            <div class="stat-label">è¿›è¡Œä¸­ / WIP</div>
        </div>

        <div class="stat-card" data-card="overdue">
            <div class="stat-icon" style="color: var(--danger);">âš ï¸</div>
            <div class="stat-value" style="color: var(--danger);">{{ task_stats.overdue }}</div>
            <div class="stat-label">é€¾æœŸ / Overdue</div>
        </div>

        <div class="stat-card" data-card="rate">
            <div class="stat-icon" style="color: var(--success);">ğŸ“Š</div>
            <div class="stat-value">{{ task_stats.completion_rate|floatformat:0 }}<span class="stat-unit">%</span></div>
            <div class="stat-label">å®Œæˆç‡ / Rate</div>
            <div class="progress-bar" style="height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 8px; width: 100%;">
                <div style="height: 100%; width: {{ task_stats.completion_rate }}%; background: var(--success); border-radius: 2px;"></div>
            </div>
        </div>

        <div class="stat-card" data-card="streak">
            <div class="stat-icon" style="color: #f59e0b;">ğŸ”¥</div>
            <div class="stat-value">{{ streak }}</div>
            <div class="stat-label">è¿ç­¾ / Streak</div>
        </div>
    </div>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-grid">
        
        <!-- Left Column: Quick Actions & Burndown -->
        <div style="display: flex; flex-direction: column; gap: 24px;">
            
            <!-- Quick Actions -->
            <section class="section-card">
                <div class="section-header">
                    <h3 class="section-title">âš¡ å¿«é€Ÿæ“ä½œ / Quick Actions</h3>
                </div>
                <div class="actions-grid">
                    {% if not has_today_report %}
                    <a href="{% url 'reports:daily_report_create' %}" class="action-card">
                        <div class="action-icon-box">ğŸ“</div>
                        <div class="action-info">
                            <div class="action-name">æäº¤æ—¥æŠ¥</div>
                            <div class="action-sub">Submit Report</div>
                        </div>
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'tasks:admin_task_stats' %}?date={{ today }}" class="action-card">
                        <div class="action-icon-box">â°</div>
                        <div class="action-info">
                            <div class="action-name">ç¼ºæŠ¥åˆ—è¡¨</div>
                            <div class="action-sub">Missing Reports</div>
                        </div>
                    </a>

                    <a href="{% url 'tasks:task_list' %}" class="action-card">
                        <div class="action-icon-box">ğŸ“‹</div>
                        <div class="action-info">
                            <div class="action-name">æˆ‘çš„ä»»åŠ¡</div>
                            <div class="action-sub">My Tasks</div>
                        </div>
                    </a>

                    {% if request.user.is_staff or request.user.managed_projects.all %}
                    <a href="{% url 'tasks:admin_task_create' %}" class="action-card">
                        <div class="action-icon-box">â•</div>
                        <div class="action-info">
                            <div class="action-name">åˆ›å»ºä»»åŠ¡</div>
                            <div class="action-sub">Create Task</div>
                        </div>
                    </a>
                    {% endif %}

                    <a href="{% url 'projects:project_list' %}" class="action-card">
                        <div class="action-icon-box">ğŸš€</div>
                        <div class="action-info">
                            <div class="action-name">é¡¹ç›®æ¦‚è§ˆ</div>
                            <div class="action-sub">Projects</div>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Project Burndown -->
            <section class="section-card">
                <div class="section-header">
                    <h3 class="section-title">ğŸ”¥ é¡¹ç›®è¿›åº¦ç‡ƒå°½ / Project Burndown</h3>
                    <span style="font-size: 12px; font-weight: 600; color: var(--text-secondary); background: var(--bg-page); padding: 4px 10px; border-radius: 12px;">{{ project_burndown|length }} Projects</span>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>é¡¹ç›® / Project</th>
                                <th>æ€»ä»»åŠ¡ / Total</th>
                                <th>å·²å®Œæˆ / Done</th>
                                <th>è¿›è¡Œä¸­ / WIP</th>
                                <th>å‰©ä½™ / Left</th>
                                <th>è¿›åº¦ / Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in project_burndown %}
                            <tr>
                                <td>
                                    <div style="font-weight: 600; color: var(--text-main);">{{ row.project }}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">{{ row.code }}</div>
                                </td>
                                <td>{{ row.total }}</td>
                                <td style="color: var(--success); font-weight: 600;">{{ row.completed }}</td>
                                <td>{{ row.in_progress }}</td>
                                <td>{{ row.remaining }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="progress-bar" style="height: 4px; background: #f1f5f9; width: 60px; border-radius: 2px;">
                                            <div style="height: 100%; width: {{ row.completion_rate }}%; background: {% if row.completion_rate >= 80 %}var(--success){% elif row.completion_rate >= 50 %}var(--warning){% else %}var(--danger){% endif %}; border-radius: 2px;"></div>
                                        </div>
                                        <span style="font-size: 12px; font-weight: 600;">{{ row.completion_rate|floatformat:0 }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 32px; color: var(--text-muted);">
                                    æš‚æ— é¡¹ç›®æ•°æ® / No project data
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

        </div>

        <!-- Right Column: Recent Reports -->
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <section class="section-card" style="height: 100%;">
                <div class="section-header">
                    <h3 class="section-title">ğŸ“ è¿‘æœŸæ—¥æŠ¥ / Recent Reports</h3>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ / Date</th>
                                <th>çŠ¶æ€ / Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in recent_reports %}
                            <tr>
                                <td>
                                    <div style="font-weight: 600; color: var(--text-main);">{{ r.date }}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">{{ r.get_role_display }}</div>
                                </td>
                                <td>
                                    {% if r.status == 'submitted' %}
                                        <span class="status-badge badge-success">å·²æäº¤ / Submitted</span>
                                    {% elif r.status == 'draft' %}
                                        <span class="status-badge badge-warning">è‰ç¨¿ / Draft</span>
                                    {% else %}
                                        <span class="status-badge badge-neutral">{{ r.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 32px; color: var(--text-muted);">
                                    æš‚æ— è®°å½• / No records
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: center;">
                    <a href="{% url 'reports:my_reports' %}" class="btn btn-ghost btn-sm">æŸ¥çœ‹å…¨éƒ¨ / View All &rarr;</a>
                </div>
            </section>
        </div>

    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Simple script to handle card visibility preference if needed
    // Currently kept simple to match the clean design requirement
    (function() {
        const key = 'workbench_cards_v2';
        // Future: Implement card toggling if requested
    })();
</script>
{% endblock %}
