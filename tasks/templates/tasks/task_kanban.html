{% extends "base_topbar.html" %}
{% load static %}

{% block title %}ä»»åŠ¡çœ‹æ¿ / Task Kanban{% endblock %}

{% block extra_styles %}
<style>
    .kanban-board {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 1rem;
        height: calc(100vh - 180px);
    }
    
    .kanban-column {
        flex: 0 0 320px;
        background: var(--bg-secondary);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        border: 1px solid var(--border-color);
    }
    
    .kanban-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-color);
        border-radius: 8px 8px 0 0;
    }
    
    .kanban-header .count {
        background: var(--bg-tertiary);
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .kanban-items {
        padding: 0.8rem;
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    
    .kanban-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.8rem;
        cursor: grab;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }
    
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-color: var(--primary-color);
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
        border-style: dashed;
    }
    
    .kanban-card-title {
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .kanban-card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .kanban-card-project {
        background: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .kanban-card-due {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .kanban-card-due.overdue {
        color: var(--danger-color);
        font-weight: 500;
    }
    
    .status-todo { border-top: 3px solid var(--text-secondary); }
    .status-in_progress { border-top: 3px solid var(--primary-color); }
    .status-blocked { border-top: 3px solid var(--danger-color); }
    .status-in_review { border-top: 3px solid var(--warning-color); }
    .status-done { border-top: 3px solid var(--success-color); }
    
    .filter-bar {
        margin-bottom: 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">ä»»åŠ¡çœ‹æ¿ / Kanban Board</h1>
        <div class="page-actions">
            <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary">
                <span>ğŸ“‹</span> åˆ—è¡¨è§†å›¾ / List View
            </a>
            <a href="{% url 'reports:daily_report_create' %}" class="btn btn-primary">
                <span>â•</span> æ–°å»ºä»»åŠ¡ / New Task
            </a>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-board">
        <!-- Pending Column -->
        <div class="kanban-column status-pending">
            <div class="kanban-header">
                <span>å¾…å¤„ç† / Pending</span>
                <span class="count">{{ tasks_pending|length }}</span>
            </div>
            <div class="kanban-items" id="col-pending" data-status="pending">
                {% for task in tasks_pending %}
                    {% include "reports/partials/kanban_card.html" with task=task %}
                {% endfor %}
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="kanban-column status-in_progress">
            <div class="kanban-header">
                <span>è¿›è¡Œä¸­ / In Progress</span>
                <span class="count">{{ tasks_in_progress|length }}</span>
            </div>
            <div class="kanban-items" id="col-in_progress" data-status="in_progress">
                {% for task in tasks_in_progress %}
                    {% include "reports/partials/kanban_card.html" with task=task %}
                {% endfor %}
            </div>
        </div>
        
        <!-- On Hold Column -->
        <div class="kanban-column status-on_hold">
            <div class="kanban-header">
                <span>æŒ‚èµ· / On Hold</span>
                <span class="count">{{ tasks_on_hold|length }}</span>
            </div>
            <div class="kanban-items" id="col-on_hold" data-status="on_hold">
                {% for task in tasks_on_hold %}
                    {% include "reports/partials/kanban_card.html" with task=task %}
                {% endfor %}
            </div>
        </div>

        <!-- Completed Column -->
        <div class="kanban-column status-completed">
            <div class="kanban-header">
                <span>å·²å®Œæˆ / Completed</span>
                <span class="count">{{ tasks_completed|length }}</span>
            </div>
            <div class="kanban-items" id="col-completed" data-status="completed">
                {% for task in tasks_completed %}
                    {% include "reports/partials/kanban_card.html" with task=task %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const columns = document.querySelectorAll('.kanban-items');
        
        columns.forEach(col => {
            new Sortable(col, {
                group: 'kanban', // set both lists to same group
                animation: 150,
                ghostClass: 'dragging',
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const newStatus = evt.to.dataset.status;
                    const taskId = itemEl.dataset.id;
                    const oldStatus = evt.from.dataset.status;

                    if (newStatus === oldStatus) return;

                    // Update UI immediately (count)
                    updateCounts();

                    // Send API request
                    fetch("{% url 'tasks:task_update_status_api' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            status: newStatus
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Optional: show toast
                        } else {
                            // Revert if failed (optional, or just alert)
                            alert('Status update failed: ' + (data.error || 'Unknown error'));
                            // Ideally revert DOM change here
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Network error');
                    });
                }
            });
        });

        function updateCounts() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                const count = col.querySelectorAll('.kanban-card').length;
                col.querySelector('.count').textContent = count;
            });
        }
    });
</script>
{% endblock %}
