<form id="bulkForm" method="post" action="{% url 'tasks:task_bulk_action' %}">
    {% csrf_token %}
    <input type="hidden" name="bulk_action" id="bulkActionInput">
    <input type="hidden" name="redirect_to" value="{{ request.get_full_path }}">

    {% if tasks %}
        <!-- Grid/List View Container -->
        <div id="taskGrid" class="task-grid">
            {% for task in tasks %}
            <article class="task-card" id="task-{{ task.id }}" data-status="{{ task.status }}" data-id="{{ task.id }}">
                <div class="card-status-bar status-{{ task.status }}"></div>
                
                <div class="task-checkbox-container">
                    <input type="checkbox" name="task_ids" value="{{ task.id }}" class="task-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                </div>

                <div class="card-body">
                    <div class="badge-group">
                        <span class="chip" style="background: white; border: 1px solid var(--border-color); font-size: 10px;">{{ task.project.code }}</span>
                        {% if task.category == 'BUG' %}
                            <span class="chip" style="background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; font-size: 10px;">BUG</span>
                        {% else %}
                            <span class="chip" style="background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; font-size: 10px;">TASK</span>
                        {% endif %}
                        {% if task.priority == 'high' %}
                            <span class="chip" style="background: #fee2e2; color: #ef4444; border: none; font-size: 10px;">High</span>
                        {% endif %}
                        {% if task.sla_info.status == 'overdue' %}
                            <span class="chip" style="background: #fee2e2; color: #ef4444; border: 1px solid #ef4444; font-size: 10px;">URGENT</span>
                        {% elif task.sla_info.status == 'completed_late' %}
                            <span class="chip" style="background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; font-size: 10px;">LATE</span>
                        {% endif %}
                    </div>

                    <h3 class="task-title">
                        <a href="{% url 'tasks:task_view' task.id %}">{{ task.title }}</a>
                    </h3>

                    <p class="task-content">
                        {{ task.content|striptags|truncatechars:100|default:"无详细内容 / No details" }}
                    </p>

                    <div class="card-meta-grid">
                        <div class="meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <span class="{% if task.sla_info.level == 'red' %}text-danger fw-bold{% endif %}">
                                {% if task.due_at %}{{ task.due_at|date:"m-d H:i" }}{% else %}--{% endif %}
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: {% if task.status == 'done' %}var(--success){% elif task.status == 'in_progress' %}var(--primary){% else %}var(--text-muted){% endif %}"></span>
                            <span>{{ task.get_status_display }}</span>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    {% include "partials/user_avatar.html" with user=task.user size="32px" %}

                    <div style="display: flex; gap: 8px;">
                        {% if task.status != 'done' and task.status != 'closed' %}
                        <button type="submit" name="action" value="complete" formaction="{% url 'tasks:task_complete' task.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-secondary" onclick="showLoading()">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            完成 / Complete
                        </button>
                        {% endif %}
                        <a href="{% url 'tasks:task_view' task.id %}" class="btn btn-sm btn-ghost">详情 / Details</a>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>

        <!-- Kanban View Container (Populated via JS) -->
        <div id="kanbanBoard" class="kanban-container">
            <div class="kanban-column" data-status="todo">
                <div class="kanban-header">待处理 / To Do <span class="count" id="count-todo">0</span></div>
                <div class="kanban-body" id="col-todo"></div>
            </div>
            <div class="kanban-column" data-status="in_progress">
                <div class="kanban-header">进行中 / In Progress <span class="count" id="count-in_progress">0</span></div>
                <div class="kanban-body" id="col-in_progress"></div>
            </div>
            <div class="kanban-column" data-status="in_review">
                <div class="kanban-header">待评审 / Review <span class="count" id="count-in_review">0</span></div>
                <div class="kanban-body" id="col-in_review"></div>
            </div>
            <div class="kanban-column" data-status="blocked">
                <div class="kanban-header">阻塞 / Blocked <span class="count" id="count-blocked">0</span></div>
                <div class="kanban-body" id="col-blocked"></div>
            </div>
            <div class="kanban-column" data-status="done">
                <div class="kanban-header">已完成 / Done <span class="count" id="count-done">0</span></div>
                <div class="kanban-body" id="col-done"></div>
            </div>
        </div>

    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
            <h3>没有找到任务 / No tasks found</h3>
            <p>尝试调整筛选条件，或者休息一下？ / Try adjusting filters, or take a break?</p>
            <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary">重置筛选 / Reset Filters</a>
        </div>
    {% endif %}

    <!-- Sticky Bulk Toolbar -->
    <div id="bulkToolbar" class="bulk-toolbar">
        <div class="bulk-info">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            <span>已选择 <span id="selectedCount">0</span> 项 / Selected</span>
        </div>
        <div class="bulk-actions">
            <button type="button" class="bulk-btn" onclick="submitBulk('complete')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                标记完成 / Mark Complete
            </button>
            <button type="button" class="bulk-btn" onclick="submitBulk('reopen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                重新打开 / Reopen
            </button>
            {% if is_superuser %}
            <button type="button" class="bulk-btn" style="color: #fca5a5; border-color: rgba(252, 165, 165, 0.3);" onclick="submitBulk('delete')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                批量删除 / Bulk Delete
            </button>
            {% endif %}
        </div>
    </div>
</form>

<!-- Pagination -->
{% if tasks.paginator.num_pages > 1 %}
<div class="pagination-container" id="paginationControl">
    <div class="pagination-info">
        第 {{ tasks.number }} / {{ tasks.paginator.num_pages }} 页，共 {{ tasks.paginator.count }} 条
    </div>
    <div class="pagination-controls">
        {% if tasks.has_previous %}
            <a href="?page={{ tasks.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" class="page-btn" hx-get="{% url 'tasks:task_list' %}?page={{ tasks.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" hx-target="#taskListContainer" hx-push-url="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </a>
        {% else %}
            <span class="page-btn disabled"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></span>
        {% endif %}

        {% for i in tasks.paginator.page_range %}
            {% if tasks.number == i %}
                <span class="page-btn active">{{ i }}</span>
            {% elif i > tasks.number|add:'-3' and i < tasks.number|add:'3' %}
                <a href="?page={{ i }}&{{ request.GET.urlencode|cut:'page=' }}" class="page-btn" hx-get="{% url 'tasks:task_list' %}?page={{ i }}&{{ request.GET.urlencode|cut:'page=' }}" hx-target="#taskListContainer" hx-push-url="true">{{ i }}</a>
            {% endif %}
        {% endfor %}

        {% if tasks.has_next %}
            <a href="?page={{ tasks.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" class="page-btn" hx-get="{% url 'tasks:task_list' %}?page={{ tasks.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" hx-target="#taskListContainer" hx-push-url="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </a>
        {% else %}
            <span class="page-btn disabled"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
        {% endif %}
    </div>
</div>
{% endif %}
