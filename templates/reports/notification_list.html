{% extends "base_topbar.html" %}
{% load static %}
{% load tz %}

{% block title %}ÈÄöÁü•‰∏≠ÂøÉ / Notification Center{% endblock %}

{% block nav_header %}
    {% include "partials/nav.html" with nav_title="ÈÄöÁü•‰∏≠ÂøÉ / Notification Center" nav_subtitle="Êü•ÁúãÊâÄÊúâÂéÜÂè≤Ê∂àÊÅØ‰∏éÊèêÈÜí / View all history messages & alerts" %}
{% endblock %}

{% block extra_styles %}
<style>
    /* --- Design System (Consistent with Admin Pages) --- */
    .page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
        min-height: calc(100vh - 80px);
    }

    .panel {
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
    }

    .panel-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
    }

    .panel-title h2 {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-bar {
        display: flex;
        gap: 12px;
        padding: 16px 24px;
        background: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: transparent;
    }

    .filter-btn:hover {
        background: #e2e8f0;
        color: var(--text-main);
    }

    .filter-btn.active {
        background: #fff;
        color: var(--primary);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
        font-weight: 600;
    }

    .notif-list {
        display: flex;
        flex-direction: column;
    }

    .notif-item {
        display: flex;
        gap: 16px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
        cursor: pointer;
        position: relative;
    }

    .notif-item:last-child {
        border-bottom: none;
    }

    .notif-item:hover {
        background: #f8fafc;
    }

    .notif-item.unread {
        background: #eff6ff;
    }

    .notif-item.unread:hover {
        background: #e0f2fe;
    }

    .notif-item.priority-high {
        border-left: 4px solid #ef4444;
    }

    .notif-item.priority-high .notif-icon-wrapper {
        color: #ef4444;
        background: #fee2e2;
    }

    .notif-item.priority-normal {
        /* Default style */
    }

    .notif-item.priority-low {
        opacity: 0.8;
    }

    .notif-icon-wrapper {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 18px;
        background: #f1f5f9;
        color: var(--text-secondary);
    }

    .notif-item.unread .notif-icon-wrapper {
        background: #dbeafe;
        color: var(--primary);
    }

    .notif-content {
        flex: 1;
        min-width: 0; /* Fix flex text overflow */
    }

    .notif-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
    }

    .notif-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-main);
        line-height: 1.4;
    }

    .notif-time {
        font-size: 12px;
        color: var(--text-secondary);
        white-space: nowrap;
        margin-left: 12px;
    }

    .notif-msg {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .notif-actions {
        display: flex;
        gap: 12px;
        opacity: 0; /* Hide by default */
        transition: opacity 0.2s;
    }

    .notif-item:hover .notif-actions {
        opacity: 1;
    }

    .btn-action {
        font-size: 12px;
        color: var(--primary);
        cursor: pointer;
        padding: 4px 0;
        background: none;
        border: none;
        font-weight: 500;
    }
    
    .btn-action:hover {
        text-decoration: underline;
    }

    .empty-state {
        padding: 60px 20px;
        text-align: center;
        color: var(--text-secondary);
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    /* Type Specific Colors */
    .type-task .notif-icon-wrapper { color: #2563eb; background: #eff6ff; }
    .type-mention .notif-icon-wrapper { color: #ca8a04; background: #fef9c3; }
    .type-sla .notif-icon-wrapper { color: #dc2626; background: #fef2f2; }
    .type-system .notif-icon-wrapper { color: #475569; background: #f1f5f9; }

    /* Responsive */
    @media (max-width: 640px) {
        .notif-item { padding: 16px; }
        .notif-header { flex-direction: column; gap: 4px; }
        .notif-time { margin-left: 0; }
        .notif-actions { opacity: 1; margin-top: 8px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="panel">
        <!-- Header -->
        <div class="panel-header">
            <div class="panel-title">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    ÈÄöÁü•‰∏≠ÂøÉ <span style="font-weight: 400; color: var(--text-secondary); font-size: 16px; margin-left: 8px;">/ Notification Center</span>
                </h2>
            </div>
            <div style="display: flex; gap: 12px;">
                <button id="mark-all-read-page" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    ÂÖ®ÈÉ®Â∑≤ËØª / Mark All Read
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">ÂÖ®ÈÉ® / All</button>
            <button class="filter-btn" data-filter="unread">Êú™ËØª / Unread</button>
            <div style="width: 1px; height: 16px; background: #cbd5e1; margin: 0 4px;"></div>
            <button class="filter-btn" data-filter="task">‰ªªÂä° / Task</button>
            <button class="filter-btn" data-filter="mention">ÊèêÂèä / Mention</button>
            <button class="filter-btn" data-filter="system">Á≥ªÁªü / System</button>
        </div>
        
        <!-- List Container -->
        <div class="notif-list" id="notification-list-container">
            {% for n in notifications %}
                <div class="notif-item {% if not n.is_read %}unread{% endif %} priority-{{ n.priority }} type-{% if 'task' in n.notification_type %}task{% elif 'mention' in n.notification_type %}mention{% elif 'sla' in n.notification_type %}sla{% else %}system{% endif %}" 
                     data-id="{{ n.id }}"
                     data-type="{{ n.notification_type }}"
                     data-read="{{ n.is_read|yesno:'true,false' }}"
                     onclick="handleItemClick(this, '{{ n.notification_type }}', '{{ n.data.task_id|default:'' }}')">
                    
                    <div class="notif-icon-wrapper">
                        {% if n.priority == 'high' %}
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        {% elif 'task' in n.notification_type %}
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                        {% elif 'mention' in n.notification_type %}
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
                        {% elif 'sla' in n.notification_type %}
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        {% else %}
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        {% endif %}
                    </div>
                    
                    <div class="notif-content">
                        <div class="notif-header">
                            <span class="notif-title">
                                {% if n.priority == 'high' %}<span style="color: #ef4444; margin-right: 4px;">[Á¥ßÊÄ• / Urgent]</span>{% endif %}
                                {{ n.title }}
                            </span>
                            <span class="notif-time">{{ n.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="notif-msg">{{ n.message }}</div>
                        <div class="notif-actions">
                            {% if n.data.task_id %}
                                <button class="btn-action">Êü•ÁúãËØ¶ÊÉÖ / View Details</button>
                            {% endif %}
                            {% if not n.is_read %}
                                <button class="btn-action" onclick="event.stopPropagation(); markRead({{ n.id }}, this)">Ê†á‰∏∫Â∑≤ËØª / Mark Read</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <div>ÊöÇÊó†ÈÄöÁü• / No notifications found</div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- Filtering Logic ---
    const filterBtns = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.notif-item');

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Update Active State
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const filter = btn.dataset.filter;
            let hasVisible = false;

            items.forEach(item => {
                let show = false;
                if (filter === 'all') show = true;
                else if (filter === 'unread') show = item.dataset.read === 'false';
                else if (filter === 'task') show = item.dataset.type.includes('task');
                else if (filter === 'mention') show = item.dataset.type.includes('mention');
                else if (filter === 'system') show = !item.dataset.type.includes('task') && !item.dataset.type.includes('mention');

                item.style.display = show ? 'flex' : 'none';
                if (show) hasVisible = true;
            });
            
            // Check empty state visibility (optional enhancement)
        });
    });

    // --- Interaction Logic ---
    window.handleItemClick = function(el, type, targetId) {
        const id = el.dataset.id;
        // If unread, mark read first
        if (el.dataset.read === 'false') {
            markRead(id, el, false);
        }

        // Navigate
        if (targetId && targetId !== 'None') {
             window.location.href = `/tasks/${targetId}/view/`;
        }
    };

    window.markRead = function(id, el, stopProp = true) {
        if (stopProp && event) event.stopPropagation();
        
        fetch(`/reports/api/notifications/${id}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(res => {
            if (res.ok) {
                // Update UI without reload
                const item = document.querySelector(`.notif-item[data-id="${id}"]`);
                if (item) {
                    item.classList.remove('unread');
                    item.dataset.read = 'true';
                    // Remove "Mark Read" button
                    const btn = item.querySelector('button[onclick*="markRead"]');
                    if (btn) btn.remove();
                }
            }
        });
    };

    document.getElementById('mark-all-read-page').addEventListener('click', function() {
        if (!confirm('Á°ÆÂÆöÂ∞ÜÊâÄÊúâÈÄöÁü•Ê†áËÆ∞‰∏∫Â∑≤ËØªÔºü\nMark all notifications as read?')) return;
        
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = 'Processing...';

        fetch("{% url 'reports:mark_all_read_api' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(() => {
            window.location.reload();
        });
    });
</script>
{% endblock %}
