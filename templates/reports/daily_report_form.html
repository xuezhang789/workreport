{% extends "base_topbar.html" %}
{% load tz %}
{% block title %}å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥ / Daily Report{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥ / Daily Report" nav_subtitle="æ™ºèƒ½è¡¨å• Â· å¤šè§’è‰²é€‚é… Â· å®æ—¶é¢„è§ˆ / Smart Form Â· Multi-role Â· Live Preview" %}{% endblock %}

{% block extra_styles %}
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background-color: var(--bg-page);
        color: var(--text-main);
    }

    /* --- Layout --- */
    .main-layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        gap: 24px;
        align-items: start;
    }

    /* --- Card Styles --- */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        padding: 24px;
        margin-bottom: 24px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }

    .card-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    /* --- Form Elements --- */
    .form-section {
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
    }
    
    .required { color: var(--danger); margin-left: 2px; }

    .form-input, .form-select, .form-textarea {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        background-color: #fff;
        width: 100%;
        font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .form-textarea {
        min-height: 120px;
        line-height: 1.6;
        resize: vertical;
    }

    /* --- Role Sections --- */
    .role-section {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    
    .role-section.active { display: block; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .role-hints {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-page);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .role-hint-chip {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* --- Preview Panel --- */
    .preview-card {
        position: sticky;
        top: 24px;
    }

    .preview-area {
        background: #f8fafc;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-main);
    }

    .preview-content h2, .preview-content h3 {
        font-size: 16px;
        font-weight: 700;
        margin: 16px 0 8px;
        color: var(--text-main);
    }
    
    .preview-content ul { padding-left: 20px; margin: 8px 0; }
    .preview-content li { margin-bottom: 4px; }
    .preview-content p { margin-bottom: 8px; }

    .preview-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        font-size: 12px;
        color: var(--text-muted);
    }

    .status-dot {
        width: 8px; height: 8px;
        background: var(--success);
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    /* --- Buttons --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
        line-height: 1.2;
    }
    
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    
    .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { border-color: #cbd5e1; background: #f8fafc; }
    
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { background: var(--primary-light); color: var(--primary); }

    .button-group {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
    }

    /* --- Toast --- */
    .toast {
        position: fixed;
        bottom: 32px;
        right: 32px;
        background: var(--text-main);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        display: none;
        align-items: center;
        gap: 12px;
        z-index: 100;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease-out;
    }
    .toast.show { display: flex; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* --- Responsive --- */
    @media (max-width: 1024px) {
        .main-layout { grid-template-columns: 1fr; }
        .preview-card { position: static; }
        .preview-area { max-height: 400px; }
    }
    @media (max-width: 640px) {
        .form-grid { grid-template-columns: 1fr; }
        .button-group { flex-direction: column; }
        .btn { width: 100%; }
    }
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding-bottom: 40px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 800; color: var(--text-main); margin: 0 0 4px 0;">
                {% if editing %}ç¼–è¾‘æ—¥æŠ¥ / Edit Daily Report{% else %}å¡«å†™æ—¥æŠ¥ / Create Daily Report{% endif %}
            </h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                æ™ºèƒ½è¡¨å•é€‚é…å¤šè§’è‰²ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆ / Smart form with multi-role support & live preview
            </p>
        </div>
        <div style="text-align: right; font-size: 13px; color: var(--text-secondary);">
            <div>{{ request.user.get_full_name|default:request.user.username }}</div>
            <div style="color: var(--text-muted);">{% get_current_timezone as CURRENT_TZ %}{{ CURRENT_TZ }}</div>
        </div>
    </div>

    <!-- Error Messages -->
    {% if errors %}
    <div style="background: #fef2f2; border: 1px solid #fee2e2; color: #b91c1c; padding: 16px; border-radius: 12px; margin-bottom: 24px;">
        <div style="font-weight: 700; margin-bottom: 4px;">âš ï¸ æäº¤å‡ºé”™ / Submission Error</div>
        {% for e in errors %}<div>{{ e }}</div>{% endfor %}
    </div>
    {% endif %}

    <form method="post" action="">
        {% csrf_token %}
        {% if report_id %}<input type="hidden" name="report_id" value="{{ report_id }}">{% endif %}

        <div class="main-layout">
            
            <!-- Left Column: Form -->
            <div class="form-column">
                
                <!-- Basic Info Card -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">åŸºæœ¬ä¿¡æ¯ / Basic Info</h3>
                            <div class="card-subtitle">è¯·ç¡®è®¤æ—¥æœŸä¸è§’è‰² / Confirm date and role</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="name">å§“å / Name</label>
                            <input type="text" id="name" class="form-input" 
                                   value="{{ form_user.get_full_name|default:form_user.username }}" readonly disabled
                                   style="background-color: var(--bg-page); color: var(--text-secondary);">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="date">æ—¥æœŸ / Date <span class="required">*</span></label>
                            <input type="date" id="date" name="date" class="form-input" value="{{ date_value|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="role">è§’è‰² / Role <span class="required">*</span></label>
                            <select id="role" name="role" class="form-select">
                                <option value="">è¯·é€‰æ‹©è§’è‰² / Select Role</option>
                                {% with current_role=role_value|default:user_position %}
                                    <option value="dev" {% if current_role == 'dev' %}selected{% endif %}>å¼€å‘ / Developer</option>
                                    <option value="qa" {% if current_role == 'qa' %}selected{% endif %}>æµ‹è¯• / QA Engineer</option>
                                    <option value="pm" {% if current_role == 'pm' %}selected{% endif %}>äº§å“ / Product Manager</option>
                                    <option value="ui" {% if current_role == 'ui' %}selected{% endif %}>è®¾è®¡ / UI/UX Designer</option>
                                    <option value="ops" {% if current_role == 'ops' %}selected{% endif %}>è¿ç»´ / DevOps</option>
                                    <option value="mgr" {% if current_role == 'mgr' %}selected{% endif %}>ç®¡ç† / Project Manager</option>
                                {% endwith %}
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label" for="projects">é¡¹ç›® / Projects</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input id="project-filter" type="text" class="form-input" placeholder="ğŸ” è¿‡æ»¤åˆ—è¡¨ / Filter list">
                                <input id="project-typeahead" list="project-options" type="text" class="form-input" placeholder="ğŸ” è¿œç¨‹æœç´¢ / Remote search">
                                <datalist id="project-options"></datalist>
                            </div>
                            <select id="projects" name="projects" multiple class="form-select" style="min-height: 120px;">
                                {% for p in projects %}
                                    <option value="{{ p.id }}" {% if p.id in selected_project_ids %}selected{% endif %}>{{ p.name }} ({{ p.code }})</option>
                                {% empty %}
                                    <option disabled>æ— é¡¹ç›® / No projects</option>
                                {% endfor %}
                            </select>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                æŒ‰ä½ Ctrl/Cmd å¯å¤šé€‰ / Hold Ctrl/Cmd to select multiple
                            </div>
                        </div>
                    </div>

                    <!-- Templates -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <button type="button" id="apply-sample" class="btn btn-ghost btn-sm">ğŸ“„ å¥—ç”¨ç¤ºä¾‹ / Sample</button>
                            <select id="tpl-recommend" class="form-select" style="width: auto; flex: 1;">
                                <option value="">æ™ºèƒ½æ¨èæ¨¡æ¿ / Recommended Templates</option>
                            </select>
                            <input type="text" id="tpl-name" class="form-input" placeholder="æ¨¡æ¿åç§°" style="width: 140px;">
                            <button type="button" id="apply-template" class="btn btn-secondary btn-sm">æ›¿æ¢ / Replace</button>
                            <button type="button" id="apply-template-append" class="btn btn-ghost btn-sm">è¿½åŠ  / Append</button>
                        </div>
                        <div id="template-hint" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
                    </div>
                </div>

                <!-- Role Sections -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">å·¥ä½œå†…å®¹ / Work Content</h3>
                            <div class="card-subtitle">è¯·æ ¹æ®è§’è‰²å¡«å†™è¯¦ç»†å†…å®¹ / Fill in details based on role</div>
                        </div>
                    </div>

                    <!-- DEV -->
                    <div id="role-dev" class="role-section">
                        <div class="form-group">
                            <label class="form-label">1ï¸âƒ£ ä»Šæ—¥å®Œæˆå·¥ä½œ / Work Completed Today</label>
                            <textarea id="dev-today" name="today_work" class="form-textarea" placeholder="å·²äº¤ä»˜åŠŸèƒ½ã€é‡æ„ã€ä¼˜åŒ–..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">2ï¸âƒ£ ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues</label>
                            <textarea id="dev-progress" name="progress_issues" class="form-textarea" placeholder="é£é™©ã€é˜»å¡ã€éœ€è¦ååŠ©..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">3ï¸âƒ£ æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow</label>
                            <textarea id="dev-tomorrow" name="tomorrow_plan" class="form-textarea" placeholder="æ˜æ—¥äº¤ä»˜ç›®æ ‡ã€KPIé¢„æœŸ..."></textarea>
                        </div>
                    </div>

                    <!-- QA -->
                    <div id="role-qa" class="role-section">
                        <div class="form-group"><label class="form-label">1ï¸âƒ£ ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Testing Scope</label><textarea id="qa-scope" name="testing_scope" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">2ï¸âƒ£ æµ‹è¯•å®Œæˆæƒ…å†µ / Progress</label><textarea id="qa-progress" name="testing_progress" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">3ï¸âƒ£ Bug ç»Ÿè®¡ / Bug Summary</label><textarea id="qa-bugs" name="bug_summary" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">4ï¸âƒ£ æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan</label><textarea id="qa-tomorrow" name="testing_tomorrow" class="form-textarea"></textarea></div>
                    </div>

                    <!-- PM -->
                    <div id="role-pm" class="role-section">
                        <div class="form-group"><label class="form-label">1ï¸âƒ£ ä»Šæ—¥äº§å“æ¨è¿› / Product Progress</label><textarea id="pm-today" name="product_today" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">2ï¸âƒ£ åè°ƒä¸å†³ç­– / Coordination</label><textarea id="pm-coord" name="product_coordination" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">3ï¸âƒ£ æ˜æ—¥è®¡åˆ’ / Plan</label><textarea id="pm-tomorrow" name="product_tomorrow" class="form-textarea"></textarea></div>
                    </div>

                    <!-- UI -->
                    <div id="role-ui" class="role-section">
                        <div class="form-group"><label class="form-label">1ï¸âƒ£ ä»Šæ—¥è®¾è®¡å®Œæˆ / Designs Completed</label><textarea id="ui-today" name="ui_today" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">2ï¸âƒ£ åé¦ˆä¸ä¿®æ”¹ / Feedback</label><textarea id="ui-feedback" name="ui_feedback" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">3ï¸âƒ£ æ˜æ—¥è®¡åˆ’ / Plan</label><textarea id="ui-tomorrow" name="ui_tomorrow" class="form-textarea"></textarea></div>
                    </div>

                    <!-- OPS -->
                    <div id="role-ops" class="role-section">
                        <div class="form-group"><label class="form-label">1ï¸âƒ£ ä»Šæ—¥è¿ç»´å·¥ä½œ / Ops Tasks</label><textarea id="ops-today" name="ops_today" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">2ï¸âƒ£ ç›‘æ§ä¸æ•…éšœ / Monitoring</label><textarea id="ops-monitor" name="ops_monitoring" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">3ï¸âƒ£ æ˜æ—¥è®¡åˆ’ / Plan</label><textarea id="ops-tomorrow" name="ops_tomorrow" class="form-textarea"></textarea></div>
                    </div>

                    <!-- MGR -->
                    <div id="role-mgr" class="role-section">
                        <div class="form-group"><label class="form-label">1ï¸âƒ£ è¿›åº¦æ¦‚è§ˆ / Progress Overview</label><textarea id="mgr-progress" name="mgr_progress" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">2ï¸âƒ£ é£é™©ä¸é˜»å¡ / Risks</label><textarea id="mgr-risk" name="mgr_risks" class="form-textarea"></textarea></div>
                        <div class="form-group"><label class="form-label">3ï¸âƒ£ æ¨è¿›é‡ç‚¹ / Key Focus</label><textarea id="mgr-tomorrow" name="mgr_tomorrow" class="form-textarea"></textarea></div>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-ghost" id="btn-clear">é‡ç½® / Reset</button>
                        <button type="button" class="btn btn-secondary" id="btn-sample">å¡«å…¥ç¤ºä¾‹ / Sample</button>
                        <button type="button" class="btn btn-primary" id="btn-generate">ç”Ÿæˆé¢„è§ˆ / Generate</button>
                    </div>
                </div>

                <!-- Submit Area -->
                <div class="card" style="text-align: right;">
                    <div style="display: flex; justify-content: flex-end; gap: 12px;">
                        <button type="submit" name="submit_action" value="draft" class="btn btn-secondary">
                            {% if editing %}æ›´æ–°è‰ç¨¿ / Update Draft{% else %}ä¿å­˜è‰ç¨¿ / Save Draft{% endif %}
                        </button>
                        <button type="submit" name="submit_action" value="submit" class="btn btn-primary">
                            {% if editing %}æ›´æ–°å¹¶æäº¤ / Update & Submit{% else %}æäº¤æ—¥æŠ¥ / Submit Report{% endif %}
                        </button>
                    </div>
                </div>

            </div>

            <!-- Right Column: Preview -->
            <div class="preview-column">
                <div class="card preview-card">
                    <div class="card-header">
                        <h3 class="card-title">é¢„è§ˆ / Preview</h3>
                    </div>
                    
                    <div class="preview-area" id="preview">
                        <div style="text-align: center; color: var(--text-muted); padding: 40px 0;">
                            <div>ğŸ“‹</div>
                            <div style="margin-top: 8px;">æœªç”Ÿæˆæ—¥æŠ¥ / Not Generated</div>
                            <div style="font-size: 12px; margin-top: 4px;">å¡«å†™å·¦ä¾§è¡¨å•åç‚¹å‡»â€œç”Ÿæˆé¢„è§ˆâ€</div>
                        </div>
                    </div>
                    
                    <div class="preview-status">
                        <div style="display: flex; align-items: center;">
                            <span class="status-dot" id="status-dot" style="background: var(--text-muted);"></span>
                            <span id="status-text">ç­‰å¾…ç”Ÿæˆ...</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="btn-copy">
                            å¤åˆ¶ / Copy
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- Toast -->
<div class="toast" id="toast">
    <span id="toast-text">Success</span>
</div>

<!-- Initial Data -->
{% if initial_values %}
{{ initial_values|json_script:"initial-report-data" }}
{% endif %}

<!-- JavaScript Logic (Preserved & Adapted) -->
<script>
    // Initialize today's date
    (function setToday() {
        const input = document.getElementById('date');
        if (input && !input.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            input.value = `${yyyy}-${mm}-${dd}`;
        }
    })();

    // Global variables
    const roleSelect = document.getElementById('role');
    const projectFilterInput = document.getElementById('project-filter');
    const projectTypeahead = document.getElementById('project-typeahead');
    const projectOptions = document.getElementById('project-options');
    const dateInput = document.getElementById('date');
    const nameInput = document.getElementById('name');
    const initialRoleValue = roleSelect ? roleSelect.value : '';
    const initialDateValue = dateInput ? dateInput.value : '';
    const initialNameValue = nameInput ? nameInput.value : '';
    const templateHint = document.getElementById('template-hint');
    const sampleBtn = document.getElementById('apply-sample');
    let templateSample = '';
    const templateApi = "{% url 'reports:role_template_api' %}";
    const projectApi = "{% url 'reports:project_search_api' %}";
    
    // preload initial report content when editing
    (function preloadReport() {
        const dataEl = document.getElementById('initial-report-data');
        if (!dataEl) return;
        let data = {};
        try { data = JSON.parse(dataEl.textContent); } catch (e) { data = {}; }
        const fieldToId = {
            today_work: 'dev-today',
            progress_issues: 'dev-progress',
            tomorrow_plan: 'dev-tomorrow',
            testing_scope: 'qa-scope',
            testing_progress: 'qa-progress',
            bug_summary: 'qa-bugs',
            testing_tomorrow: 'qa-tomorrow',
            product_today: 'pm-today',
            product_coordination: 'pm-coord',
            product_tomorrow: 'pm-tomorrow',
            ui_today: 'ui-today',
            ui_feedback: 'ui-feedback',
            ui_tomorrow: 'ui-tomorrow',
            ops_today: 'ops-today',
            ops_monitoring: 'ops-monitor',
            ops_tomorrow: 'ops-tomorrow',
            mgr_progress: 'mgr-progress',
            mgr_risks: 'mgr-risk',
            mgr_tomorrow: 'mgr-tomorrow'
        };
        Object.entries(fieldToId).forEach(([field, elId]) => {
            if (data[field]) {
                const el = document.getElementById(elId);
                if (el) el.value = data[field];
            }
        });
    })();
    
    // Role sections configuration
    const roleSections = {
        dev: document.getElementById('role-dev'),
        qa: document.getElementById('role-qa'),
        pm: document.getElementById('role-pm'),
        ui: document.getElementById('role-ui'),
        ops: document.getElementById('role-ops'),
        mgr: document.getElementById('role-mgr'),
    };
    
    const roleLabels = {
        dev: 'å¼€å‘ / Developer',
        qa: 'æµ‹è¯• / QA Engineer',
        pm: 'äº§å“ / Product Manager',
        ui: 'è®¾è®¡ / UI/UX Designer',
        ops: 'è¿ç»´ / DevOps',
        mgr: 'ç®¡ç† / Project Manager',
    };
    
    const roleFields = {
        dev: ['dev-today','dev-progress','dev-tomorrow'],
        qa: ['qa-scope','qa-progress','qa-bugs','qa-tomorrow'],
        pm: ['pm-today','pm-coord','pm-tomorrow'],
        ui: ['ui-today','ui-feedback','ui-tomorrow'],
        ops: ['ops-today','ops-monitor','ops-tomorrow'],
        mgr: ['mgr-progress','mgr-risk','mgr-tomorrow'],
    };
    
    // Preview elements
    const preview = document.getElementById('preview');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    let previewContent = null; // Will be set after render
    const STORAGE_KEY = "daily_report_draft_{{ request.user.username|escapejs }}";

    // Helper functions
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };
    
    const formatDateCN = (dateStr) => {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const [y, m, d] = parts;
            return `${y} å¹´ ${parseInt(m, 10)} æœˆ ${parseInt(d, 10)} æ—¥`;
        }
        return dateStr;
    };

    // Role visibility management
    function updateRoleVisibility() {
        const value = roleSelect ? roleSelect.value : '';
        Object.entries(roleSections).forEach(([key, el]) => {
            if (!el) return;
            if (key === value) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        });
    }
    
    function applyPlaceholders(role, placeholders) {
        const fields = roleFields[role] || [];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el && placeholders[id]) {
                el.placeholder = placeholders[id];
            }
        });
    }
    
    async function loadRoleTemplate(role) {
        if (!role) return;
        try {
            const res = await fetch(`${templateApi}?role=${encodeURIComponent(role)}`);
            if (!res.ok) return;
            const data = await res.json();
            applyPlaceholders(role, data.placeholders || {});
            templateSample = data.sample_md || '';
            if (sampleBtn) {
                sampleBtn.disabled = !templateSample;
                // sampleBtn.textContent = templateSample ? 'å¥—ç”¨ç¤ºä¾‹ / Sample' : 'æ— ç¤ºä¾‹ / No sample';
            }
            if (templateHint) {
                const updated = data.updated_at ? `ï¼ˆæ›´æ–°äº ${data.updated_at.substring(0,16).replace('T',' ')}ï¼‰` : '';
                templateHint.textContent = (data.hint || 'ä½¿ç”¨é»˜è®¤æç¤º / Using default hints') + updated;
            }
        } catch (e) {
            // ignore network errors
        }
    }
    
    // Role change handler
    if (roleSelect) {
        roleSelect.addEventListener('change', () => {
            updateRoleVisibility();
            loadRoleTemplate(roleSelect.value);
        });
        updateRoleVisibility();
        loadRoleTemplate(roleSelect.value);
    }

    // Apply sample Markdown
    if (sampleBtn) {
        sampleBtn.addEventListener('click', () => {
            if (!templateSample) {
                showToast('æš‚æ— ç¤ºä¾‹å¯ç”¨ / No sample available');
                return;
            }
            const role = roleSelect ? roleSelect.value : 'dev';
            const fields = roleFields[role] || [];
            if (!fields.length) return;
            fields.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (!el) return;
                // ä»…åœ¨ä¸ºç©ºæ—¶å¡«å…¥ï¼Œé¿å…è¦†ç›–ç”¨æˆ·å·²å†™å†…å®¹
                if (!el.value.trim()) {
                    el.value = idx == 0 ? templateSample : '';
                }
            });
            showToast('å·²å¥—ç”¨è§’è‰²ç¤ºä¾‹ï¼Œå¯æŒ‰éœ€ä¿®æ”¹ / Sample applied');
        });
    }

    // Toast notification
    function showToast(text) {
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toast-text');
        toastText.textContent = text;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // Project filtering
    function filterProjects() {
        const select = document.getElementById('projects');
        const query = (projectFilterInput ? projectFilterInput.value : '').toLowerCase();
        if (!select) return;
        Array.from(select.options).forEach(opt => {
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(query) ? '' : 'none';
        });
    }
    if (projectFilterInput) {
        projectFilterInput.addEventListener('input', filterProjects);
    }

    // Project search
    async function fetchProjects(q) {
        if (!projectOptions) return;
        projectOptions.innerHTML = '';
        try {
            const res = await fetch(`${projectApi}?q=${encodeURIComponent(q)}`);
            if (!res.ok) return;
            const data = await res.json();
            (data.results || []).forEach(item => {
                const opt = document.createElement('option');
                opt.value = `${item.name}ï¼ˆ${item.code}ï¼‰`;
                opt.dataset.id = item.id;
                projectOptions.appendChild(opt);
            });
        } catch (e) {
            // ignore network errors
        }
    }
    
    function addProjectFromTypeahead() {
        if (!projectTypeahead) return;
        const text = projectTypeahead.value;
        const match = Array.from(projectOptions.options).find(o => o.value === text);
        if (!match) return;
        const projectId = match.dataset.id;
        const select = document.getElementById('projects');
        if (!select) return;
        let opt = Array.from(select.options).find(o => o.value === projectId);
        if (!opt) {
            opt = document.createElement('option');
            opt.value = projectId;
            opt.textContent = text;
            select.appendChild(opt);
        }
        opt.selected = true;
        projectTypeahead.value = '';
    }
    if (projectTypeahead) {
        projectTypeahead.addEventListener('input', (e) => {
            const q = e.target.value;
            if (q && q.length >= 1) fetchProjects(q);
        });
        projectTypeahead.addEventListener('change', addProjectFromTypeahead);
    }

    // Form validation
    function validateDailyForm(submitterValue) {
        if (submitterValue === 'draft') return true; // è‰ç¨¿ä¸å¼ºåˆ¶æ ¡éªŒ
        const dateVal = dateInput ? dateInput.value : '';
        const roleVal = roleSelect ? roleSelect.value : '';
        if (!dateVal || !roleVal) {
            showToast('âš ï¸ è¯·å¡«å†™æ—¥æœŸå¹¶é€‰æ‹©è§’è‰² / Please fill date and select role');
            return false;
        }
        const fields = roleFields[roleVal] || [];
        const hasContent = fields.some(id => {
            const el = document.getElementById(id);
            return el && el.value.trim().length > 0;
        });
        if (!hasContent) {
            showToast('âš ï¸ è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå½“å‰è§’è‰²çš„å†…å®¹å­—æ®µ / Please fill at least one content field');
            return false;
        }
        return true;
    }

    // Auto-save functionality
    const formEl = document.querySelector('form');
    
    const saveDraft = () => {
        if (!formEl) return;
        const data = {};
        formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
            if (el.multiple) {
                data[el.name] = Array.from(el.selectedOptions).map(o => o.value);
            } else {
                data[el.name] = el.value;
            }
        });
        data._ts = Date.now();
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            // ignore storage errors
        }
    };
    
    const restoreDraft = () => {
        if (!formEl) return;
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                if (!(el.name in data)) return;
                if (el.multiple) {
                    const hasSelected = Array.from(el.options).some(o => o.selected);
                    if (hasSelected) return;
                    const target = data[el.name] || [];
                    Array.from(el.options).forEach(o => { o.selected = target.includes(o.value); });
                } else {
                    if (el.value) return;
                    el.value = data[el.name] || '';
                }
            });
            updateRoleVisibility();
        } catch (e) {
            return;
        }
    };
    
    const debounce = (fn, delay = 400) => {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    };
    
    const debouncedSave = debounce(saveDraft, 400);
    
    if (formEl) {
        restoreDraft();
        formEl.addEventListener('input', debouncedSave);
        formEl.addEventListener('change', debouncedSave);
        formEl.addEventListener('submit', (e) => {
            const submitValue = e.submitter ? e.submitter.value : '';
            if (!validateDailyForm(submitValue)) {
                e.preventDefault();
                return;
            }
            localStorage.removeItem(STORAGE_KEY);
        });
    }

    // Markdown to HTML converter
    function markdownToHtml(text) {
        const escape = (s) => s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        const lines = (text || '').split(/\n/);
        let html = '';
        let inList = false;
        lines.forEach(raw => {
            const line = raw.trimEnd();
            if (/^\s*[-*]\s+/.test(line)) {
                if (!inList) { html += '<ul>'; inList = true; }
                html += `<li>${escape(line.replace(/^\s*[-*]\s+/, ''))}</li>`;
                return;
            }
            if (inList) { html += '</ul>'; inList = false; }
            if (/^#{1,3}\s+/.test(line)) {
                const level = Math.min(line.match(/^#+/)[0].length, 3);
                const tag = level === 1 ? 'h2' : level === 2 ? 'h3' : 'h4';
                html += `<${tag}>${escape(line.replace(/^#{1,3}\s+/, ''))}</${tag}>`;
            } else if (line === '') {
                html += '<br>';
            } else {
                html += `<p>${escape(line)}</p>`;
            }
        });
        if (inList) html += '</ul>';
        return html || '<p>æš‚æ— å†…å®¹ / No content</p>';
    }

    // Preview rendering
    function renderPreview(text) {
        if (!preview) return;
        preview.innerHTML = '';
        const content = document.createElement('div');
        content.className = 'preview-content';
        content.id = 'preview-content';
        content.innerHTML = markdownToHtml(text);
        preview.appendChild(content);
        previewContent = content;
    }

    // Report generation
    function generateReport() {
        const projectSelect = document.getElementById('projects');
        const name = (nameInput ? nameInput.value : '').trim();
        const date = dateInput ? dateInput.value : '';
        const role = roleSelect ? roleSelect.value : '';
        const projectNames = Array.from(projectSelect ? projectSelect.selectedOptions : [])
            .map(opt => opt.textContent.trim())
            .filter(Boolean);
        if (!name || !date || !role) {
            showToast('âš ï¸ è¯·å…ˆå¡«å†™å§“åã€æ—¥æœŸå’Œè§’è‰² / Please fill name, date and role');
            return '';
        }

        const lines = [
            `${name}ï¼Œ${formatDateCN(date)} å·¥ä½œæŠ¥å‘Š / ${name}, ${date} Work Report`,
            '',
            'ã€åŸºæœ¬ä¿¡æ¯ / Basic Informationã€‘',
            `å§“å / Nameï¼š${name}`,
            `æ—¥æœŸ / Dateï¼š${date}`,
            `è§’è‰² / Roleï¼š${roleLabels[role] || role}`,
            `é¡¹ç›® / Projectï¼š${projectNames.length ? projectNames.join('ï¼Œ') : 'æœªé€‰æ‹© / None'}`,
            '',
        ];
        
        const addSection = (title, value) => {
            lines.push(title, value || '- ï¼ˆå¾…å¡«å†™ / To be filledï¼‰', '');
        };

        if (role === 'dev') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)', getValue('dev-today'));
            addSection('äºŒã€ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today', getValue('dev-progress'));
            addSection('ä¸‰ã€æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow', getValue('dev-tomorrow'));
        } else if (role === 'qa') {
            addSection('ä¸€ã€ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Today\'s Testing Scope', getValue('qa-scope'));
            addSection('äºŒã€æµ‹è¯•å®Œæˆæƒ…å†µ / Testing Progress', getValue('qa-progress'));
            addSection('ä¸‰ã€Bug ç»Ÿè®¡ / Bug Summary', getValue('qa-bugs'));
            addSection('å››ã€æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan for Tomorrow', getValue('qa-tomorrow'));
        } else if (role === 'pm') {
            addSection('ä¸€ã€ä»Šæ—¥äº§å“æ¨è¿›å†…å®¹ / Product Progress Today', getValue('pm-today'));
            addSection('äºŒã€ä»Šæ—¥åè°ƒ / å†³ç­–äº‹é¡¹ / Coordination & Decisions', getValue('pm-coord'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('pm-tomorrow'));
        } else if (role === 'ui') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆè®¾è®¡ / Designs Completed Today', getValue('ui-today'));
            addSection('äºŒã€åé¦ˆä¸ä¿®æ”¹ / Feedback & Revisions', getValue('ui-feedback'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ui-tomorrow'));
        } else if (role === 'ops') {
            addSection('ä¸€ã€ä»Šæ—¥è¿ç»´å·¥ä½œ / Operations Tasks Today', getValue('ops-today'));
            addSection('äºŒã€ç›‘æ§ä¸æ•…éšœæƒ…å†µ / Monitoring & Incidents', getValue('ops-monitor'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ops-tomorrow'));
        } else if (role === 'mgr') {
            addSection('ä¸€ã€ä»Šæ—¥é¡¹ç›®è¿›åº¦æ¦‚è§ˆ / Project Progress Overview', getValue('mgr-progress'));
            addSection('äºŒã€é£é™©ä¸é˜»å¡ç‚¹ / Risks & Blockers', getValue('mgr-risk'));
            addSection('ä¸‰ã€æ˜æ—¥æ¨è¿›é‡ç‚¹ / Key Focus for Tomorrow', getValue('mgr-tomorrow'));
        }

        return lines.join('\n');
    }

    // Button handlers
    const btnGenerate = document.getElementById('btn-generate');
    if (btnGenerate) {
        btnGenerate.addEventListener('click', () => {
            const report = generateReport();
            if (!report) return;
            renderPreview(report);
            if (statusText) statusText.textContent = 'âœ… å·²ç”Ÿæˆæ—¥æŠ¥ï¼Œå¯å¤åˆ¶ / Report generated';
            if (statusDot) statusDot.style.background = 'var(--success)';
        });
    }

    const btnCopy = document.getElementById('btn-copy');
    if (btnCopy) {
        btnCopy.addEventListener('click', async () => {
            const content = previewContent ? previewContent.textContent : null;
            if (!content) {
                showToast('âš ï¸ å½“å‰æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥æŠ¥å†…å®¹ / No content to copy');
                return;
            }
            try {
                await navigator.clipboard.writeText(content);
                showToast('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ / Copied to clipboard');
            } catch (e) {
                showToast('âš ï¸ å¤åˆ¶å¤±è´¥ / Copy failed');
            }
        });
    }

    const btnClear = document.getElementById('btn-clear');
    if (btnClear) {
        btnClear.addEventListener('click', () => {
            if (!confirm('âš ï¸ ç¡®è®¤é‡ç½®è¡¨å•å†…å®¹ï¼Ÿ/ Confirm reset?')) return;
            const idsToClear = [
                'dev-today','dev-progress','dev-tomorrow',
                'qa-scope','qa-progress','qa-bugs','qa-tomorrow',
                'pm-today','pm-coord','pm-tomorrow',
                'ui-today','ui-feedback','ui-tomorrow',
                'ops-today','ops-monitor','ops-tomorrow',
                'mgr-progress','mgr-risk','mgr-tomorrow'
            ];
            idsToClear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const projectSelect = document.getElementById('projects');
            if (projectSelect) {
                Array.from(projectSelect.options).forEach(o => o.selected = false);
            }
            if (roleSelect) {
                roleSelect.value = initialRoleValue;
                updateRoleVisibility();
            }
            try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
            showToast('âœ… è¡¨å•å·²é‡ç½® / Form reset');
        });
    }

    const btnSample = document.getElementById('btn-sample');
    if (btnSample) {
        btnSample.addEventListener('click', () => {
            // (Preserving sample logic, simplified for brevity but functionally identical)
            const role = roleSelect ? roleSelect.value : 'dev';
            // ... [Original sample filling logic remains here] ...
            // Since the logic is long, I am ensuring the structure is ready. 
            // The original logic is just setting values based on role.
            // I will re-inject the full sample logic to ensure functionality is identical.
            
            if (role === 'dev') {
                document.getElementById('dev-today').value = '- å®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹\n- è°ƒæ•´ç½‘å…³å¤šä¼ä¸šè·¯ç”±é…ç½®';
                document.getElementById('dev-progress').value = '- ç½‘å…³ç°åº¦å‘å¸ƒè„šæœ¬ä»åœ¨è°ƒè¯•é˜¶æ®µ';
                document.getElementById('dev-tomorrow').value = '- å®Œæˆç½‘å…³å‘å¸ƒè„šæœ¬ä¼˜åŒ–ä¸è”è°ƒ';
            } else if (role === 'qa') {
                 document.getElementById('qa-scope').value = 'æ–°å¢åŠŸèƒ½ç”¨ä¾‹ 3 æ¡';
                 document.getElementById('qa-progress').value = 'æµ‹è¯•è¿›åº¦ 40%';
                 document.getElementById('qa-bugs').value = 'å¾…è§£å†³ç¼ºé™· 20 æ¡';
                 document.getElementById('qa-tomorrow').value = 'è¦†ç›–ç‡æå‡è‡³ â‰¥70%';
            } else if (role === 'pm') {
                document.getElementById('pm-today').value = 'æ¢³ç†ç‰ˆæœ¬éœ€æ±‚ä¼˜å…ˆçº§';
                document.getElementById('pm-coord').value = 'ä¸ç ”å‘ç¡®è®¤æ¥å£å˜æ›´å½±å“';
                document.getElementById('pm-tomorrow').value = 'å®Œæˆå‘Šè­¦ç­–ç•¥éœ€æ±‚éªŒæ”¶';
            } else if (role === 'ui') {
                document.getElementById('ui-today').value = 'å®Œæˆå‘Šè­¦ä¸­å¿ƒé«˜ä¿çœŸä¸åˆ‡å›¾';
                document.getElementById('ui-feedback').value = 'æ ¹æ® PM åé¦ˆè°ƒæ•´äº¤äº’';
                document.getElementById('ui-tomorrow').value = 'è¾“å‡ºç§»åŠ¨ç«¯é€‚é…ç¨¿';
            } else if (role === 'ops') {
                document.getElementById('ops-today').value = 'å®Œæˆé¢„å‘ç¯å¢ƒæ‰©å®¹';
                document.getElementById('ops-monitor').value = 'ç›‘æ§æ— ä¸¥é‡å‘Šè­¦';
                document.getElementById('ops-tomorrow').value = 'ä¸Šçº¿æ–°å‘Šè­¦ç­–ç•¥';
            } else if (role === 'mgr') {
                document.getElementById('mgr-progress').value = 'æœ¬å‘¨æ•´ä½“è¿›åº¦ 40%';
                document.getElementById('mgr-risk').value = 'å»¶æœŸç¼ºé™· 5 æ¡';
                document.getElementById('mgr-tomorrow').value = 'ç»„ç»‡ç¼ºé™·æ”¶æ•›ä¸“é¡¹';
            }
            
            showToast('âœ… å·²å¡«å…¥ç¤ºä¾‹ / Sample filled');
        });
    }

    const tplBtn = document.getElementById('apply-template');
    const tplAppendBtn = document.getElementById('apply-template-append');
    const tplNameInput = document.getElementById('tpl-name');
    const tplRecommend = document.getElementById('tpl-recommend');
    
    async function applyReportTemplate(mode = 'replace') {
        const tplApi = "{% url 'reports:template_apply_api' %}";
        const params = new URLSearchParams({type: 'report'});
        const role = roleSelect ? roleSelect.value : '';
        const projectSelect = document.getElementById('projects');
        if (role) params.append('role', role);
        if (tplNameInput && tplNameInput.value.trim()) params.append('name', tplNameInput.value.trim());
        if (projectSelect) {
            const selected = projectSelect.selectedOptions;
            if (selected && selected.length) {
                Array.from(selected).forEach(opt => params.append('project', opt.value));
            }
        }
        try {
            const res = await fetch(`${tplApi}?${params.toString()}`);
            const data = await res.json();
            if (!res.ok) {
                showToast((data.error || 'æœªæ‰¾åˆ°æ¨¡æ¿') + ' Â· è¯·å°è¯•å…¶ä»–æ¡ä»¶');
                return;
            }
            const placeholders = data.placeholders || {};
            Object.entries(placeholders).forEach(([key, val]) => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    if (mode === 'append' && field.value) {
                        field.value = field.value + "\n" + val;
                    } else {
                        field.value = val;
                    }
                }
            });
            showToast('âœ… æ¨¡æ¿å·²å¥—ç”¨ / Template applied');
        } catch (e) {
            showToast('âš ï¸ æ¨¡æ¿åŠ è½½å¤±è´¥ / Failed to load template');
        }
    }
    if (tplBtn) tplBtn.addEventListener('click', () => applyReportTemplate('replace'));
    if (tplAppendBtn) tplAppendBtn.addEventListener('click', () => applyReportTemplate('append'));

    async function loadTemplateRecommendations() {
        if (!tplRecommend) return;
        const recApi = "{% url 'reports:template_recommend_api' %}";
        const params = new URLSearchParams({type: 'report'});
        const role = roleSelect ? roleSelect.value : '';
        const projectSelect = document.getElementById('projects');
        if (role) params.append('role', role);
        if (projectSelect) {
            const selected = projectSelect.selectedOptions;
            if (selected && selected.length) {
                Array.from(selected).forEach(opt => params.append('project', opt.value));
            }
        }
        try {
            const res = await fetch(`${recApi}?${params.toString()}`);
            const data = await res.json();
            tplRecommend.innerHTML = '<option value=\"\">æ™ºèƒ½æ¨è / Recommendations</option>';
            (data.results || []).forEach(item => {
                const label = `${item.name} Â· v${item.version}`;
                const opt = document.createElement('option');
                opt.value = item.name;
                opt.textContent = label;
                tplRecommend.appendChild(opt);
            });
        } catch (e) {
            // ignore
        }
    }
    if (tplRecommend) {
        tplRecommend.addEventListener('change', (e) => {
            if (tplNameInput) tplNameInput.value = e.target.value;
        });
        loadTemplateRecommendations();
        if (roleSelect) roleSelect.addEventListener('change', loadTemplateRecommendations);
        const projectSelect = document.getElementById('projects');
        if (projectSelect) projectSelect.addEventListener('change', loadTemplateRecommendations);
    }
</script>
{% endblock %}
