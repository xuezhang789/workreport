{% extends "base_topbar.html" %}
{% load tz %}
{% block title %}å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥ / Team Daily Report{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥ / Daily Report" nav_subtitle="æ™ºèƒ½è¡¨å• Â· å¤šè§’è‰²é€‚é… Â· å®æ—¶é¢„è§ˆ / Smart Form Â· Multi-role Â· Live Preview" %}{% endblock %}
{% block extra_styles %}
        :root {
            --primary: #2563eb;
            --primary-2: #3b82f6;
            --primary-3: #60a5fa;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #8b5cf6;
            --bg-card: rgba(255, 255, 255, 0.98);
            --bg-section: rgba(248, 250, 252, 0.9);
            --bg-input: rgba(248, 250, 252, 0.8);
            --border-light: rgba(226, 232, 240, 0.8);
            --border-medium: rgba(203, 213, 225, 0.6);
            --border-hover: rgba(59, 130, 246, 0.3);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 8px 24px rgba(15, 23, 42, 0.1);
            --shadow-lg: 0 16px 40px rgba(15, 23, 42, 0.15);
            --shadow-xl: 0 24px 60px rgba(15, 23, 42, 0.2);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #f0f9ff 50%, #fef3c7 75%, #f0fdf4 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 1;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(24px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 40px 48px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
            animation: heroFloat 6s ease-in-out infinite;
        }

        @keyframes heroFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent), var(--success));
            opacity: 0.9;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .hero::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hero-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 48px;
            position: relative;
            z-index: 1;
        }

        .hero-main {
            flex: 1;
        }

        .hero-eyebrow {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-eyebrow::before {
            content: '';
            width: 24px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 1px;
        }

        .hero-title {
            font-size: clamp(28px, 4vw, 36px);
            font-weight: 800;
            line-height: 1.2;
            margin: 0 0 16px 0;
            background: linear-gradient(135deg, var(--text-primary), #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            line-height: 1.6;
            margin: 0;
            font-weight: 500;
        }

        .hero-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(6, 182, 212, 0.08));
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
            transition: var(--transition);
            white-space: nowrap;
        }

        .meta-chip:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.25);
        }

        .meta-chip .icon {
            font-size: 16px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.7fr);
            gap: 32px;
            align-items: start;
        }

        /* Card Component */
        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 32px 36px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 0.8;
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 28px;
            position: relative;
            z-index: 1;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.2);
            transition: var(--transition);
        }

        .card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 28px rgba(59, 130, 246, 0.3);
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
            margin: 8px 0 0 0;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-hint {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
            background: rgba(59, 130, 246, 0.08);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px dashed rgba(59, 130, 246, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-field.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .required {
            color: var(--danger);
            font-weight: 800;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 16px;
            pointer-events: none;
            transition: color 0.3s ease;
            z-index: 1;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            outline: none;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        input.with-icon, select.with-icon {
            padding-left: 48px;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-light);
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        input:focus::placeholder, textarea:focus::placeholder {
            opacity: 0.4;
        }

        select {
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, var(--text-muted) 50%), 
                              linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
            background-position: calc(100% - 16px) 50%, calc(100% - 10px) 50%;
            background-size: 6px 6px;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 8px 24px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        input:focus + .input-icon, select:focus + .input-icon {
            color: var(--primary);
        }

        /* Role Hints */
        .role-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .role-hint-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.08));
            border: 1px dashed rgba(139, 92, 246, 0.2);
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Role Sections */
        .role-section {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .role-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .role-section .form-section {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.6), rgba(241, 245, 249, 0.4));
            border-radius: var(--radius-md);
            padding: 24px;
            border: 1px solid var(--border-light);
            margin-bottom: 20px;
        }

        .role-section .section-header {
            border-bottom-color: rgba(59, 130, 246, 0.2);
        }

        /* Buttons */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid var(--border-light);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            min-width: 120px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            filter: brightness(1.05);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            color: white;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #374151;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .btn-ghost {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(6, 182, 212, 0.08));
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }

        .btn-ghost:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            border-color: rgba(59, 130, 246, 0.25);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15);
        }

        /* Preview Section */
        .preview-card {
            position: sticky;
            top: 100px;
        }

        .preview-area {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            border-radius: var(--radius-md);
            padding: 28px 32px;
            max-height: 700px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: inset 0 2px 8px rgba(59, 130, 246, 0.05), var(--shadow-md);
            position: relative;
        }

        .preview-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
            opacity: 0.8;
        }

        .preview-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
            margin-bottom: 20px;
        }

        .preview-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .preview-content h2, .preview-content h3, .preview-content h4 {
            margin: 16px 0 12px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .preview-content p {
            margin: 12px 0;
        }

        .preview-content ul {
            padding-left: 24px;
            margin: 12px 0;
        }

        .preview-content li {
            margin: 8px 0;
        }

        .preview-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Error Messages */
        .error-container {
            margin-bottom: 24px;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.06));
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #991b1b;
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
            backdrop-filter: blur(16px);
            color: #e5e7eb;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 100;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(59, 130, 246, 0.2);
            animation: slideInUp 0.4s ease-out;
            max-width: 400px;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.show {
            display: inline-flex;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }
            
            .main-layout {
                grid-template-columns: minmax(0, 1fr);
                gap: 24px;
            }
            
            .preview-card {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .hero {
                padding: 32px 24px;
            }
            
            .hero-content {
                flex-direction: column;
                gap: 24px;
                text-align: center;
            }
            
            .hero-meta {
                align-items: center;
                width: 100%;
            }
            
            .form-grid {
                grid-template-columns: minmax(0, 1fr);
            }
            
            .card {
                padding: 24px 20px;
            }
            
            .button-group {
                justify-content: stretch;
            }
            
            .button-group .btn {
                flex: 1 1 45%;
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .hero {
                padding: 24px 16px;
            }
            
            .card {
                padding: 20px 16px;
            }
            
            .button-group .btn {
                flex: 1 1 100%;
            }
            
            .toast {
                bottom: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-contrast: high) {
            .card {
                border-width: 2px;
            }
            
            input, select, textarea {
                border-width: 2px;
            }
            
            .btn {
                border: 2px solid currentColor;
            }
        }
{% endblock %}

{% block content %}
    <div class="container">
        {% if errors %}
        <div class="error-container">
            <div class="error-message">
                <span>âš ï¸</span>
                <div>
                    {% for e in errors %}
                        <div>{{ e }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Hero Section -->
        <header class="hero">
            <div class="hero-content">
                <div class="hero-main">
                    <p class="hero-eyebrow">
                        <span>Daily Cadence</span>
                        <span>Â·</span>
                        <span>æ™ºèƒ½åä½œ</span>
                    </p>
                    <h1 class="hero-title">
                        {% if editing %}ç¼–è¾‘æ—¥æŠ¥ / Edit Daily Report{% else %}å¡«å†™æ—¥æŠ¥ / Create Daily Report{% endif %}
                    </h1>
                    <p class="hero-subtitle">
                        ğŸ’¡ æ™ºèƒ½è¡¨å•é€‚é…å¤šè§’è‰²ï¼Œå·¦ä¾§å¡«å†™å®æ—¶é¢„è§ˆï¼Œä¸€é”®ç”Ÿæˆä¸“ä¸šæ—¥æŠ¥ / Smart form adapts to multi-roles, real-time preview, one-click professional report
                    </p>
                </div>
                <div class="hero-meta">
                    <div class="meta-chip">
                        <span class="icon">ğŸ‘¤</span>
                        <span>{{ request.user.get_full_name|default:request.user.username }}</span>
                    </div>
                    <div class="meta-chip">
                        <span class="icon">ğŸŒ</span>
                        <span>{% get_current_timezone as CURRENT_TZ %}{{ CURRENT_TZ }}</span>
                    </div>
                    <div class="meta-chip">
                        <span class="icon">ğŸ’¡</span>
                        <span>å»ºè®®ï¼šæ¯é¡¹ 3-8 æ¡è¦ç‚¹ / Tip: 3-8 items per section</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Form -->
        <form method="post" action="">
            {% csrf_token %}
            {% if report_id %}<input type="hidden" name="report_id" value="{{ report_id }}">{% endif %}
            
            <div class="main-layout">
                <!-- Form Panel -->
                <section class="card form-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <div class="card-icon">âœï¸</div>
                                æ—¥æŠ¥è¡¨å• / Daily Report Form
                            </h2>
                            <p class="card-subtitle">
                                ğŸ¯ æ ¹æ®è§’è‰²æ™ºèƒ½å±•ç¤ºç›¸åº”å­—æ®µï¼Œæ”¯æŒå®æ—¶ä¿å­˜å’Œé¢„è§ˆ / Smart fields by role with auto-save & preview
                            </p>
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <span>ğŸ“‹</span>
                                åŸºæœ¬ä¿¡æ¯ä¸è§’è‰²é€‰æ‹© / Basic Info & Role Selection
                            </h3>
                            <span class="section-hint">å§“åã€æ—¥æœŸã€è§’è‰²ä¸ºå¿…å¡«é¡¹ / Name, date, role required</span>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="name">
                                    <span>ğŸ‘¤</span>
                                    å§“å / Name <span class="required">*</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="text" id="name" class="with-icon"
                                           value="{{ form_user.get_full_name|default:form_user.username }}" readonly disabled
                                           title="å§“åå–ç™»å½•ç”¨æˆ·ï¼Œå¦‚éœ€ä¿®æ”¹è¯·åœ¨è´¦æˆ·ä¿¡æ¯ä¸­æ›´æ–° / Name from login user, update in profile if needed" />
                                    <span class="input-icon">ğŸ‘¤</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="date">
                                    <span>ğŸ“…</span>
                                    æ—¥æœŸ / Date <span class="required">*</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="date" id="date" name="date" class="with-icon" value="{{ date_value|default:'' }}" />
                                    <span class="input-icon">ğŸ“…</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="role">
                                    <span>ğŸ­</span>
                                    è§’è‰² / Role <span class="required">*</span>
                                </label>
                                <div class="input-wrapper">
                                    <select id="role" name="role" class="with-icon">
                                        <option value="">è¯·é€‰æ‹©è§’è‰² / Select Role</option>
                                        {% with current_role=role_value|default:user_position %}
                                            <option value="dev" {% if current_role == 'dev' %}selected{% endif %}>å¼€å‘ / Developer</option>
                                            <option value="qa" {% if current_role == 'qa' %}selected{% endif %}>æµ‹è¯• / QA Engineer</option>
                                            <option value="pm" {% if current_role == 'pm' %}selected{% endif %}>äº§å“ / Product Manager</option>
                                            <option value="ui" {% if current_role == 'ui' %}selected{% endif %}>è®¾è®¡ / UI/UX Designer</option>
                                            <option value="ops" {% if current_role == 'ops' %}selected{% endif %}>è¿ç»´ / DevOps</option>
                                            <option value="mgr" {% if current_role == 'mgr' %}selected{% endif %}>ç®¡ç† / Project Manager</option>
                                        {% endwith %}
                                    </select>
                                    <span class="input-icon">ğŸ­</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="projects">
                                    <span>ğŸš€</span>
                                    é¡¹ç›®ï¼ˆå¯å¤šé€‰ï¼‰ / Projects (Multi-select)
                                </label>
                                <input id="project-filter" type="text" placeholder="ğŸ” æœ¬åœ°è¿‡æ»¤å½“å‰åˆ—è¡¨ / Filter current list" 
                                       style="margin-bottom:8px;width:100%;padding:12px 16px;border-radius:var(--radius-sm);border:1px solid var(--border-light);">
                                <input id="project-typeahead" list="project-options" type="text" placeholder="ğŸ” è¿œç¨‹æœç´¢é¡¹ç›®å¹¶åŠ å…¥åˆ—è¡¨ / Search & add projects" 
                                       style="margin-bottom:8px;width:100%;padding:12px 16px;border-radius:var(--radius-sm);border:1px solid var(--border-light);">
                                <datalist id="project-options"></datalist>
                                <select id="projects" name="projects" multiple size="4" style="min-height:120px;">
                                    {% for p in projects %}
                                        <option value="{{ p.id }}" {% if p.id in selected_project_ids %}selected{% endif %}>{{ p.name }}ï¼ˆ{{ p.code }}ï¼‰</option>
                                    {% empty %}
                                        <option disabled>æš‚æ— é¡¹ç›®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ›å»º / No projects, contact admin</option>
                                    {% endfor %}
                                </select>
                                <div style="font-size:12px;color:var(--text-muted);margin-top:6px;">
                                    ğŸ’¡ è¿œç¨‹æœç´¢è¾“å…¥åé€‰æ‹©å»ºè®®ï¼Œè‡ªåŠ¨åŠ å…¥åˆ—è¡¨ï¼›æŒ‰ä½ Ctrl/âŒ˜ å¯å¤šé€‰ / Search suggestions auto-add to list; hold Ctrl/âŒ˜ for multi-select
                                </div>
                            </div>
                        </div>

                        <div class="role-hints">
                            <div class="role-hint-chip">
                                <span>ğŸ’»</span>
                                <span>å¼€å‘ï¼šä»Šæ—¥å®Œæˆã€è¿›åº¦é—®é¢˜ã€æ˜æ—¥è®¡åˆ’ / Dev: Completed, Progress, Tomorrow</span>
                            </div>
                            <div class="role-hint-chip">
                                <span>ğŸ§ª</span>
                                <span>æµ‹è¯•ï¼šæµ‹è¯•èŒƒå›´ã€è¿›åº¦ã€Bugç»Ÿè®¡ã€æ˜æ—¥è®¡åˆ’ / QA: Scope, Progress, Bugs, Tomorrow</span>
                            </div>
                            <div class="role-hint-chip">
                                <span>âš™ï¸</span>
                                <span>è¿ç»´ï¼šç›‘æ§ã€æ•…éšœå¤„ç†ã€å˜æ›´è®°å½• / Ops: Monitoring, Incidents, Changes</span>
                            </div>
                        </div>
                        
                        <div id="template-hint" style="font-size:12px;color:var(--text-muted);margin-top:12px;padding:8px 12px;background:rgba(59,130,246,0.05);border-radius:8px;">
                            ğŸ’¡ å¯åœ¨"è§’è‰²æ¨¡æ¿ç®¡ç†"é…ç½®ä¸ªæ€§åŒ–æç¤ºä¸å ä½ç¬¦ / Configure personalized templates in role management
                        </div>
                        <button type="button" id="apply-sample" class="btn btn-ghost" style="margin-top:8px;">ä¸€é”®å¥—ç”¨è§’è‰²ç¤ºä¾‹ / Apply Sample</button>
                    </div>

                    <!-- Role-specific Sections -->
                    <div id="role-dev" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)
                                </h3>
                            </div>
                            <textarea id="dev-today" name="today_work" placeholder="ğŸ’» æŒ‰è¦ç‚¹å¡«å†™ï¼Œç¤ºä¾‹ï¼šå®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹ / List completed tasks, e.g.: Implemented token renewal logic for login module"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today
                                </h3>
                            </div>
                            <textarea id="dev-progress" name="progress_issues" placeholder="âš ï¸ é£é™©ã€é˜»å¡ç‚¹ã€éœ€è¦ååŠ©çš„äº‹é¡¹ / Risks, blockers, items needing assistance"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow
                                </h3>
                            </div>
                            <textarea id="dev-tomorrow" name="tomorrow_plan" placeholder="ğŸ¯ æ˜æ—¥è®¡åˆ’çš„å¯äº¤ä»˜ç‰©æˆ–éªŒè¯ç›®æ ‡ / Tomorrow's deliverables or validation goals"></textarea>
                        </div>
                    </div>

                    <div id="role-qa" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Today's Testing Scope
                                </h3>
                            </div>
                            <textarea id="qa-scope" name="testing_scope" placeholder="ğŸ§ª ç¤ºä¾‹ï¼šæ–°å¢åŠŸèƒ½ç”¨ä¾‹ 3 æ¡ï¼›æ ¸å¿ƒæµç¨‹å›å½’ 3 æ¡ï¼›è¦†ç›–æ¨¡å—/åœºæ™¯åˆ—è¡¨ / e.g.: 3 new feature cases; 3 core process regression; module/scenario list"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    æµ‹è¯•å®Œæˆæƒ…å†µ / Testing Progress
                                </h3>
                            </div>
                            <textarea id="qa-progress" name="testing_progress" placeholder="ğŸ“Š ç¤ºä¾‹ï¼šè¿›åº¦ 40%ï¼›é€šè¿‡/å¤±è´¥/é˜»å¡ï¼›æ–°å¢/å›å½’æ‰§è¡Œæ•°ï¼›ç¯å¢ƒçŠ¶æ€ / e.g.: 40% progress; pass/fail/blocked; new/regression executed; environment status"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    Bug ç»Ÿè®¡ / Bug Summary
                                </h3>
                            </div>
                            <textarea id="qa-bugs" name="bug_summary" placeholder="ğŸ› ç¤ºä¾‹ï¼šå¾…è§£å†³ 20ï¼Œå»¶æœŸ 5ï¼›æ–°å¢/å…³é—­è¶‹åŠ¿ï¼›é«˜ä¼˜/ä¸­ä¼˜/ä½ä¼˜åˆ†å¸ƒ / e.g.: 20 pending, 5 delayed; new/closed trend; high/medium/low priority distribution"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>4ï¸âƒ£</span>
                                    æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan for Tomorrow
                                </h3>
                            </div>
                            <textarea id="qa-tomorrow" name="testing_tomorrow" placeholder="ğŸ¯ ç¤ºä¾‹ï¼šç›®æ ‡è¿›åº¦ 70%ï¼›å›å½’/æ–°å¢ç”¨ä¾‹æ•°ï¼›ç¼ºé™·æ”¶æ•›ç›®æ ‡ï¼›ä¾èµ–ä¸æ”¯æŒ / e.g.: Target 70% progress; regression/new cases; bug convergence goals; dependencies & support"></textarea>
                        </div>
                    </div>

                    <div id="role-pm" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥äº§å“æ¨è¿›å†…å®¹ / Product Progress Today
                                </h3>
                            </div>
                            <textarea id="pm-today" name="product_today" placeholder="ğŸ“‹ äº§å“éœ€æ±‚æ¨è¿›ã€åŠŸèƒ½è§„åˆ’ã€ç”¨æˆ·åé¦ˆå¤„ç†ç­‰ / Product requirements, feature planning, user feedback handling"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    ä»Šæ—¥åè°ƒ / å†³ç­–äº‹é¡¹ / Coordination & Decisions
                                </h3>
                            </div>
                            <textarea id="pm-coord" name="product_coordination" placeholder="ğŸ¤ è·¨å›¢é˜Ÿåä½œã€é‡è¦å†³ç­–ã€èµ„æºåè°ƒç­‰ / Cross-team collaboration, key decisions, resource coordination"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow
                                </h3>
                            </div>
                            <textarea id="pm-tomorrow" name="product_tomorrow" placeholder="ğŸš€ æ˜æ—¥äº§å“æ¨è¿›é‡ç‚¹ã€ä¼šè®®å®‰æ’ã€äº¤ä»˜ç›®æ ‡ç­‰ / Tomorrow's product priorities, meetings, delivery goals"></textarea>
                        </div>
                    </div>

                    <div id="role-ui" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥å®Œæˆè®¾è®¡ / Designs Completed Today
                                </h3>
                            </div>
                            <textarea id="ui-today" name="ui_today" placeholder="ğŸ¨ å®Œæˆçš„è®¾è®¡ç¨¿ã€åŸå‹ã€è§†è§‰ä¼˜åŒ–ç­‰ / Completed designs, prototypes, visual optimizations"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    åé¦ˆä¸ä¿®æ”¹ / Feedback & Revisions
                                </h3>
                            </div>
                            <textarea id="ui-feedback" name="ui_feedback" placeholder="ğŸ’¬ æ”¶åˆ°çš„åé¦ˆã€ä¿®æ”¹å†…å®¹ã€ç‰ˆæœ¬è¿­ä»£ç­‰ / Feedback received, revisions made, version iterations"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow
                                </h3>
                            </div>
                            <textarea id="ui-tomorrow" name="ui_tomorrow" placeholder="ğŸ¯ æ˜æ—¥è®¾è®¡ä»»åŠ¡ã€è¯„å®¡å®‰æ’ã€äº¤ä»˜è®¡åˆ’ç­‰ / Tomorrow's design tasks, review schedule, delivery plans"></textarea>
                        </div>
                    </div>

                    <div id="role-ops" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥è¿ç»´å·¥ä½œ / Operations Tasks Today
                                </h3>
                            </div>
                            <textarea id="ops-today" name="ops_today" placeholder="âš™ï¸ ç³»ç»Ÿç»´æŠ¤ã€éƒ¨ç½²ã€é…ç½®ç®¡ç†ã€æ€§èƒ½ä¼˜åŒ–ç­‰ / System maintenance, deployment, config management, performance optimization"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    ç›‘æ§ä¸æ•…éšœæƒ…å†µ / Monitoring & Incidents
                                </h3>
                            </div>
                            <textarea id="ops-monitor" name="ops_monitoring" placeholder="ğŸ“Š ç³»ç»Ÿç›‘æ§çŠ¶æ€ã€æ•…éšœå¤„ç†ã€å‘Šè­¦å¤„ç†ç­‰ / System monitoring status, incident handling, alert processing"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow
                                </h3>
                            </div>
                            <textarea id="ops-tomorrow" name="ops_tomorrow" placeholder="ğŸ”§ æ˜æ—¥è¿ç»´ä»»åŠ¡ã€ç³»ç»Ÿä¼˜åŒ–ã€é¢„é˜²æªæ–½ç­‰ / Tomorrow's operations tasks, system optimization, preventive measures"></textarea>
                        </div>
                    </div>

                    <div id="role-mgr" class="role-section">
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>1ï¸âƒ£</span>
                                    ä»Šæ—¥é¡¹ç›®è¿›åº¦æ¦‚è§ˆ / Project Progress Overview
                                </h3>
                            </div>
                            <textarea id="mgr-progress" name="mgr_progress" placeholder="ğŸ“ˆ é¡¹ç›®æ•´ä½“è¿›åº¦ã€é‡Œç¨‹ç¢‘å®Œæˆã€å›¢é˜ŸçŠ¶æ€ç­‰ / Overall project progress, milestone completion, team status"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>2ï¸âƒ£</span>
                                    é£é™©ä¸é˜»å¡ç‚¹ / Risks & Blockers
                                </h3>
                            </div>
                            <textarea id="mgr-risk" name="mgr_risks" placeholder="âš ï¸ é¡¹ç›®é£é™©ã€èµ„æºé—®é¢˜ã€è¿›åº¦é˜»å¡ã€è§£å†³æ–¹æ¡ˆç­‰ / Project risks, resource issues, progress blockers, solutions"></textarea>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <span>3ï¸âƒ£</span>
                                    æ˜æ—¥æ¨è¿›é‡ç‚¹ / Key Focus for Tomorrow
                                </h3>
                            </div>
                            <textarea id="mgr-tomorrow" name="mgr_tomorrow" placeholder="ğŸ¯ æ˜æ—¥é‡ç‚¹é¡¹ç›®ã€å…³é”®å†³ç­–ã€èµ„æºåè°ƒç­‰ / Tomorrow's key projects, critical decisions, resource coordination"></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-ghost" id="btn-clear">
                            <span>ğŸ”„</span>
                            é‡ç½®è¡¨å• / Reset
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-sample">
                            <span>ğŸ“</span>
                            å¡«å…¥ç¤ºä¾‹ / Sample
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-generate">
                            <span>âœ¨</span>
                            ç”Ÿæˆæ—¥æŠ¥ / Generate
                        </button>
                        <button type="submit" name="submit_action" value="draft" class="btn btn-secondary">
                            <span>ğŸ’¾</span>
                            {% if editing %}æ›´æ–°è‰ç¨¿ / Update Draft{% else %}ä¿å­˜è‰ç¨¿ / Save Draft{% endif %}
                        </button>
                        <button type="submit" name="submit_action" value="submit" class="btn btn-primary">
                            <span>ğŸš€</span>
                            {% if editing %}æ›´æ–°å¹¶æäº¤ / Update & Submit{% else %}æäº¤æ—¥æŠ¥ / Submit Report{% endif %}
                        </button>
                    </div>
                </section>

                <!-- Preview Panel -->
                <aside class="card preview-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <div class="card-icon">ğŸ“„</div>
                                æ—¥æŠ¥é¢„è§ˆ / Report Preview
                            </h2>
                            <p class="card-subtitle">
                                ğŸ”„ å®æ—¶é¢„è§ˆç”Ÿæˆç»“æœï¼Œæ”¯æŒä¸€é”®å¤åˆ¶åˆ°å‰ªè´´æ¿ / Real-time preview with one-click copy
                            </p>
                        </div>
                    </div>
                    
                    <div class="preview-area" id="preview">
                        <div class="preview-badge">ğŸ“‹ No Report Generated / æœªç”Ÿæˆ</div>
                        <div class="preview-content" id="preview-content">
                            <p><strong>ç¤ºä¾‹ç”¨æˆ·ï¼Œ2024 å¹´ 01 æœˆ 01 æ—¥å·¥ä½œæŠ¥å‘Š / Sample User, Jan 01, 2024 Work Report</strong></p>
                            <p><strong>ã€åŸºæœ¬ä¿¡æ¯ / Basic Infoã€‘</strong><br>
                            å§“å / Nameï¼šç¤ºä¾‹ / Sample<br>
                            æ—¥æœŸ / Dateï¼šYYYY-MM-DD<br>
                            è§’è‰² / Roleï¼šè§’è‰² / Role<br>
                            é¡¹ç›® / Projectï¼šæœªé€‰æ‹© / None</p>
                            <p>ğŸ’¡ è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯åï¼Œç‚¹å‡»ã€Œç”Ÿæˆæ—¥æŠ¥å†…å®¹ã€æŒ‰é’®ã€‚<br>
                            ğŸ’¡ Please fill in the form on the left and click "Generate Report" button.</p>
                        </div>
                    </div>
                    
                    <div class="preview-status">
                        <div class="status-left">
                            <span class="status-dot"></span>
                            <span id="status-text">â³ ç­‰å¾…ç”Ÿæˆæ—¥æŠ¥â€¦ / Waiting to generate reportâ€¦</span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" id="btn-copy">
                                <span>ğŸ“‹</span>
                                å¤åˆ¶å†…å®¹ / Copy
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </form>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span>âœ…</span>
        <span id="toast-text">æ“ä½œæˆåŠŸ / Success</span>
    </div>

<script>
    // Initialize today's date
    (function setToday() {
        const input = document.getElementById('date');
        if (input && !input.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            input.value = `${yyyy}-${mm}-${dd}`;
        }
    })();

    // Global variables
    const roleSelect = document.getElementById('role');
    const projectFilterInput = document.getElementById('project-filter');
    const projectTypeahead = document.getElementById('project-typeahead');
    const projectOptions = document.getElementById('project-options');
    const dateInput = document.getElementById('date');
    const nameInput = document.getElementById('name');
    const initialRoleValue = roleSelect ? roleSelect.value : '';
    const initialDateValue = dateInput ? dateInput.value : '';
    const initialNameValue = nameInput ? nameInput.value : '';
    const templateHint = document.getElementById('template-hint');
    const sampleBtn = document.getElementById('apply-sample');
    let templateSample = '';
    const templateApi = "{% url 'reports:role_template_api' %}";
    const projectApi = "{% url 'reports:project_search_api' %}";
    
    // Role sections configuration
    const roleSections = {
        dev: document.getElementById('role-dev'),
        qa: document.getElementById('role-qa'),
        pm: document.getElementById('role-pm'),
        ui: document.getElementById('role-ui'),
        ops: document.getElementById('role-ops'),
        mgr: document.getElementById('role-mgr'),
    };
    
    const roleLabels = {
        dev: 'å¼€å‘ / Developer',
        qa: 'æµ‹è¯• / QA Engineer',
        pm: 'äº§å“ / Product Manager',
        ui: 'è®¾è®¡ / UI/UX Designer',
        ops: 'è¿ç»´ / DevOps',
        mgr: 'ç®¡ç† / Project Manager',
    };
    
    const roleFields = {
        dev: ['dev-today','dev-progress','dev-tomorrow'],
        qa: ['qa-scope','qa-progress','qa-bugs','qa-tomorrow'],
        pm: ['pm-today','pm-coord','pm-tomorrow'],
        ui: ['ui-today','ui-feedback','ui-tomorrow'],
        ops: ['ops-today','ops-monitor','ops-tomorrow'],
        mgr: ['mgr-progress','mgr-risk','mgr-tomorrow'],
    };
    
    // Preview elements
    const preview = document.getElementById('preview');
    const statusText = document.getElementById('status-text');
    const previewContent = document.getElementById('preview-content');
    const STORAGE_KEY = "daily_report_draft_{{ request.user.username|escapejs }}";

    // Helper functions
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };
    
    const formatDateCN = (dateStr) => {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const [y, m, d] = parts;
            return `${y} å¹´ ${parseInt(m, 10)} æœˆ ${parseInt(d, 10)} æ—¥`;
        }
        return dateStr;
    };

    // Role visibility management
    function updateRoleVisibility() {
        const value = roleSelect ? roleSelect.value : '';
        Object.entries(roleSections).forEach(([key, el]) => {
            if (!el) return;
            if (key === value) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        });
    }
    
    function applyPlaceholders(role, placeholders) {
        const fields = roleFields[role] || [];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el && placeholders[id]) {
                el.placeholder = placeholders[id];
            }
        });
    }
    
    async function loadRoleTemplate(role) {
        if (!role) return;
        try {
            const res = await fetch(`${templateApi}?role=${encodeURIComponent(role)}`);
            if (!res.ok) return;
            const data = await res.json();
            applyPlaceholders(role, data.placeholders || {});
            templateSample = data.sample_md || '';
            if (sampleBtn) {
                sampleBtn.disabled = !templateSample;
                sampleBtn.textContent = templateSample ? 'ä¸€é”®å¥—ç”¨è§’è‰²ç¤ºä¾‹ / Apply Sample' : 'æš‚æ— ç¤ºä¾‹ / No sample';
            }
            if (templateHint) {
                const updated = data.updated_at ? `ï¼ˆæ›´æ–°äº ${data.updated_at.substring(0,16).replace('T',' ')}ï¼‰` : '';
                templateHint.textContent = (data.hint || 'ä½¿ç”¨é»˜è®¤æç¤º / Using default hints') + updated;
            }
        } catch (e) {
            // ignore network errors
        }
    }
    
    // Role change handler
    if (roleSelect) {
        roleSelect.addEventListener('change', () => {
            updateRoleVisibility();
            loadRoleTemplate(roleSelect.value);
        });
        updateRoleVisibility();
        loadRoleTemplate(roleSelect.value);
    }

    // Apply sample Markdown
    if (sampleBtn) {
        sampleBtn.addEventListener('click', () => {
            if (!templateSample) {
                showToast('æš‚æ— ç¤ºä¾‹å¯ç”¨ / No sample available');
                return;
            }
            const role = roleSelect ? roleSelect.value : 'dev';
            const fields = roleFields[role] || [];
            if (!fields.length) return;
            fields.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (!el) return;
                // ä»…åœ¨ä¸ºç©ºæ—¶å¡«å…¥ï¼Œé¿å…è¦†ç›–ç”¨æˆ·å·²å†™å†…å®¹
                if (!el.value.trim()) {
                    el.value = idx == 0 ? templateSample : '';
                }
            });
            showToast('å·²å¥—ç”¨è§’è‰²ç¤ºä¾‹ï¼Œå¯æŒ‰éœ€ä¿®æ”¹ / Sample applied');
        });
    }

    // Toast notification
    function showToast(text) {
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toast-text');
        toastText.textContent = text;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // Project filtering
    function filterProjects() {
        const select = document.getElementById('projects');
        const query = (projectFilterInput ? projectFilterInput.value : '').toLowerCase();
        if (!select) return;
        Array.from(select.options).forEach(opt => {
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(query) ? '' : 'none';
        });
    }
    if (projectFilterInput) {
        projectFilterInput.addEventListener('input', filterProjects);
    }

    // Project search
    async function fetchProjects(q) {
        if (!projectOptions) return;
        projectOptions.innerHTML = '';
        try {
            const res = await fetch(`${projectApi}?q=${encodeURIComponent(q)}`);
            if (!res.ok) return;
            const data = await res.json();
            (data.results || []).forEach(item => {
                const opt = document.createElement('option');
                opt.value = `${item.name}ï¼ˆ${item.code}ï¼‰`;
                opt.dataset.id = item.id;
                projectOptions.appendChild(opt);
            });
        } catch (e) {
            // ignore network errors
        }
    }
    
    function addProjectFromTypeahead() {
        if (!projectTypeahead) return;
        const text = projectTypeahead.value;
        const match = Array.from(projectOptions.options).find(o => o.value === text);
        if (!match) return;
        const projectId = match.dataset.id;
        const select = document.getElementById('projects');
        if (!select) return;
        let opt = Array.from(select.options).find(o => o.value === projectId);
        if (!opt) {
            opt = document.createElement('option');
            opt.value = projectId;
            opt.textContent = text;
            select.appendChild(opt);
        }
        opt.selected = true;
        projectTypeahead.value = '';
    }
    if (projectTypeahead) {
        projectTypeahead.addEventListener('input', (e) => {
            const q = e.target.value;
            if (q && q.length >= 1) fetchProjects(q);
        });
        projectTypeahead.addEventListener('change', addProjectFromTypeahead);
    }

    // Form validation
    function validateDailyForm(submitterValue) {
        if (submitterValue === 'draft') return true; // è‰ç¨¿ä¸å¼ºåˆ¶æ ¡éªŒ
        const dateVal = dateInput ? dateInput.value : '';
        const roleVal = roleSelect ? roleSelect.value : '';
        if (!dateVal || !roleVal) {
            showToast('âš ï¸ è¯·å¡«å†™æ—¥æœŸå¹¶é€‰æ‹©è§’è‰² / Please fill date and select role');
            return false;
        }
        const fields = roleFields[roleVal] || [];
        const hasContent = fields.some(id => {
            const el = document.getElementById(id);
            return el && el.value.trim().length > 0;
        });
        if (!hasContent) {
            showToast('âš ï¸ è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå½“å‰è§’è‰²çš„å†…å®¹å­—æ®µ / Please fill at least one content field');
            return false;
        }
        return true;
    }

    // Auto-save functionality
    const formEl = document.querySelector('form');
    const isEditing = !!document.querySelector('input[name="report_id"]');
    
    const saveDraft = () => {
        if (!formEl) return;
        const data = {};
        formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
            if (el.multiple) {
                data[el.name] = Array.from(el.selectedOptions).map(o => o.value);
            } else {
                data[el.name] = el.value;
            }
        });
        data._ts = Date.now();
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            // ignore storage errors
        }
    };
    
    const restoreDraft = () => {
        if (!formEl) return;
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                if (!(el.name in data)) return;
                if (el.multiple) {
                    const hasSelected = Array.from(el.options).some(o => o.selected);
                    if (hasSelected) return;
                    const target = data[el.name] || [];
                    Array.from(el.options).forEach(o => { o.selected = target.includes(o.value); });
                } else {
                    if (el.value) return;
                    el.value = data[el.name] || '';
                }
            });
            updateRoleVisibility();
        } catch (e) {
            return;
        }
    };
    
    const debounce = (fn, delay = 400) => {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    };
    
    const debouncedSave = debounce(saveDraft, 400);
    
    if (formEl) {
        restoreDraft();
        formEl.addEventListener('input', debouncedSave);
        formEl.addEventListener('change', debouncedSave);
        formEl.addEventListener('submit', (e) => {
            const submitValue = e.submitter ? e.submitter.value : '';
            if (!validateDailyForm(submitValue)) {
                e.preventDefault();
                return;
            }
            localStorage.removeItem(STORAGE_KEY);
        });
    }

    // Markdown to HTML converter
    function markdownToHtml(text) {
        const escape = (s) => s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        const lines = (text || '').split(/\n/);
        let html = '';
        let inList = false;
        lines.forEach(raw => {
            const line = raw.trimEnd();
            if (/^\s*[-*]\s+/.test(line)) {
                if (!inList) { html += '<ul>'; inList = true; }
                html += `<li>${escape(line.replace(/^\s*[-*]\s+/, ''))}</li>`;
                return;
            }
            if (inList) { html += '</ul>'; inList = false; }
            if (/^#{1,3}\s+/.test(line)) {
                const level = Math.min(line.match(/^#+/)[0].length, 3);
                const tag = level === 1 ? 'h2' : level === 2 ? 'h3' : 'h4';
                html += `<${tag}>${escape(line.replace(/^#{1,3}\s+/, ''))}</${tag}>`;
            } else if (line === '') {
                html += '<br>';
            } else {
                html += `<p>${escape(line)}</p>`;
            }
        });
        if (inList) html += '</ul>';
        return html || '<p>æš‚æ— å†…å®¹ / No content</p>';
    }

    // Preview rendering
    function renderPreview(text, badgeLabel) {
        if (!preview || !previewContent) return;
        preview.innerHTML = '';
        const badge = document.createElement('div');
        badge.className = 'preview-badge';
        badge.textContent = badgeLabel;
        const content = document.createElement('div');
        content.className = 'preview-content';
        content.innerHTML = markdownToHtml(text);
        preview.appendChild(badge);
        preview.appendChild(content);
    }

    // Report generation
    function generateReport() {
        const projectSelect = document.getElementById('projects');
        const name = (nameInput ? nameInput.value : '').trim();
        const date = dateInput ? dateInput.value : '';
        const role = roleSelect ? roleSelect.value : '';
        const projectNames = Array.from(projectSelect ? projectSelect.selectedOptions : [])
            .map(opt => opt.textContent.trim())
            .filter(Boolean);
        if (!name || !date || !role) {
            showToast('âš ï¸ è¯·å…ˆå¡«å†™å§“åã€æ—¥æœŸå’Œè§’è‰² / Please fill name, date and role');
            return '';
        }

        const lines = [
            `${name}ï¼Œ${formatDateCN(date)} å·¥ä½œæŠ¥å‘Š / ${name}, ${date} Work Report`,
            '',
            'ã€åŸºæœ¬ä¿¡æ¯ / Basic Informationã€‘',
            `å§“å / Nameï¼š${name}`,
            `æ—¥æœŸ / Dateï¼š${date}`,
            `è§’è‰² / Roleï¼š${roleLabels[role] || role}`,
            `é¡¹ç›® / Projectï¼š${projectNames.length ? projectNames.join('ï¼Œ') : 'æœªé€‰æ‹© / None'}`,
            '',
        ];
        
        const addSection = (title, value) => {
            lines.push(title, value || '- ï¼ˆå¾…å¡«å†™ / To be filledï¼‰', '');
        };

        if (role === 'dev') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)', getValue('dev-today'));
            addSection('äºŒã€ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today', getValue('dev-progress'));
            addSection('ä¸‰ã€æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow', getValue('dev-tomorrow'));
        } else if (role === 'qa') {
            addSection('ä¸€ã€ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Today\'s Testing Scope', getValue('qa-scope'));
            addSection('äºŒã€æµ‹è¯•å®Œæˆæƒ…å†µ / Testing Progress', getValue('qa-progress'));
            addSection('ä¸‰ã€Bug ç»Ÿè®¡ / Bug Summary', getValue('qa-bugs'));
            addSection('å››ã€æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan for Tomorrow', getValue('qa-tomorrow'));
        } else if (role === 'pm') {
            addSection('ä¸€ã€ä»Šæ—¥äº§å“æ¨è¿›å†…å®¹ / Product Progress Today', getValue('pm-today'));
            addSection('äºŒã€ä»Šæ—¥åè°ƒ / å†³ç­–äº‹é¡¹ / Coordination & Decisions', getValue('pm-coord'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('pm-tomorrow'));
        } else if (role === 'ui') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆè®¾è®¡ / Designs Completed Today', getValue('ui-today'));
            addSection('äºŒã€åé¦ˆä¸ä¿®æ”¹ / Feedback & Revisions', getValue('ui-feedback'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ui-tomorrow'));
        } else if (role === 'ops') {
            addSection('ä¸€ã€ä»Šæ—¥è¿ç»´å·¥ä½œ / Operations Tasks Today', getValue('ops-today'));
            addSection('äºŒã€ç›‘æ§ä¸æ•…éšœæƒ…å†µ / Monitoring & Incidents', getValue('ops-monitor'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ops-tomorrow'));
        } else if (role === 'mgr') {
            addSection('ä¸€ã€ä»Šæ—¥é¡¹ç›®è¿›åº¦æ¦‚è§ˆ / Project Progress Overview', getValue('mgr-progress'));
            addSection('äºŒã€é£é™©ä¸é˜»å¡ç‚¹ / Risks & Blockers', getValue('mgr-risk'));
            addSection('ä¸‰ã€æ˜æ—¥æ¨è¿›é‡ç‚¹ / Key Focus for Tomorrow', getValue('mgr-tomorrow'));
        }

        return lines.join('\n');
    }

    // Button handlers
    const btnGenerate = document.getElementById('btn-generate');
    if (btnGenerate) {
        btnGenerate.addEventListener('click', () => {
            const report = generateReport();
            if (!report) return;
            renderPreview(report, 'âœ¨ Generated Â· å·²ç”Ÿæˆ');
            if (statusText) {
                statusText.textContent = 'âœ… å·²ç”Ÿæˆæ—¥æŠ¥ï¼Œå¯å¤åˆ¶ / Report generated, ready to copy';
            }
        });
    }

    const btnCopy = document.getElementById('btn-copy');
    if (btnCopy) {
        btnCopy.addEventListener('click', async () => {
            const content = previewContent ? previewContent.textContent : null;
            if (!content) {
                showToast('âš ï¸ å½“å‰æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥æŠ¥å†…å®¹ / No report content to copy');
                return;
            }
            try {
                await navigator.clipboard.writeText(content);
                showToast('âœ… æ—¥æŠ¥å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ / Report copied to clipboard');
            } catch (e) {
                showToast('âš ï¸ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ / Copy failed, please copy manually');
            }
        });
    }

    const btnClear = document.getElementById('btn-clear');
    if (btnClear) {
        btnClear.addEventListener('click', () => {
            if (!confirm('âš ï¸ ç¡®è®¤é‡ç½®è¡¨å•å†…å®¹ï¼Ÿ/ Confirm reset form?')) return;
            const idsToClear = [
                'dev-today','dev-progress','dev-tomorrow',
                'qa-scope','qa-progress','qa-bugs','qa-tomorrow',
                'pm-today','pm-coord','pm-tomorrow',
                'ui-today','ui-feedback','ui-tomorrow',
                'ops-today','ops-monitor','ops-tomorrow',
                'mgr-progress','mgr-risk','mgr-tomorrow'
            ];
            idsToClear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const projectSelect = document.getElementById('projects');
            if (projectSelect) {
                Array.from(projectSelect.options).forEach(o => o.selected = false);
            }
            if (roleSelect) {
                roleSelect.value = initialRoleValue;
                updateRoleVisibility();
            }
            if (dateInput) {
                if (initialDateValue) {
                    dateInput.value = initialDateValue;
                } else {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${yyyy}-${mm}-${dd}`;
                }
            }
            if (nameInput && initialNameValue) {
                nameInput.value = initialNameValue;
            }
            const fallbackName = (nameInput ? nameInput.value : '').trim() || 'ç¤ºä¾‹ / Sample';
            const roleLabel = roleLabels[roleSelect ? roleSelect.value : ''] || 'è§’è‰² / Role';
            const projectLabel = projectSelect && projectSelect.selectedOptions.length
                ? Array.from(projectSelect.selectedOptions).map(o => o.textContent.trim()).join('ï¼Œ')
                : 'æœªé€‰æ‹© / None';
            const nowDate = dateInput ? (dateInput.value || new Date().toISOString().slice(0, 10)) : new Date().toISOString().slice(0, 10);
            const sample = [
                `${fallbackName}ï¼Œ${formatDateCN(nowDate)} å·¥ä½œæŠ¥å‘Š / ${fallbackName}, ${nowDate} Work Report`,
                'ã€åŸºæœ¬ä¿¡æ¯ / Basic Informationã€‘',
                `å§“å / Nameï¼š${fallbackName}`,
                `æ—¥æœŸ / Dateï¼š${nowDate}`,
                `è§’è‰² / Roleï¼š${roleLabel}`,
                `é¡¹ç›® / Projectï¼š${projectLabel}`,
                '',
                'ä¸€ã€ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)',
                '- å®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹ / Implemented and self-tested token renewal logic',
                '- è°ƒæ•´ç½‘å…³å¤šä¼ä¸šè·¯ç”±é…ç½®ï¼Œæ”¯æŒä¼ä¸šç²’åº¦éš”ç¦» / Adjusted multi-tenant routing for enterprise isolation',
                '- ä¿®å¤ LiteChat PC ç¾¤èŠç¦è¨€é€»è¾‘å¼‚å¸¸é—®é¢˜ / Fixed mute logic issue in group chat',
                '',
                'äºŒã€ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today',
                '- ç½‘å…³ç°åº¦å‘å¸ƒè„šæœ¬ä»åœ¨è°ƒè¯•é˜¶æ®µï¼Œé¢„è®¡è¿˜éœ€ 0.5 å¤© / Gateway canary script still being tuned (~0.5 day)',
                '- ç­‰å¾…æµ‹è¯•è¡¥å……å¤šç»ˆç«¯ç™»å½•åœºæ™¯ç”¨ä¾‹ / Waiting for QA to add multi-device login cases',
                '',
                'ä¸‰ã€æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow',
                '- å®Œæˆç½‘å…³å‘å¸ƒè„šæœ¬ä¼˜åŒ–ä¸è”è°ƒ / Finish gateway release script & integration',
                '- é…åˆæµ‹è¯•ä¿®å¤ç™»å½• / ç¾¤èŠç›¸å…³ Bug / Work with QA on login & group chat bugs',
                '- é¢„ç ”ä¼ä¸š IP ç™½åå•ä¸å®‰å…¨ç»„é…ç½®å®ç°æ–¹æ¡ˆ / Research enterprise IP whitelist & security group design',
            ].join('\n');
            renderPreview(sample, 'ğŸ“‹ No Report Generated / æœªç”Ÿæˆ');
            if (statusText) {
                statusText.textContent = 'â³ ç­‰å¾…ç”Ÿæˆæ—¥æŠ¥â€¦ / Waiting to generate reportâ€¦';
            }
            try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
            showToast('âœ… è¡¨å•å·²é‡ç½® / Form reset successfully');
        });
    }

    const btnSample = document.getElementById('btn-sample');
    if (btnSample) {
        btnSample.addEventListener('click', () => {
            const role = roleSelect ? roleSelect.value : '';
            if (role === 'qa') {
                updateRoleVisibility();
                const qaScope = document.getElementById('qa-scope');
                const qaProgress = document.getElementById('qa-progress');
                const qaBugs = document.getElementById('qa-bugs');
                const qaTomorrow = document.getElementById('qa-tomorrow');
                if (qaScope) {
                    qaScope.value = 'æ–°å¢åŠŸèƒ½ç”¨ä¾‹ 3 æ¡ / 3 new feature cases\næ ¸å¿ƒæµç¨‹å›å½’ 3 æ¡ / 3 core process regression';
                }
                if (qaProgress) {
                    qaProgress.value = 'æµ‹è¯•è¿›åº¦ 40%ï¼Œæ–°å¢/å›å½’ç”¨ä¾‹å…± 6 æ¡å·²æ‰§è¡Œ / 40% progress, 6 new/regression cases executed\nå·²éªŒè¯å¹¶å…³é—­ç¼ºé™· 5 æ¡ï¼Œç¯å¢ƒç¨³å®š / 5 defects verified and closed, environment stable';
                }
                if (qaBugs) {
                    qaBugs.value = 'å¾…è§£å†³ç¼ºé™· 20 æ¡ï¼Œå…¶ä¸­å»¶æœŸï¼ˆ>3 å¤©ï¼‰5 æ¡ / 20 pending defects, 5 delayed (>3 days)\nä»Šæ—¥æ–°å¢ç¼ºé™· 0ï¼Œé«˜/ä¸­/ä½é£é™©åˆ†å¸ƒï¼š0/0/0 / 0 new defects today, high/medium/low: 0/0/0';
                }
                if (qaTomorrow) {
                    qaTomorrow.value = 'è¦†ç›–ç‡æå‡è‡³ â‰¥70%ï¼Œç»§ç»­å›å½’ä¸æ–°å¢ç”¨ä¾‹ / Coverage to â‰¥70%, continue regression & new cases\næ”¶æ•›å»¶æœŸç¼ºé™· 3/5ï¼Œæ¨åŠ¨å‰©ä½™ç¼ºé™·æ’æœŸä¸éªŒè¯ / Converge 3/5 delayed defects, push scheduling & verification\nè¡¥å……é—®é¢˜ 1/2 çš„å¤ç°ã€æ—¥å¿—ä¸è·Ÿè¿›äºº / Add reproduction steps, logs & owners for 1/2 issues';
                }
                showToast('âœ… å·²å¡«å…¥ QA ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / QA sample filled, modify and submit');
                return;
            }

            if (role === 'pm') {
                updateRoleVisibility();
                const pmToday = document.getElementById('pm-today');
                const pmCoord = document.getElementById('pm-coord');
                const pmTomorrow = document.getElementById('pm-tomorrow');
                if (pmToday) {
                    pmToday.value = 'æ¢³ç†ç‰ˆæœ¬éœ€æ±‚ä¼˜å…ˆçº§å¹¶å†»ç»“èŒƒå›´ / Prioritize version requirements and freeze scope\näº¤ä»˜äº¤äº’ç¨¿ v2ï¼ˆç™»å½•/å‘Šè­¦/ä»ªè¡¨ç›˜ï¼‰ç»™è®¾è®¡ä¸ç ”å‘ / Deliver interaction draft v2 (login/alerts/dashboard) to design & dev\næ˜ç¡®åŸ‹ç‚¹/å¯è§‚æµ‹æ€§éœ€æ±‚æ¸…å•å¹¶ç¡®è®¤è¯„å®¡æ—¶é—´ / Define tracking/observability requirements and confirm review time';
                }
                if (pmCoord) {
                    pmCoord.value = 'ä¸ç ”å‘ç¡®è®¤æ¥å£å˜æ›´å½±å“ï¼Œæ•²å®šæ•°æ®å­—å…¸ / Confirm API change impact with dev, finalize data dictionary\nåè°ƒæµ‹è¯•ç¯å¢ƒèµ„æºä¸å‘å¸ƒçª—å£ï¼Œé¿å…å›å½’å†²çª / Coordinate test environment resources & release windows, avoid regression conflicts\nå¯¹é½å»¶æœŸç¼ºé™·ä¼˜å…ˆçº§ï¼Œè¦æ±‚è¡¥å…… ETA ä¸è´£ä»»äºº / Align delayed defect priorities, require ETA & owners';
                }
                if (pmTomorrow) {
                    pmTomorrow.value = 'å®Œæˆå‘Šè­¦ç­–ç•¥éœ€æ±‚éªŒæ”¶æ¸…å•å¹¶å‘å‡ºè¯„å®¡çºªè¦ / Complete alert strategy requirements checklist and send review minutes\nå‡†å¤‡ä¸‹ä¸€ä¸ªè¿­ä»£çš„éœ€æ±‚æ‹†åˆ†ä¸è¯„å®¡åŒ… / Prepare next iteration requirements breakdown and review package\nè·Ÿè¸ªå»¶æœŸç¼ºé™·çš„äº§å“å½±å“ä¸ä¸Šçº¿èŠ‚å¥ / Track product impact of delayed defects and release schedule';
                }
                showToast('âœ… å·²å¡«å…¥ PM ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / PM sample filled, modify and submit');
                return;
            }

            if (role === 'ui') {
                updateRoleVisibility();
                const uiToday = document.getElementById('ui-today');
                const uiFeedback = document.getElementById('ui-feedback');
                const uiTomorrow = document.getElementById('ui-tomorrow');
                if (uiToday) {
                    uiToday.value = 'å®Œæˆå‘Šè­¦ä¸­å¿ƒé«˜ä¿çœŸä¸åˆ‡å›¾ï¼Œæ ‡æ³¨å®Œå¤‡ / Complete alert center high-fidelity and slicing, with full annotations\nä¼˜åŒ–ä»ªè¡¨ç›˜è§†è§‰å±‚çº§ä¸ç©ºçŠ¶æ€ç»„ä»¶ï¼Œæå‡å¯è¯»æ€§ / Optimize dashboard visual hierarchy and empty state components for better readability';
                }
                if (uiFeedback) {
                    uiFeedback.value = 'æ ¹æ® PM åé¦ˆè°ƒæ•´å‘Šè­¦ç­›é€‰çš„äº¤äº’åŠ¨æ•ˆä¸æç¤º / Adjust alert filtering interaction effects and hints based on PM feedback\nä¸å‰ç«¯å¯¹é½è‰²æ¿ä¸é—´è·è§„èŒƒï¼Œè§£å†³é€‚é…é—®é¢˜ / Align color palette and spacing specifications with frontend, resolve adaptation issues';
                }
                if (uiTomorrow) {
                    uiTomorrow.value = 'è¾“å‡ºç§»åŠ¨ç«¯é€‚é…ç¨¿ï¼ˆç™»å½•/ä»ªè¡¨ç›˜ï¼‰å¹¶èµ°æŸ¥ / Output mobile adaptation drafts (login/dashboard) and conduct review\nè¡¥å……è®¾è®¡æ–‡æ¡£ä¸èµ„äº§äº¤ä»˜æ¸…å•ï¼Œæ”¯æŒå‰ç«¯è”è°ƒ / Add design documentation and asset delivery checklist to support frontend integration';
                }
                showToast('âœ… å·²å¡«å…¥ UI ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / UI sample filled, modify and submit');
                return;
            }

            if (role === 'ops') {
                updateRoleVisibility();
                const opsToday = document.getElementById('ops-today');
                const opsMonitor = document.getElementById('ops-monitor');
                const opsTomorrow = document.getElementById('ops-tomorrow');
                if (opsToday) {
                    opsToday.value = 'å®Œæˆé¢„å‘ç¯å¢ƒæ‰©å®¹ä¸ç°åº¦ç­–ç•¥è°ƒä¼˜ / Complete staging environment scaling and canary strategy optimization\nç¼–æ’æ¯æ—¥å¤‡ä»½ä¸æ¢å¤æ¼”ç»ƒè„šæœ¬ï¼Œè‡ªæµ‹é€šè¿‡ / Orchestrate daily backup and recovery drill scripts, self-tested successfully';
                }
                if (opsMonitor) {
                    opsMonitor.value = 'ç›‘æ§æ— ä¸¥é‡å‘Šè­¦ï¼›å¤„ç† 2 æ¡æ¥å£è¶…æ—¶ï¼Œå·²æ¢å¤ / No critical alerts; handled 2 interface timeouts, now resolved\næ’æŸ¥ä¸€ä¾‹ç£ç›˜ç©ºé—´é¢„è­¦ï¼Œæ¸…ç†æ—¥å¿—å¹¶åŠ é™æµè§„åˆ™ / Investigated disk space warning, cleared logs and added rate limiting rules';
                }
                if (opsTomorrow) {
                    opsTomorrow.value = 'ä¸Šçº¿æ–°å‘Šè­¦ç­–ç•¥ä¸çœ‹æ¿ï¼ŒéªŒè¯è¯¯æŠ¥ç‡ / Deploy new alert strategies and dashboards, verify false positive rate\nå’Œç ”å‘è”è°ƒå¥åº·æ£€æŸ¥ä¸è‡ªåŠ¨æ‰©ç¼©å®¹é˜ˆå€¼ / Coordinate health checks and auto-scaling thresholds with development';
                }
                showToast('âœ… å·²å¡«å…¥ Ops ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Ops sample filled, modify and submit');
                return;
            }

            if (role === 'mgr') {
                updateRoleVisibility();
                const mgrProgress = document.getElementById('mgr-progress');
                const mgrRisk = document.getElementById('mgr-risk');
                const mgrTomorrow = document.getElementById('mgr-tomorrow');
                if (mgrProgress) {
                    mgrProgress.value = 'æœ¬å‘¨æ•´ä½“è¿›åº¦ 40%ï¼Œç ”å‘ 45% / æµ‹è¯• 40% / Overall weekly progress 40%, dev 45% / test 40%\nå…³é”®é‡Œç¨‹ç¢‘ï¼šæ ¸å¿ƒå›å½’å®Œæˆ 3 æ¡ï¼Œå…³é—­ç¼ºé™· 5 æ¡ / Key milestone: 3 core regressions completed, 5 defects closed';
                }
                if (mgrRisk) {
                    mgrRisk.value = 'å»¶æœŸç¼ºé™· 5 æ¡ï¼ˆ>3 å¤©ï¼‰ï¼Œå½±å“ä¸Šçº¿èŠ‚å¥ï¼Œéœ€ç ”å‘ç»™ ETA / 5 delayed defects (>3 days) affecting release schedule, need ETA from dev\næµ‹è¯•è¦†ç›–éœ€æå‡è‡³ 70% ä»¥æ”¯æ’‘ä¸‹è½®å‘å¸ƒçª—å£ / Test coverage needs to reach 70% to support next release window';
                }
                if (mgrTomorrow) {
                    mgrTomorrow.value = 'ç»„ç»‡ç¼ºé™·æ”¶æ•›ä¸“é¡¹ï¼Œè¦æ±‚å»¶æœŸç¼ºé™·æ˜ç¡®è´£ä»»ä¸æ—¶é—´è¡¨ / Organize defect convergence special session, require clear responsibility and timeline for delayed defects\nç¡®è®¤å‘å¸ƒçª—å£ä¸å›æ»šæ–¹æ¡ˆï¼Œå¯¹é½é¡¹ç›®å¹²ç³»äºº / Confirm release window and rollback plan, align stakeholders\nè·Ÿè¿›æµ‹è¯•è¿›åº¦æé€Ÿæªæ–½ï¼Œå¢æ´äººæ‰‹æˆ–ä¼˜åŒ–ç”¨ä¾‹æ’æœŸ / Follow up on test progress acceleration measures, add resources or optimize case scheduling';
                }
                showToast('âœ… å·²å¡«å…¥ç®¡ç†ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Management sample filled, modify and submit');
                return;
            }

            // Default: Developer sample
            if (roleSelect) {
                roleSelect.value = 'dev';
                updateRoleVisibility();
            }
            const projectSelect = document.getElementById('projects');
            if (projectSelect && projectSelect.options.length) {
                Array.from(projectSelect.options).forEach(o => o.selected = false);
                projectSelect.options[0].selected = true;
                if (projectSelect.options.length > 1) projectSelect.options[1].selected = true;
            }
            const devToday = document.getElementById('dev-today');
            const devProgress = document.getElementById('dev-progress');
            const devTomorrow = document.getElementById('dev-tomorrow');
            if (devToday) {
                devToday.value = '- å®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹ / Implemented and self-tested token renewal logic\n- è°ƒæ•´ç½‘å…³å¤šä¼ä¸šè·¯ç”±é…ç½®ï¼Œæ”¯æŒä¼ä¸šç²’åº¦éš”ç¦» / Adjusted multi-tenant routing for enterprise isolation';
            }
            if (devProgress) {
                devProgress.value = '- ç½‘å…³ç°åº¦å‘å¸ƒè„šæœ¬ä»åœ¨è°ƒè¯•é˜¶æ®µï¼Œé¢„è®¡è¿˜éœ€ 0.5 å¤© / Gateway canary script still being tuned (~0.5 day)';
            }
            if (devTomorrow) {
                devTomorrow.value = '- å®Œæˆç½‘å…³å‘å¸ƒè„šæœ¬ä¼˜åŒ–ä¸è”è°ƒ / Finish gateway release script & integration\n- é…åˆæµ‹è¯•ä¿®å¤ç™»å½• / ç¾¤èŠç›¸å…³ Bug / Work with QA on login & group chat bugs';
            }
            showToast('âœ… å·²å¡«å…¥ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Sample filled, modify and submit');
        });
    }
</script>
{% endblock %}
