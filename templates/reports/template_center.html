{% extends "base_topbar.html" %}
{% block title %}æ¨¡æ¿ä¸­å¿ƒ / Template Center{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="æ¨¡æ¿ä¸­å¿ƒ / Template Center" nav_subtitle="æŒ‰è§’è‰²ä¸é¡¹ç›®å…±äº«æ—¥æŠ¥ä¸ä»»åŠ¡æ¨¡æ¿ / Share report & task templates by role/project" %}{% endblock %}

{% block extra_styles %}
    /* --- Shared Design System --- */
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background-color: var(--bg-page);
        color: var(--text-main);
    }

    /* --- Filter Section --- */
    .filter-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .form-input, .form-select, textarea {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        background-color: #fff;
        width: 100%;
        color: var(--text-main);
    }

    .form-input:focus, .form-select:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 16px;
        border-top: 1px solid var(--border-color);
        padding-top: 16px;
    }

    /* --- Buttons --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
        line-height: 1.4;
    }

    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { border-color: #cbd5e1; background: #f8fafc; }
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { background: var(--primary-light); color: var(--primary); }

    /* --- Tabs --- */
    .tabs-nav {
        display: flex;
        gap: 4px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
    }

    .tab-btn {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        border: none;
        background: transparent;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: var(--transition);
    }

    .tab-btn:hover { color: var(--primary); background: var(--primary-light); border-radius: 8px 8px 0 0; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
    .tab-content.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Card Grid --- */
    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .template-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
    }

    .template-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: #cbd5e1;
    }

    .template-card.new::after {
        content: 'New';
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--success);
        color: white;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .card-body {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
    }

    .template-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        line-height: 1.4;
    }

    .template-meta {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .badge {
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        background: var(--bg-page);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .template-preview {
        font-size: 13px;
        color: var(--text-secondary);
        background: var(--bg-page);
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed var(--border-color);
        margin-top: auto;
        line-height: 1.5;
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
    }

    .card-footer {
        padding: 12px 20px;
        background: #f8fafc;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-muted);
    }

    /* --- Create Section --- */
    .create-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 32px;
        display: none; /* Hidden by default */
    }
    
    .create-section.active { display: block; animation: slideDown 0.3s ease-out; }
    
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Modal & Toast --- */
    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .modal-backdrop.active {
        display: flex;
        opacity: 1;
    }

    .modal-panel {
        background: var(--bg-card);
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.2s;
    }

    .modal-backdrop.active .modal-panel {
        transform: scale(1);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.6;
        color: var(--text-main);
        background: #f8fafc;
        margin: 0;
    }

    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: #1e293b;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transition: all 0.3s;
        z-index: 2000;
        box-shadow: var(--shadow-md);
        pointer-events: none;
    }

    .toast.active {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    /* --- Pagination --- */
    .pagination-container {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
    }

    /* --- Empty State --- */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 48px 20px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--border-color);
        color: var(--text-secondary);
    }
    
    @media (max-width: 640px) {
        .filter-grid { grid-template-columns: 1fr; }
        .template-grid { grid-template-columns: 1fr; }
    }
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding-bottom: 40px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 800; color: var(--text-main); margin: 0 0 4px 0;">æ¨¡æ¿ä¸­å¿ƒ / Template Center</h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">ç®¡ç†ä¸å…±äº«æ—¥æŠ¥åŠä»»åŠ¡æ¨¡æ¿</p>
        </div>
        <button class="btn btn-primary" onclick="toggleCreateSection()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            æ–°å»ºæ¨¡æ¿
        </button>
    </div>

    <!-- Create Section (Collapsible) -->
    <div id="createSection" class="create-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="font-size: 18px; font-weight: 700; margin: 0;">æ–°å»ºæ¨¡æ¿ / Create Template</h2>
            <button class="btn btn-ghost btn-sm" onclick="toggleCreateSection()">å…³é—­ / Close</button>
        </div>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchCreateTab('report')">ğŸ“„ æ—¥æŠ¥æ¨¡æ¿ / Report</button>
            <button class="tab-btn" onclick="switchCreateTab('task')">âœ… ä»»åŠ¡æ¨¡æ¿ / Task</button>
        </div>

        <!-- Create Report Form -->
        <div id="create-report" class="tab-content active">
            <form method="post">
                {% csrf_token %}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">æ¨¡æ¿åç§° / Name</label>
                        {{ report_form.name }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">è§’è‰² / Role</label>
                        {{ report_form.role }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›® / Project</label>
                        {{ report_form.project }}
                        <span class="help-text">ç•™ç©ºåˆ™ä¸ºå…¨å±€æ¨¡æ¿ / Leave empty for global</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…±äº« / Shared</label>
                        <div style="display: flex; align-items: center; height: 42px;">
                            {{ report_form.is_shared }} <span style="margin-left: 8px; font-size: 13px;">å…è®¸ä»–äººä½¿ç”¨ / Allow others to use</span>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">æ¨¡æ¿å†…å®¹ / Content</label>
                    {{ report_form.content }}
                    <span class="help-text">æ”¯æŒ Markdown è¯­æ³•</span>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">å ä½ç¬¦é…ç½® / Placeholders (JSON)</label>
                    {{ report_form.placeholders }}
                    <span class="help-text">ä¾‹å¦‚: {"today_work": "..."}</span>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜æ—¥æŠ¥æ¨¡æ¿ / Save Report Template</button>
                </div>
            </form>
        </div>

        <!-- Create Task Form -->
        <div id="create-task" class="tab-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="task">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">æ¨¡æ¿åç§° / Name</label>
                        {{ task_form.name }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æ ‡é¢˜ / Task Title</label>
                        {{ task_form.title }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">è§’è‰² / Role</label>
                        {{ task_form.role }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›® / Project</label>
                        {{ task_form.project }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL é“¾æ¥</label>
                        {{ task_form.url }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…±äº« / Shared</label>
                        <div style="display: flex; align-items: center; height: 42px;">
                            {{ task_form.is_shared }} <span style="margin-left: 8px; font-size: 13px;">å…è®¸ä»–äººä½¿ç”¨</span>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">ä»»åŠ¡æè¿° / Description</label>
                    {{ task_form.content }}
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä»»åŠ¡æ¨¡æ¿ / Save Task Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="filter-grid">
                <div class="form-group" style="flex: 2; min-width: 240px;">
                    <label class="form-label">æœç´¢ / Search</label>
                    <input type="text" name="q" value="{{ q }}" class="form-input" placeholder="æŒ‰åç§°æˆ–å†…å®¹æœç´¢...">
                </div>
                <div class="form-group">
                    <label class="form-label">è§’è‰² / Role</label>
                    <select name="role" class="form-select">
                        <option value="">å…¨éƒ¨ / All</option>
                        {% for val,label in report_form.fields.role.choices %}
                            <option value="{{ val }}" {% if role_filter == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é¡¹ç›® / Project</label>
                    <select name="project" class="form-select">
                        <option value="">å…¨éƒ¨ / All</option>
                        {% for p in projects %}
                            <option value="{{ p.id }}" {% if project_filter == p.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ’åº / Sort</label>
                    <select name="sort" class="form-select" onchange="document.getElementById('filterForm').submit()">
                        <option value="version" {% if sort == 'version' %}selected{% endif %}>ç‰ˆæœ¬ (v)</option>
                        <option value="updated" {% if sort == 'updated' %}selected{% endif %}>æ›´æ–°æ—¶é—´</option>
                        <option value="usage" {% if sort == 'usage' %}selected{% endif %}>ä½¿ç”¨æ¬¡æ•°</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <a href="{% url 'reports:template_center' %}" class="btn btn-ghost">é‡ç½®</a>
                <button type="submit" class="btn btn-secondary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    ç­›é€‰
                </button>
            </div>
        </form>
    </div>

    <!-- 1. Report Templates -->
    <h3 style="font-size: 18px; font-weight: 700; margin: 32px 0 16px; display: flex; align-items: center; gap: 8px;">
        <span>ğŸ“„ æ—¥æŠ¥æ¨¡æ¿</span>
        <span class="badge" style="background: var(--primary-light); color: var(--primary); border: none;">{{ report_templates.paginator.count }}</span>
    </h3>
    
    <div class="template-grid">
        {% for tmpl in report_templates %}
        <article class="template-card {% if report_templates.number == 1 and forloop.first %}new{% endif %}">
            <div class="card-body">
                <div class="card-header-row">
                    <h4 class="template-title">{{ tmpl.name }}</h4>
                    <span class="badge">v{{ tmpl.version }}</span>
                </div>
                <div class="template-meta">
                    <span>{{ tmpl.get_role_display|default:"å…¨éƒ¨è§’è‰²" }}</span>
                    <span>â€¢</span>
                    <span>{{ tmpl.project.name|default:"å…¨å±€é€šç”¨" }}</span>
                </div>
                <div class="template-preview">
                    {{ tmpl.content|truncatechars:150 }}
                </div>
            </div>
            <div class="card-footer">
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-xs" onclick="openPreview('{{ tmpl.name|escapejs }}', `{{ tmpl.content|escapejs }}`)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        é¢„è§ˆ
                    </button>
                    <button class="btn btn-secondary btn-xs" onclick="copyContent(`{{ tmpl.content|escapejs }}`)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        å¤åˆ¶
                    </button>
                </div>
                <div style="text-align: right;">
                    <span style="display: block;">ä½¿ç”¨: {{ tmpl.usage_count|default:0 }}</span>
                    <span style="display: block;">{{ tmpl.created_at|date:"Y-m-d" }}</span>
                </div>
            </div>
        </article>
        {% empty %}
        <div class="empty-state">
            <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 12px; display: block; opacity: 0.5;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            æš‚æ— æ—¥æŠ¥æ¨¡æ¿ / No report templates
        </div>
        {% endfor %}
    </div>

    <!-- Pagination for Reports -->
    {% if report_templates.has_other_pages %}
    <div class="pagination-container">
        {% if report_templates.has_previous %}
            <a href="?rpage={{ report_templates.previous_page_number }}&q={{ q }}&role={{ role_filter }}&project={{ project_filter }}&sort={{ sort }}" class="btn btn-secondary btn-sm">ä¸Šä¸€é¡µ</a>
        {% endif %}
        <span class="btn btn-ghost btn-sm" style="pointer-events: none;">{{ report_templates.number }} / {{ report_templates.paginator.num_pages }}</span>
        {% if report_templates.has_next %}
            <a href="?rpage={{ report_templates.next_page_number }}&q={{ q }}&role={{ role_filter }}&project={{ project_filter }}&sort={{ sort }}" class="btn btn-secondary btn-sm">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- 2. Task Templates -->
    <h3 style="font-size: 18px; font-weight: 700; margin: 48px 0 16px; display: flex; align-items: center; gap: 8px;">
        <span>âœ… ä»»åŠ¡æ¨¡æ¿</span>
        <span class="badge" style="background: var(--primary-light); color: var(--primary); border: none;">{{ task_templates.paginator.count }}</span>
    </h3>

    <div class="template-grid">
        {% for tmpl in task_templates %}
        <article class="template-card {% if task_templates.number == 1 and forloop.first %}new{% endif %}">
            <div class="card-body">
                <div class="card-header-row">
                    <h4 class="template-title">{{ tmpl.name }}</h4>
                    <span class="badge">v{{ tmpl.version }}</span>
                </div>
                <div class="template-meta">
                    <span>{{ tmpl.get_role_display|default:"å…¨éƒ¨è§’è‰²" }}</span>
                    <span>â€¢</span>
                    <span>{{ tmpl.project.name|default:"å…¨å±€é€šç”¨" }}</span>
                </div>
                <div style="font-size: 13px; font-weight: 600; margin-top: 4px;">{{ tmpl.title }}</div>
                <div class="template-preview">
                    {{ tmpl.content|truncatechars:150 }}
                </div>
            </div>
            <div class="card-footer">
                <span>ä½¿ç”¨: {{ tmpl.usage_count|default:0 }}</span>
                <span>{{ tmpl.created_at|date:"Y-m-d" }}</span>
            </div>
        </article>
        {% empty %}
        <div class="empty-state">
            <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 12px; display: block; opacity: 0.5;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            æš‚æ— ä»»åŠ¡æ¨¡æ¿ / No task templates
        </div>
        {% endfor %}
    </div>

    <!-- Pagination for Tasks -->
    {% if task_templates.has_other_pages %}
    <div class="pagination-container">
        {% if task_templates.has_previous %}
            <a href="?tpage={{ task_templates.previous_page_number }}&q={{ q }}&role={{ role_filter }}&project={{ project_filter }}&sort={{ sort }}" class="btn btn-secondary btn-sm">ä¸Šä¸€é¡µ</a>
        {% endif %}
        <span class="btn btn-ghost btn-sm" style="pointer-events: none;">{{ task_templates.number }} / {{ task_templates.paginator.num_pages }}</span>
        {% if task_templates.has_next %}
            <a href="?tpage={{ task_templates.next_page_number }}&q={{ q }}&role={{ role_filter }}&project={{ project_filter }}&sort={{ sort }}" class="btn btn-secondary btn-sm">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-backdrop" onclick="closePreview(event)">
        <div class="modal-panel">
            <div class="modal-header">
                <h3 class="modal-title" id="previewTitle" style="margin: 0; font-size: 16px; font-weight: 700;">æ¨¡æ¿é¢„è§ˆ</h3>
                <button class="btn btn-ghost btn-sm" onclick="closePreview(null, true)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <pre class="modal-body" id="previewContent"></pre>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePreview(null, true)">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyPreviewContent()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    å¤åˆ¶å†…å®¹
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 6px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span>å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
    </div>

</div>

<script>
    // --- Modal & Copy Logic ---
    let currentPreviewContent = '';

    function openPreview(title, content) {
        document.getElementById('previewTitle').textContent = title;
        document.getElementById('previewContent').textContent = content;
        currentPreviewContent = content;
        
        const modal = document.getElementById('previewModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closePreview(e, force) {
        if (force || e.target === document.getElementById('previewModal')) {
            document.getElementById('previewModal').classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    function copyContent(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ / Copied to clipboard');
        }).catch(err => {
            console.error('Copy failed:', err);
            showToast('å¤åˆ¶å¤±è´¥ / Copy failed');
        });
    }

    function copyPreviewContent() {
        copyContent(currentPreviewContent);
        // Optional: close modal after copy
        // closePreview(null, true);
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.querySelector('span').textContent = msg;
        toast.classList.add('active');
        
        // Reset timeout if already active
        if (toast.timeoutId) clearTimeout(toast.timeoutId);
        
        toast.timeoutId = setTimeout(() => {
            toast.classList.remove('active');
        }, 2000);
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreview(null, true);
        }
    });

    function showCreateSection(tab) {
        const section = document.getElementById('createSection');
        section.style.display = 'block';
        section.classList.add('active');
        switchCreateTab(tab);
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if report_form.errors %}
            showCreateSection('report');
        {% elif task_form.errors %}
            showCreateSection('task');
        {% endif %}
    });

    function toggleCreateSection() {
        const section = document.getElementById('createSection');
        if (section.style.display === 'block') {
            section.style.display = 'none';
        } else {
            section.style.display = 'block';
            section.classList.add('active');
        }
    }

    function switchCreateTab(type) {
        // Buttons
        document.querySelectorAll('.create-section .tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.create-section .tab-btn[onclick="switchCreateTab('${type}')"]`).classList.add('active');
        
        // Content
        document.querySelectorAll('.create-section .tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`create-${type}`).classList.add('active');
    }
</script>
{% endblock %}
