{% extends "base_topbar.html" %}
{% load tz %}
{% block title %}å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥ / Team Daily Report{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="å›¢é˜Ÿåœ¨çº¿æ—¥æŠ¥" nav_subtitle="é€‚ç”¨äº Dev / QA / PM / UI / Ops / ç®¡ç†" %}{% endblock %}
{% block extra_styles %}
        :root {
            --primary: #2563eb;
            --primary-2: #3b82f6;
            --accent: #06b6d4;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-section: rgba(248, 250, 252, 0.8);
            --border-light: rgba(226, 232, 240, 0.6);
            --border-hover: rgba(59, 130, 246, 0.3);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-radius: 16px;
            --card-spacing: 16px;
            --shadow-sm: 0 4px 20px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 8px 28px rgba(15, 23, 42, 0.1);
            --shadow-lg: 0 12px 40px rgba(15, 23, 42, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--ink);
            line-height: 1.6;
        }

        .hero { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light); 
            border-radius: var(--border-radius); 
            padding: 32px 36px; 
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.1); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
            opacity: 0.9;
        }
        
        .hero::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .hero-content {
            display: flex;
            align-items: center;
            gap: 40px;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        
        .hero-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .hero .eyebrow {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin: 0;
        }

        .hero-content h1 {
            margin: 0;
            font-size: clamp(26px, 3.5vw, 32px);
            font-weight: 800;
            background: linear-gradient(135deg, var(--text-primary), #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .hero-content .lede {
            margin: 0;
            color: var(--text-muted);
            font-size: 15px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .hero-meta { 
            display: grid; 
            gap: 12px; 
            justify-items: end;
            position: relative;
            z-index: 1;
        }
        .chip {
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            padding: 12px 18px;
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(6, 182, 212, 0.08));
            font-size: 13px; 
            color: var(--primary);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.25);
        }
        
        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 20px;
            align-items: start;
        }
        
        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(16px);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            padding: 28px 30px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 0.8;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            gap: 16px; 
            margin-bottom: 20px; 
        }
        
        .card-title { 
            font-weight: 800; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            color: var(--text-primary);
        }
        
        .card-title .dot {
            width: 36px; 
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            color: var(--primary);
            display: grid; 
            place-items: center;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.2);
        }
        
        .card-subtitle { 
            color: var(--text-muted); 
            font-size: 13px;
            font-weight: 500;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .required { 
            color: var(--danger); 
            font-weight: 800;
        }
        
        input, select, textarea {
            width: 100%;
            margin-top: 6px;
            border-radius: 14px;
            border: 1px solid var(--border-light);
            padding: 14px 16px;
            font-size: 14px;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.6));
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            position: relative;
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        input:focus::placeholder, textarea:focus::placeholder {
            opacity: 0.4;
        }
        
        select { 
            appearance: none; 
            background-image: linear-gradient(45deg, transparent 50%, var(--text-muted) 50%), linear-gradient(135deg, var(--text-muted) 50%, transparent 50%); 
            background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%; 
            background-size: 6px 6px; 
            background-repeat: no-repeat; 
            cursor: pointer;
        }
        
        select:hover {
            background-color: rgba(248, 250, 252, 0.9);
        }
        
        textarea { 
            border-radius: 14px; 
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit; 
            line-height: 1.6; 
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12), 0 4px 16px rgba(59, 130, 246, 0.15);
            background: rgba(255, 255, 255, 0.98);
            transform: translateY(-2px) scale(1.01);
        }
        .section { margin-bottom: 16px; }
        .section-heading { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 13px; font-weight: 700; }
        .section-hint { font-size: 11px; color: var(--muted); }
        .role-hints { display: flex; flex-wrap: wrap; gap: 6px; font-size: 11px; color: var(--muted); }
        .role-hints span {
            padding: 4px 9px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.03);
            border: 1px dashed rgba(148, 163, 184, 0.7);
        }
        .btn-row {
            display: flex; flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }
        button {
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 14px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        button:hover::before {
            left: 100%;
        }
        button:active::after {
            width: 300px;
            height: 300px;
        }
        button:hover { 
            transform: translateY(-2px) scale(1.02);
            filter: brightness(1.05);
        }
        button:active { 
            transform: translateY(0px) scale(0.98);
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-2)); 
            color: #ffffff; 
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 12px 28px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #e5e7eb, #d1d5db); 
            color: #374151;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        .btn-ghost { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(6, 182, 212, 0.08)); 
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        .btn-ghost:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            border-color: rgba(59, 130, 246, 0.25);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.15);
        }
        .preview-card { 
            position: sticky; 
            top: 86px; 
        }
        
        .preview-area {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            color: var(--text-primary);
            border-radius: var(--border-radius);
            padding: 24px 26px;
            max-height: 600px;
            overflow: auto;
            border: 1px solid var(--border-light);
            box-shadow: inset 0 2px 8px rgba(59, 130, 246, 0.05), var(--shadow-md);
            position: relative;
        }
        
        .preview-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
            opacity: 0.8;
        }
        
        .preview-body { 
            font-size: 14px; 
            line-height: 1.65; 
            color: var(--text-primary); 
        }
        
        .preview-body h2, .preview-body h3, .preview-body h4 { 
            margin: 12px 0 8px; 
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .preview-body p { 
            margin: 8px 0; 
        }
        
        .preview-body ul { 
            padding-left: 20px; 
            margin: 8px 0; 
        }
        
        .preview-body li { 
            margin: 6px 0; 
        }
        .pill-badge {
            display: inline-flex; 
            align-items: center;
            padding: 8px 16px;
            border-radius: 14px;
            font-size: 11px;
            letter-spacing: 0.08em;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15));
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 700;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .status-bar {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-top: 12px; 
            font-size: 12px; 
            color: var(--text-muted);
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }
        
        .status-left { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .status-dot {
            width: 12px; 
            height: 12px; 
            border-radius: 999px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.16);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .toast {
            position: fixed; 
            bottom: 24px; 
            right: 24px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
            backdrop-filter: blur(16px);
            color: #e5e7eb;
            padding: 14px 20px; 
            border-radius: var(--border-radius);
            font-size: 13px; 
            display: none; 
            align-items: center; 
            gap: 10px;
            z-index: 50;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3), 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.2);
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .toast.show { 
            display: inline-flex; 
        }
        
        @media (max-width: 1080px) {
            .layout { 
                grid-template-columns: minmax(0, 1fr); 
            }
            .preview-card { 
                position: static; 
            }
        }
        
        @media (max-width: 860px) {
            .hero { 
                flex-direction: column; 
                gap: 24px;
                text-align: center;
            }
            .hero-content {
                flex-direction: column;
                gap: 16px;
            }
            .hero-meta { 
                justify-content: center;
                width: 100%;
            }
            .form-grid { 
                grid-template-columns: minmax(0, 1fr); 
            }
        }
        
        @media (max-width: 520px) {
            .btn-row { 
                justify-content: stretch; 
            }
            .btn-row button { 
                flex: 1 1 45%; 
                justify-content: center; 
            }
        }
{% endblock %}

{% block content %}
        {% if errors %}
        <div style="margin-bottom:10px;">
            <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.18);color:#991b1b;padding:10px 12px;border-radius:12px;font-size:12px;">
                {% for e in errors %}<div>{{ e }}</div>{% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="hero">
            <div>
                <p class="eyebrow">Daily cadence</p>
                <h1>{% if editing %}ç¼–è¾‘æ—¥æŠ¥{% else %}å¡«å†™æ—¥æŠ¥{% endif %}</h1>
                <p class="lede">å·¦ä¾§å¡«å†™ï¼Œå³ä¾§å®æ—¶é¢„è§ˆã€‚é€‚åˆå¤åˆ¶åˆ°ç¾¤èŠæˆ–å†…éƒ¨ç³»ç»Ÿã€‚</p>
            </div>
            <div class="hero-meta">
                <span class="chip">å½“å‰ç”¨æˆ· / Userï¼š{{ request.user.get_full_name|default:request.user.username }}</span>
                <span class="chip">æ—¶åŒº / Timezoneï¼š{% get_current_timezone as CURRENT_TZ %}{{ CURRENT_TZ }}</span>
                <span class="chip">å»ºè®®ï¼šæ¯é¡¹ 3â€“8 æ¡è¦ç‚¹ï¼Œèšç„¦è¿›å±•ã€é£é™©ã€æ˜æ—¥è¡ŒåŠ¨ã€‚</span>
            </div>
        </div>

        <form method="post" action="">
            {% csrf_token %}
            {% if report_id %}<input type="hidden" name="report_id" value="{{ report_id }}">{% endif %}
            <div class="layout">
                <section class="card form-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="dot">âœï¸</span>
                            å¡«å†™æ—¥æŠ¥ / Fill Daily Report
                        </div>
                        <div class="card-subtitle">
                            å…³é”®è¿›å±•ã€é£é™©ã€æ˜æ—¥è®¡åˆ’ï¼Œä¸€å±å®Œæˆ
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-heading">
                            <span>åŸºæœ¬ä¿¡æ¯ / Basic Information</span>
                            <span class="section-hint">å§“åã€æ—¥æœŸã€è§’è‰²ä¸ºå¿…å¡«</span>
                        </div>
                        <div class="form-grid">
                            <div>
                                <label>å§“å / Name <span class="required">*</span></label>
                                <input type="text" id="name"
                                       value="{{ form_user.get_full_name|default:form_user.username }}" readonly disabled
                                       title="å§“åå–ç™»å½•ç”¨æˆ·ï¼Œå¦‚éœ€ä¿®æ”¹è¯·åœ¨è´¦æˆ·ä¿¡æ¯ä¸­æ›´æ–°" />
                            </div>
                            <div>
                                <label>æ—¥æœŸ / Date <span class="required">*</span></label>
                                <input type="date" id="date" name="date" value="{{ date_value|default:'' }}" />
                            </div>
                            <div>
                                <label>è§’è‰² / Role <span class="required">*</span></label>
                                <select id="role" name="role">
                                    <option value="">è¯·é€‰æ‹©è§’è‰² / Select Role</option>
                                    {% with current_role=role_value|default:user_position %}
                                        <option value="dev" {% if current_role == 'dev' %}selected{% endif %}>å¼€å‘ / Developer</option>
                                        <option value="qa" {% if current_role == 'qa' %}selected{% endif %}>æµ‹è¯• / QA</option>
                                        <option value="pm" {% if current_role == 'pm' %}selected{% endif %}>äº§å“ / Product Manager</option>
                                        <option value="ui" {% if current_role == 'ui' %}selected{% endif %}>è®¾è®¡ / UI / UX</option>
                                        <option value="ops" {% if current_role == 'ops' %}selected{% endif %}>è¿ç»´ / Ops</option>
                                        <option value="mgr" {% if current_role == 'mgr' %}selected{% endif %}>é¡¹ç›®ç®¡ç† / PM / PMO</option>
                                    {% endwith %}
                                </select>
                            </div>
                            <div>
                                <label>é¡¹ç›®ï¼ˆå¯å¤šé€‰ï¼‰ / Projects (multi-select)</label>
                                <input id="project-filter" type="text" placeholder="æœ¬åœ°è¿‡æ»¤å½“å‰åˆ—è¡¨" style="margin-bottom:6px;width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);">
                                <input id="project-typeahead" list="project-options" type="text" placeholder="è¿œç¨‹æœç´¢é¡¹ç›®å¹¶åŠ å…¥åˆ—è¡¨" style="margin-bottom:6px;width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);">
                                <datalist id="project-options"></datalist>
                                <select id="projects" name="projects" multiple size="4" style="min-height:116px;">
                                    {% for p in projects %}
                                        <option value="{{ p.id }}" {% if p.id in selected_project_ids %}selected{% endif %}>{{ p.name }}ï¼ˆ{{ p.code }}ï¼‰</option>
                                    {% empty %}
                                        <option disabled>æš‚æ— é¡¹ç›®ï¼Œè¯·ç®¡ç†å‘˜åˆ›å»º</option>
                                    {% endfor %}
                                </select>
                                <div class="section-hint">è¿œç¨‹æœç´¢è¾“å…¥åé€‰æ‹©å»ºè®®ï¼Œè‡ªåŠ¨åŠ å…¥åˆ—è¡¨ï¼›æŒ‰ä½ Ctrl/âŒ˜ å¯å¤šé€‰ã€‚</div>
                            </div>
                        </div>
                        <div class="role-hints">
                            <span>å¼€å‘ï¼šä»Šæ—¥å®Œæˆã€è¿›åº¦ã€é—®é¢˜ã€æ˜æ—¥è®¡åˆ’</span>
                            <span>æµ‹è¯•ï¼šæµ‹è¯•èŒƒå›´ã€ç”¨ä¾‹å®Œæˆã€Bug ç»Ÿè®¡ã€å›å½’è®¡åˆ’</span>
                            <span>è¿ç»´ï¼šç›‘æ§ã€æ•…éšœå¤„ç†ã€å˜æ›´è®°å½•</span>
                        </div>
                        <div id="template-hint" class="section-hint" style="margin-top:4px;">å¯åœ¨â€œè§’è‰²æ¨¡æ¿ç®¡ç†â€é…ç½®æç¤ºä¸å ä½</div>
                    </div>

                    <div id="role-dev" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading">
                                <span>1. ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)</span>
                            </div>
                            <textarea id="dev-today" name="today_work" placeholder="æŒ‰è¦ç‚¹å¡«å†™ï¼Œç¤ºä¾‹ï¼šå®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘">{{ initial_values.today_work|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading">
                                <span>2. ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today</span>
                            </div>
                            <textarea id="dev-progress" name="progress_issues" placeholder="é£é™©ã€é˜»å¡ç‚¹ã€éœ€è¦ååŠ©çš„äº‹é¡¹">{{ initial_values.progress_issues|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading">
                                <span>3. æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow</span>
                            </div>
                            <textarea id="dev-tomorrow" name="tomorrow_plan" placeholder="æ˜æ—¥è®¡åˆ’çš„å¯äº¤ä»˜ç‰©æˆ–éªŒè¯ç›®æ ‡">{{ initial_values.tomorrow_plan|default:'' }}</textarea>
                        </div>
                    </div>

                    <div id="role-qa" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading">
                                <span>1. ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Todayâ€™s Testing Scope</span>
                            </div>
                            <textarea id="qa-scope" name="testing_scope" placeholder="ç¤ºä¾‹ï¼šæ–°å¢åŠŸèƒ½ç”¨ä¾‹ 3 æ¡ï¼›æ ¸å¿ƒæµç¨‹å›å½’ 3 æ¡ï¼›è¦†ç›–æ¨¡å—/åœºæ™¯åˆ—è¡¨">{{ initial_values.testing_scope|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading">
                                <span>2. æµ‹è¯•å®Œæˆæƒ…å†µ / Testing Progress</span>
                            </div>
                            <textarea id="qa-progress" name="testing_progress" placeholder="ç¤ºä¾‹ï¼šè¿›åº¦ 40%ï¼›é€šè¿‡/å¤±è´¥/é˜»å¡ï¼›æ–°å¢/å›å½’æ‰§è¡Œæ•°ï¼›ç¯å¢ƒçŠ¶æ€">{{ initial_values.testing_progress|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading">
                                <span>3. Bug ç»Ÿè®¡ / Bug Summary</span>
                            </div>
                            <textarea id="qa-bugs" name="bug_summary" placeholder="ç¤ºä¾‹ï¼šå¾…è§£å†³ 20ï¼Œå»¶æœŸ 5ï¼›æ–°å¢/å…³é—­è¶‹åŠ¿ï¼›é«˜ä¼˜/ä¸­ä¼˜/ä½ä¼˜åˆ†å¸ƒ">{{ initial_values.bug_summary|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading">
                                <span>4. æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan for Tomorrow</span>
                            </div>
                            <textarea id="qa-tomorrow" name="testing_tomorrow" placeholder="ç¤ºä¾‹ï¼šç›®æ ‡è¿›åº¦ 70%ï¼›å›å½’/æ–°å¢ç”¨ä¾‹æ•°ï¼›ç¼ºé™·æ”¶æ•›ç›®æ ‡ï¼›ä¾èµ–ä¸æ”¯æŒ">{{ initial_values.testing_tomorrow|default:'' }}</textarea>
                        </div>
                    </div>

                    <div id="role-pm" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading"><span>1. ä»Šæ—¥äº§å“æ¨è¿›å†…å®¹ / Product Progress Today</span></div>
                            <textarea id="pm-today" name="product_today">{{ initial_values.product_today|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>2. ä»Šæ—¥åè°ƒ / å†³ç­–äº‹é¡¹ / Coordination & Decisions</span></div>
                            <textarea id="pm-coord" name="product_coordination">{{ initial_values.product_coordination|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>3. æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow</span></div>
                            <textarea id="pm-tomorrow" name="product_tomorrow">{{ initial_values.product_tomorrow|default:'' }}</textarea>
                        </div>
                    </div>

                    <div id="role-ui" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading"><span>1. ä»Šæ—¥å®Œæˆè®¾è®¡ / Designs Completed Today</span></div>
                            <textarea id="ui-today" name="ui_today">{{ initial_values.ui_today|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>2. åé¦ˆä¸ä¿®æ”¹ / Feedback & Revisions</span></div>
                            <textarea id="ui-feedback" name="ui_feedback">{{ initial_values.ui_feedback|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>3. æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow</span></div>
                            <textarea id="ui-tomorrow" name="ui_tomorrow">{{ initial_values.ui_tomorrow|default:'' }}</textarea>
                        </div>
                    </div>

                    <div id="role-ops" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading"><span>1. ä»Šæ—¥è¿ç»´å·¥ä½œ / Operations Tasks Today</span></div>
                            <textarea id="ops-today" name="ops_today">{{ initial_values.ops_today|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>2. ç›‘æ§ä¸æ•…éšœæƒ…å†µ / Monitoring & Incidents</span></div>
                            <textarea id="ops-monitor" name="ops_monitoring">{{ initial_values.ops_monitoring|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>3. æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow</span></div>
                            <textarea id="ops-tomorrow" name="ops_tomorrow">{{ initial_values.ops_tomorrow|default:'' }}</textarea>
                        </div>
                    </div>

                    <div id="role-mgr" class="role-section" style="display:none;">
                        <div class="section">
                            <div class="section-heading"><span>1. ä»Šæ—¥é¡¹ç›®è¿›åº¦æ¦‚è§ˆ / Project Progress Overview</span></div>
                            <textarea id="mgr-progress" name="mgr_progress">{{ initial_values.mgr_progress|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>2. é£é™©ä¸é˜»å¡ç‚¹ / Risks & Blockers</span></div>
                            <textarea id="mgr-risk" name="mgr_risks">{{ initial_values.mgr_risks|default:'' }}</textarea>
                        </div>
                        <div class="section">
                            <div class="section-heading"><span>3. æ˜æ—¥æ¨è¿›é‡ç‚¹ / Key Focus for Tomorrow</span></div>
                            <textarea id="mgr-tomorrow" name="mgr_tomorrow">{{ initial_values.mgr_tomorrow|default:'' }}</textarea>
                        </div>
                    </div>

                    <div class="btn-row">
                        <button type="button" class="btn-ghost" id="btn-clear">é‡ç½®è¡¨å• / Reset</button>
                        <button type="button" class="btn-secondary" id="btn-sample">å¡«å…¥ç¤ºä¾‹ / Sample</button>
                        <button type="button" class="btn-primary" id="btn-generate">ç”Ÿæˆæ—¥æŠ¥å†…å®¹ / Generate</button>
                        <button type="submit" name="submit_action" value="draft" class="btn-secondary">{% if editing %}ä¿å­˜è‰ç¨¿{% else %}ä¿å­˜è‰ç¨¿{% endif %}</button>
                        <button type="submit" name="submit_action" value="submit" class="btn-primary">{% if editing %}æ›´æ–°å¹¶æäº¤{% else %}ä¿å­˜æ—¥æŠ¥ / Save{% endif %}</button>
                    </div>
                </section>

                <section class="card preview-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="dot">ğŸ“„</span>
                            æ—¥æŠ¥é¢„è§ˆ / Daily Report Preview
                        </div>
                        <div class="card-subtitle">
                            å¡«å†™åç”Ÿæˆï¼Œå¯ç›´æ¥å¤åˆ¶åˆ° IM / ç³»ç»Ÿ
                        </div>
                    </div>
                    <div class="preview-area" id="preview">
                        <div class="pill-badge">No Report Generated</div>
                        <div class="preview-body" id="preview-body">
                            <p>ç¤ºä¾‹ç”¨æˆ·ï¼Œ2024 å¹´ 01 æœˆ 01 æ—¥å·¥ä½œæŠ¥å‘Š</p>
                            <p><strong>ã€åŸºæœ¬ä¿¡æ¯ / Basic Infoã€‘</strong><br>
                            å§“å / Nameï¼šç¤ºä¾‹ / Sample<br>
                            æ—¥æœŸ / Dateï¼šYYYY-MM-DD<br>
                            è§’è‰² / Roleï¼šè§’è‰² / Role<br>
                            é¡¹ç›® / Projectï¼šæœªé€‰æ‹© / None</p>
                            <p>è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯åï¼Œç‚¹å‡»ã€Œç”Ÿæˆæ—¥æŠ¥å†…å®¹ã€ã€‚<br>
                            Please fill in the form on the left and click "Generate Report".</p>
                        </div>
                    </div>
                    <div class="status-bar">
                        <div class="status-left">
                            <span class="status-dot"></span>
                            <span id="status-text">ç­‰å¾…ç”Ÿæˆæ—¥æŠ¥â€¦ / Waiting to generate reportâ€¦</span>
                        </div>
                        <div>
                            <button type="button" class="btn-secondary" id="btn-copy">å¤åˆ¶æ—¥æŠ¥å†…å®¹ / Copy</button>
                        </div>
                    </div>
                </section>
            </div>
        </form>

<div class="toast" id="toast">
    <span class="toast-icon">âœ…</span>
    <span id="toast-text">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ / Copied to clipboard</span>
</div>

<script>
    (function setToday() {
        const input = document.getElementById('date');
        if (input && !input.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            input.value = `${yyyy}-${mm}-${dd}`;
        }
    })();

    const roleSelect = document.getElementById('role');
    const projectFilterInput = document.getElementById('project-filter');
    const projectTypeahead = document.getElementById('project-typeahead');
    const projectOptions = document.getElementById('project-options');
    const dateInput = document.getElementById('date');
    const nameInput = document.getElementById('name');
    const initialRoleValue = roleSelect ? roleSelect.value : '';
    const initialDateValue = dateInput ? dateInput.value : '';
    const initialNameValue = nameInput ? nameInput.value : '';
    const templateHint = document.getElementById('template-hint');
    const templateApi = "{% url 'reports:role_template_api' %}";
    const projectApi = "{% url 'reports:project_search_api' %}";
    const roleSections = {
        dev: document.getElementById('role-dev'),
        qa: document.getElementById('role-qa'),
        pm: document.getElementById('role-pm'),
        ui: document.getElementById('role-ui'),
        ops: document.getElementById('role-ops'),
        mgr: document.getElementById('role-mgr'),
    };
    const roleLabels = {
        dev: 'å¼€å‘ / Developer',
        qa: 'æµ‹è¯• / QA',
        pm: 'äº§å“ / Product Manager',
        ui: 'è®¾è®¡ / UI / UX',
        ops: 'è¿ç»´ / Ops',
        mgr: 'é¡¹ç›®ç®¡ç† / PM / PMO',
    };
    const roleFields = {
        dev: ['dev-today','dev-progress','dev-tomorrow'],
        qa: ['qa-scope','qa-progress','qa-bugs','qa-tomorrow'],
        pm: ['pm-today','pm-coord','pm-tomorrow'],
        ui: ['ui-today','ui-feedback','ui-tomorrow'],
        ops: ['ops-today','ops-monitor','ops-tomorrow'],
        mgr: ['mgr-progress','mgr-risk','mgr-tomorrow'],
    };
    const preview = document.getElementById('preview');
    const statusText = document.getElementById('status-text');
    const previewBody = document.getElementById('preview-body');
    const STORAGE_KEY = "daily_report_draft_{{ request.user.username|escapejs }}";

    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };
    const formatDateCN = (dateStr) => {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const [y, m, d] = parts;
            return `${y} å¹´ ${parseInt(m, 10)} æœˆ ${parseInt(d, 10)} æ—¥`;
        }
        return dateStr;
    };

    function updateRoleVisibility() {
        const value = roleSelect ? roleSelect.value : '';
        Object.entries(roleSections).forEach(([key, el]) => {
            if (!el) return;
            el.style.display = key === value ? 'block' : 'none';
        });
    }
    function applyPlaceholders(role, placeholders) {
        const fields = roleFields[role] || [];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el && placeholders[id]) {
                el.placeholder = placeholders[id];
            }
        });
    }
    async function loadRoleTemplate(role) {
        if (!role) return;
        try {
            const res = await fetch(`${templateApi}?role=${encodeURIComponent(role)}`);
            if (!res.ok) return;
            const data = await res.json();
            applyPlaceholders(role, data.placeholders || {});
            if (templateHint) {
                const updated = data.updated_at ? `ï¼ˆæ›´æ–°äº ${data.updated_at.substring(0,16).replace('T',' ')}ï¼‰` : '';
                templateHint.textContent = (data.hint || 'ä½¿ç”¨é»˜è®¤æç¤º') + updated;
            }
        } catch (e) {
            // ignore network errors
        }
    }
    if (roleSelect) {
        roleSelect.addEventListener('change', () => {
            updateRoleVisibility();
            loadRoleTemplate(roleSelect.value);
        });
        updateRoleVisibility();
        loadRoleTemplate(roleSelect.value);
    }

    function showToast(text) {
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toast-text');
        toastText.textContent = text;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 2000);
    }

    function filterProjects() {
        const select = document.getElementById('projects');
        const query = (projectFilterInput ? projectFilterInput.value : '').toLowerCase();
        if (!select) return;
        Array.from(select.options).forEach(opt => {
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(query) ? '' : 'none';
        });
    }
    if (projectFilterInput) {
        projectFilterInput.addEventListener('input', filterProjects);
    }
    async function fetchProjects(q) {
        if (!projectOptions) return;
        projectOptions.innerHTML = '';
        try {
            const res = await fetch(`${projectApi}?q=${encodeURIComponent(q)}`);
            if (!res.ok) return;
            const data = await res.json();
            (data.results || []).forEach(item => {
                const opt = document.createElement('option');
                opt.value = `${item.name}ï¼ˆ${item.code}ï¼‰`;
                opt.dataset.id = item.id;
                projectOptions.appendChild(opt);
            });
        } catch (e) {
            // ignore network errors
        }
    }
    function addProjectFromTypeahead() {
        if (!projectTypeahead) return;
        const text = projectTypeahead.value;
        const match = Array.from(projectOptions.options).find(o => o.value === text);
        if (!match) return;
        const projectId = match.dataset.id;
        const select = document.getElementById('projects');
        if (!select) return;
        let opt = Array.from(select.options).find(o => o.value === projectId);
        if (!opt) {
            opt = document.createElement('option');
            opt.value = projectId;
            opt.textContent = text;
            select.appendChild(opt);
        }
        opt.selected = true;
        projectTypeahead.value = '';
    }
    if (projectTypeahead) {
        projectTypeahead.addEventListener('input', (e) => {
            const q = e.target.value;
            if (q && q.length >= 1) fetchProjects(q);
        });
        projectTypeahead.addEventListener('change', addProjectFromTypeahead);
    }

    function validateDailyForm(submitterValue) {
        if (submitterValue === 'draft') return true; // è‰ç¨¿ä¸å¼ºåˆ¶æ ¡éªŒ
        const dateVal = dateInput ? dateInput.value : '';
        const roleVal = roleSelect ? roleSelect.value : '';
        if (!dateVal || !roleVal) {
            showToast('è¯·å¡«å†™æ—¥æœŸå¹¶é€‰æ‹©è§’è‰²');
            return false;
        }
        const fields = roleFields[roleVal] || [];
        const hasContent = fields.some(id => {
            const el = document.getElementById(id);
            return el && el.value.trim().length > 0;
        });
        if (!hasContent) {
            showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå½“å‰è§’è‰²çš„å†…å®¹å­—æ®µ');
            return false;
        }
        return true;
    }

    const formEl = document.querySelector('form');
    const isEditing = !!document.querySelector('input[name="report_id"]');
    const saveDraft = () => {
        if (!formEl) return;
        const data = {};
        formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
            if (el.multiple) {
                data[el.name] = Array.from(el.selectedOptions).map(o => o.value);
            } else {
                data[el.name] = el.value;
            }
        });
        data._ts = Date.now();
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            // ignore storage errors
        }
    };
    const restoreDraft = () => {
        if (!formEl) return;
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
                if (!(el.name in data)) return;
                if (el.multiple) {
                    const hasSelected = Array.from(el.options).some(o => o.selected);
                    if (hasSelected) return;
                    const target = data[el.name] || [];
                    Array.from(el.options).forEach(o => { o.selected = target.includes(o.value); });
                } else {
                    if (el.value) return;
                    el.value = data[el.name] || '';
                }
            });
            updateRoleVisibility();
        } catch (e) {
            return;
        }
    };
    const debounce = (fn, delay = 400) => {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    };
    const debouncedSave = debounce(saveDraft, 400);
    if (formEl) {
        restoreDraft();
        formEl.addEventListener('input', debouncedSave);
        formEl.addEventListener('change', debouncedSave);
        formEl.addEventListener('submit', (e) => {
            const submitValue = e.submitter ? e.submitter.value : '';
            if (!validateDailyForm(submitValue)) {
                e.preventDefault();
                return;
            }
            localStorage.removeItem(STORAGE_KEY);
        });
    }

    function markdownToHtml(text) {
        // è½»é‡ Markdown æ¸²æŸ“ï¼Œæ”¯æŒæ ‡é¢˜ä¸æ— åºåˆ—è¡¨
        const escape = (s) => s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        const lines = (text || '').split(/\n/);
        let html = '';
        let inList = false;
        lines.forEach(raw => {
            const line = raw.trimEnd();
            if (/^\s*[-*]\s+/.test(line)) {
                if (!inList) { html += '<ul>'; inList = true; }
                html += `<li>${escape(line.replace(/^\s*[-*]\s+/, ''))}</li>`;
                return;
            }
            if (inList) { html += '</ul>'; inList = false; }
            if (/^#{1,3}\s+/.test(line)) {
                const level = Math.min(line.match(/^#+/)[0].length, 3);
                const tag = level === 1 ? 'h2' : level === 2 ? 'h3' : 'h4';
                html += `<${tag}>${escape(line.replace(/^#{1,3}\s+/, ''))}</${tag}>`;
            } else if (line === '') {
                html += '<br>';
            } else {
                html += `<p>${escape(line)}</p>`;
            }
        });
        if (inList) html += '</ul>';
        return html || '<p>æš‚æ— å†…å®¹</p>';
    }

    function renderPreview(text, badgeLabel) {
        if (!preview || !previewBody) return;
        preview.innerHTML = '';
        const badge = document.createElement('div');
        badge.className = 'pill-badge';
        badge.textContent = badgeLabel;
        const body = document.createElement('div');
        body.className = 'preview-body';
        body.innerHTML = markdownToHtml(text);
        preview.appendChild(badge);
        preview.appendChild(body);
    }

    function generateReport() {
        const projectSelect = document.getElementById('projects');
        const name = (nameInput ? nameInput.value : '').trim();
        const date = dateInput ? dateInput.value : '';
        const role = roleSelect ? roleSelect.value : '';
        const projectNames = Array.from(projectSelect ? projectSelect.selectedOptions : [])
            .map(opt => opt.textContent.trim())
            .filter(Boolean);
        if (!name || !date || !role) {
            showToast('è¯·å…ˆå¡«å†™å§“åã€æ—¥æœŸå’Œè§’è‰² / Please fill in name, date and role');
            return '';
        }

        const lines = [
            `${name}ï¼Œ${formatDateCN(date)} å·¥ä½œæŠ¥å‘Š`,
            '',
            'ã€åŸºæœ¬ä¿¡æ¯ / Basic Infoã€‘',
            `å§“å / Nameï¼š${name}`,
            `æ—¥æœŸ / Dateï¼š${date}`,
            `è§’è‰² / Roleï¼š${roleLabels[role] || role}`,
            `é¡¹ç›® / Projectï¼š${projectNames.length ? projectNames.join('ï¼Œ') : 'æœªé€‰æ‹© / None'}`,
            '',
        ];
        const addSection = (title, value) => {
            lines.push(title, value || '- ï¼ˆå¾…å¡«å†™ / To be filledï¼‰', '');
        };

        if (role === 'dev') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)', getValue('dev-today'));
            addSection('äºŒã€ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today', getValue('dev-progress'));
            addSection('ä¸‰ã€æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow', getValue('dev-tomorrow'));
        } else if (role === 'qa') {
            addSection('ä¸€ã€ä»Šæ—¥æµ‹è¯•èŒƒå›´ / Todayâ€™s Testing Scope', getValue('qa-scope'));
            addSection('äºŒã€æµ‹è¯•å®Œæˆæƒ…å†µ / Testing Progress', getValue('qa-progress'));
            addSection('ä¸‰ã€Bug ç»Ÿè®¡ / Bug Summary', getValue('qa-bugs'));
            addSection('å››ã€æ˜æ—¥æµ‹è¯•è®¡åˆ’ / Plan for Tomorrow', getValue('qa-tomorrow'));
        } else if (role === 'pm') {
            addSection('ä¸€ã€ä»Šæ—¥äº§å“æ¨è¿›å†…å®¹ / Product Progress Today', getValue('pm-today'));
            addSection('äºŒã€ä»Šæ—¥åè°ƒ / å†³ç­–äº‹é¡¹ / Coordination & Decisions', getValue('pm-coord'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('pm-tomorrow'));
        } else if (role === 'ui') {
            addSection('ä¸€ã€ä»Šæ—¥å®Œæˆè®¾è®¡ / Designs Completed Today', getValue('ui-today'));
            addSection('äºŒã€åé¦ˆä¸ä¿®æ”¹ / Feedback & Revisions', getValue('ui-feedback'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ui-tomorrow'));
        } else if (role === 'ops') {
            addSection('ä¸€ã€ä»Šæ—¥è¿ç»´å·¥ä½œ / Operations Tasks Today', getValue('ops-today'));
            addSection('äºŒã€ç›‘æ§ä¸æ•…éšœæƒ…å†µ / Monitoring & Incidents', getValue('ops-monitor'));
            addSection('ä¸‰ã€æ˜æ—¥è®¡åˆ’ / Plan for Tomorrow', getValue('ops-tomorrow'));
        } else if (role === 'mgr') {
            addSection('ä¸€ã€ä»Šæ—¥é¡¹ç›®è¿›åº¦æ¦‚è§ˆ / Project Progress Overview', getValue('mgr-progress'));
            addSection('äºŒã€é£é™©ä¸é˜»å¡ç‚¹ / Risks & Blockers', getValue('mgr-risk'));
            addSection('ä¸‰ã€æ˜æ—¥æ¨è¿›é‡ç‚¹ / Key Focus for Tomorrow', getValue('mgr-tomorrow'));
        }

        return lines.join('\n');
    }

    const btnGenerate = document.getElementById('btn-generate');
    if (btnGenerate) {
        btnGenerate.addEventListener('click', () => {
            const report = generateReport();
            if (!report) return;
            renderPreview(report, 'Generated Â· å·²ç”Ÿæˆ');
            if (statusText) {
                statusText.textContent = 'å·²ç”Ÿæˆæ—¥æŠ¥ï¼Œå¯å¤åˆ¶ã€‚ / Report generated, you can copy it.';
            }
        });
    }

    const btnCopy = document.getElementById('btn-copy');
    if (btnCopy) {
        btnCopy.addEventListener('click', async () => {
            const body = preview ? preview.querySelector('.preview-body') : null;
            if (!body) {
                showToast('å½“å‰æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥æŠ¥å†…å®¹ / No report content to copy');
                return;
            }
            try {
                await navigator.clipboard.writeText(body.textContent);
                showToast('æ—¥æŠ¥å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ / Report copied to clipboard');
            } catch (e) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ / Copy failed, copy manually');
            }
        });
    }

    const btnClear = document.getElementById('btn-clear');
    if (btnClear) {
        btnClear.addEventListener('click', () => {
            if (!confirm('ç¡®è®¤é‡ç½®è¡¨å•å†…å®¹ï¼Ÿ / Confirm reset form?')) return;
            const idsToClear = [
                'dev-today','dev-progress','dev-tomorrow',
                'qa-scope','qa-progress','qa-bugs','qa-tomorrow',
                'pm-today','pm-coord','pm-tomorrow',
                'ui-today','ui-feedback','ui-tomorrow',
                'ops-today','ops-monitor','ops-tomorrow',
                'mgr-progress','mgr-risk','mgr-tomorrow'
            ];
            idsToClear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const projectSelect = document.getElementById('projects');
            if (projectSelect) {
                Array.from(projectSelect.options).forEach(o => o.selected = false);
            }
            if (roleSelect) {
                roleSelect.value = initialRoleValue;
                updateRoleVisibility();
            }
            if (dateInput) {
                if (initialDateValue) {
                    dateInput.value = initialDateValue;
                } else {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${yyyy}-${mm}-${dd}`;
                }
            }
            if (nameInput && initialNameValue) {
                nameInput.value = initialNameValue;
            }
            const fallbackName = (nameInput ? nameInput.value : '').trim() || 'ç¤ºä¾‹ / Sample';
            const roleLabel = roleLabels[roleSelect ? roleSelect.value : ''] || 'è§’è‰² / Role';
            const projectLabel = projectSelect && projectSelect.selectedOptions.length
                ? Array.from(projectSelect.selectedOptions).map(o => o.textContent.trim()).join('ï¼Œ')
                : 'æœªé€‰æ‹© / None';
            const nowDate = dateInput ? (dateInput.value || new Date().toISOString().slice(0, 10)) : new Date().toISOString().slice(0, 10);
            const sample = [
                `${fallbackName}ï¼Œ${formatDateCN(nowDate)} å·¥ä½œæŠ¥å‘Š`,
                'ã€åŸºæœ¬ä¿¡æ¯ / Basic Infoã€‘',
                `å§“å / Nameï¼š${fallbackName}`,
                `æ—¥æœŸ / Dateï¼š${nowDate}`,
                `è§’è‰² / Roleï¼š${roleLabel}`,
                `é¡¹ç›® / Projectï¼š${projectLabel}`,
                '',
                'ä¸€ã€ä»Šæ—¥å®Œæˆå·¥ä½œï¼ˆå¼€å‘ï¼‰ / Work Completed Today (Dev)',
                '- å®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹ / Implemented and self-tested token renewal logic',
                '- è°ƒæ•´ç½‘å…³å¤šä¼ä¸šè·¯ç”±é…ç½®ï¼Œæ”¯æŒä¼ä¸šç²’åº¦éš”ç¦» / Adjusted multi-tenant routing for enterprise isolation',
                '- ä¿®å¤ LiteChat PC ç¾¤èŠç¦è¨€é€»è¾‘å¼‚å¸¸é—®é¢˜ / Fixed mute logic issue in LiteChat PC group chat',
                '',
                'äºŒã€ä»Šæ—¥è¿›å±• & é—®é¢˜ / Progress & Issues Today',
                '- ç½‘å…³ç°åº¦å‘å¸ƒè„šæœ¬ä»åœ¨è°ƒè¯•é˜¶æ®µï¼Œé¢„è®¡è¿˜éœ€ 0.5 å¤© / Gateway canary release script still under tuning (~0.5 day)',
                '- ç­‰å¾…æµ‹è¯•è¡¥å……å¤šç»ˆç«¯ç™»å½•åœºæ™¯ç”¨ä¾‹ / Waiting for QA to add multi-device login cases',
                '',
                'ä¸‰ã€æ˜æ—¥å·¥ä½œè®¡åˆ’ / Plan for Tomorrow',
                '- å®Œæˆç½‘å…³å‘å¸ƒè„šæœ¬ä¼˜åŒ–ä¸è”è°ƒ / Finish gateway release script & integration',
                '- é…åˆæµ‹è¯•ä¿®å¤ç™»å½• / ç¾¤èŠç›¸å…³ Bug / Work with QA on login & group chat bugs',
                '- é¢„ç ”ä¼ä¸š IP ç™½åå•ä¸å®‰å…¨ç»„é…ç½®å®ç°æ–¹æ¡ˆ / Research enterprise IP whitelist & security group design',
            ].join('\n');
            renderPreview(sample, 'No Report Generated');
            if (statusText) {
                statusText.textContent = 'ç­‰å¾…ç”Ÿæˆæ—¥æŠ¥â€¦ / Waiting to generate reportâ€¦';
            }
            try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
            showToast('è¡¨å•å·²é‡ç½® / Form reset');
        });
    }

    const btnSample = document.getElementById('btn-sample');
    if (btnSample) {
        btnSample.addEventListener('click', () => {
            const role = roleSelect ? roleSelect.value : '';
            if (role === 'qa') {
                updateRoleVisibility();
                const qaScope = document.getElementById('qa-scope');
                const qaProgress = document.getElementById('qa-progress');
                const qaBugs = document.getElementById('qa-bugs');
                const qaTomorrow = document.getElementById('qa-tomorrow');
                if (qaScope) {
                    qaScope.value = [
                        'æ–°å¢åŠŸèƒ½ç”¨ä¾‹ 3 æ¡',
                        'æ ¸å¿ƒæµç¨‹å›å½’ 3 æ¡',
                    ].join('\n');
                }
                if (qaProgress) {
                    qaProgress.value = [
                        'æµ‹è¯•è¿›åº¦ 40%ï¼Œæ–°å¢/å›å½’ç”¨ä¾‹å…± 6 æ¡å·²æ‰§è¡Œ',
                        'å·²éªŒè¯å¹¶å…³é—­ç¼ºé™· 5 æ¡ï¼Œç¯å¢ƒç¨³å®š',
                    ].join('\n');
                }
                if (qaBugs) {
                    qaBugs.value = [
                        'å¾…è§£å†³ç¼ºé™· 20 æ¡ï¼Œå…¶ä¸­å»¶æœŸï¼ˆ>3 å¤©ï¼‰5 æ¡ï¼Œä¼˜å…ˆæ”¶æ•›',
                        'ä»Šæ—¥æ–°å¢ç¼ºé™· 0ï¼Œé«˜/ä¸­/ä½é£é™©åˆ†å¸ƒï¼š0/0/0',
                    ].join('\n');
                }
                if (qaTomorrow) {
                    qaTomorrow.value = [
                        'è¦†ç›–ç‡æå‡è‡³ â‰¥70%ï¼Œç»§ç»­å›å½’ä¸æ–°å¢ç”¨ä¾‹',
                        'æ”¶æ•›å»¶æœŸç¼ºé™· 3/5ï¼Œæ¨åŠ¨å‰©ä½™ç¼ºé™·æ’æœŸä¸éªŒè¯',
                        'è¡¥å……é—®é¢˜ 1/2 çš„å¤ç°ã€æ—¥å¿—ä¸è·Ÿè¿›äºº',
                    ].join('\n');
                }
                showToast('å·²å¡«å…¥ QA ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / QA sample filled');
                return;
            }

            if (role === 'pm') {
                updateRoleVisibility();
                const pmToday = document.getElementById('pm-today');
                const pmCoord = document.getElementById('pm-coord');
                const pmTomorrow = document.getElementById('pm-tomorrow');
                if (pmToday) {
                    pmToday.value = [
                        'æ¢³ç†ç‰ˆæœ¬éœ€æ±‚ä¼˜å…ˆçº§å¹¶å†»ç»“èŒƒå›´',
                        'äº¤ä»˜äº¤äº’ç¨¿ v2ï¼ˆç™»å½•/å‘Šè­¦/ä»ªè¡¨ç›˜ï¼‰ç»™è®¾è®¡ä¸ç ”å‘',
                        'æ˜ç¡®åŸ‹ç‚¹/å¯è§‚æµ‹æ€§éœ€æ±‚æ¸…å•å¹¶ç¡®è®¤è¯„å®¡æ—¶é—´',
                    ].join('\n');
                }
                if (pmCoord) {
                    pmCoord.value = [
                        'ä¸ç ”å‘ç¡®è®¤æ¥å£å˜æ›´å½±å“ï¼Œæ•²å®šæ•°æ®å­—å…¸',
                        'åè°ƒæµ‹è¯•ç¯å¢ƒèµ„æºä¸å‘å¸ƒçª—å£ï¼Œé¿å…å›å½’å†²çª',
                        'å¯¹é½å»¶æœŸç¼ºé™·ä¼˜å…ˆçº§ï¼Œè¦æ±‚è¡¥å…… ETA ä¸è´£ä»»äºº',
                    ].join('\n');
                }
                if (pmTomorrow) {
                    pmTomorrow.value = [
                        'å®Œæˆå‘Šè­¦ç­–ç•¥éœ€æ±‚éªŒæ”¶æ¸…å•å¹¶å‘å‡ºè¯„å®¡çºªè¦',
                        'å‡†å¤‡ä¸‹ä¸€ä¸ªè¿­ä»£çš„éœ€æ±‚æ‹†åˆ†ä¸è¯„å®¡åŒ…',
                        'è·Ÿè¸ªå»¶æœŸç¼ºé™·çš„äº§å“å½±å“ä¸ä¸Šçº¿èŠ‚å¥',
                    ].join('\n');
                }
                showToast('å·²å¡«å…¥ PM ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / PM sample filled');
                return;
            }

            if (role === 'ui') {
                updateRoleVisibility();
                const uiToday = document.getElementById('ui-today');
                const uiFeedback = document.getElementById('ui-feedback');
                const uiTomorrow = document.getElementById('ui-tomorrow');
                if (uiToday) {
                    uiToday.value = [
                        'å®Œæˆå‘Šè­¦ä¸­å¿ƒé«˜ä¿çœŸä¸åˆ‡å›¾ï¼Œæ ‡æ³¨å®Œå¤‡',
                        'ä¼˜åŒ–ä»ªè¡¨ç›˜è§†è§‰å±‚çº§ä¸ç©ºçŠ¶æ€ç»„ä»¶ï¼Œæå‡å¯è¯»æ€§',
                    ].join('\n');
                }
                if (uiFeedback) {
                    uiFeedback.value = [
                        'æ ¹æ® PM åé¦ˆè°ƒæ•´å‘Šè­¦ç­›é€‰çš„äº¤äº’åŠ¨æ•ˆä¸æç¤º',
                        'ä¸å‰ç«¯å¯¹é½è‰²æ¿ä¸é—´è·è§„èŒƒï¼Œè§£å†³é€‚é…é—®é¢˜',
                    ].join('\n');
                }
                if (uiTomorrow) {
                    uiTomorrow.value = [
                        'è¾“å‡ºç§»åŠ¨ç«¯é€‚é…ç¨¿ï¼ˆç™»å½•/ä»ªè¡¨ç›˜ï¼‰å¹¶èµ°æŸ¥',
                        'è¡¥å……è®¾è®¡æ–‡æ¡£ä¸èµ„äº§äº¤ä»˜æ¸…å•ï¼Œæ”¯æŒå‰ç«¯è”è°ƒ',
                    ].join('\n');
                }
                showToast('å·²å¡«å…¥ UI ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / UI sample filled');
                return;
            }

            if (role === 'ops') {
                updateRoleVisibility();
                const opsToday = document.getElementById('ops-today');
                const opsMonitor = document.getElementById('ops-monitor');
                const opsTomorrow = document.getElementById('ops-tomorrow');
                if (opsToday) {
                    opsToday.value = [
                        'å®Œæˆé¢„å‘ç¯å¢ƒæ‰©å®¹ä¸ç°åº¦ç­–ç•¥è°ƒä¼˜',
                        'ç¼–æ’æ¯æ—¥å¤‡ä»½ä¸æ¢å¤æ¼”ç»ƒè„šæœ¬ï¼Œè‡ªæµ‹é€šè¿‡',
                    ].join('\n');
                }
                if (opsMonitor) {
                    opsMonitor.value = [
                        'ç›‘æ§æ— ä¸¥é‡å‘Šè­¦ï¼›å¤„ç† 2 æ¡æ¥å£è¶…æ—¶ï¼Œå·²æ¢å¤',
                        'æ’æŸ¥ä¸€ä¾‹ç£ç›˜ç©ºé—´é¢„è­¦ï¼Œæ¸…ç†æ—¥å¿—å¹¶åŠ é™æµè§„åˆ™',
                    ].join('\n');
                }
                if (opsTomorrow) {
                    opsTomorrow.value = [
                        'ä¸Šçº¿æ–°å‘Šè­¦ç­–ç•¥ä¸çœ‹æ¿ï¼ŒéªŒè¯è¯¯æŠ¥ç‡',
                        'å’Œç ”å‘è”è°ƒå¥åº·æ£€æŸ¥ä¸è‡ªåŠ¨æ‰©ç¼©å®¹é˜ˆå€¼',
                    ].join('\n');
                }
                showToast('å·²å¡«å…¥ Ops ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Ops sample filled');
                return;
            }

            if (role === 'mgr') {
                updateRoleVisibility();
                const mgrProgress = document.getElementById('mgr-progress');
                const mgrRisk = document.getElementById('mgr-risk');
                const mgrTomorrow = document.getElementById('mgr-tomorrow');
                if (mgrProgress) {
                    mgrProgress.value = [
                        'æœ¬å‘¨æ•´ä½“è¿›åº¦ 40%ï¼Œç ”å‘ 45% / æµ‹è¯• 40%',
                        'å…³é”®é‡Œç¨‹ç¢‘ï¼šæ ¸å¿ƒå›å½’å®Œæˆ 3 æ¡ï¼Œå…³é—­ç¼ºé™· 5 æ¡',
                    ].join('\n');
                }
                if (mgrRisk) {
                    mgrRisk.value = [
                        'å»¶æœŸç¼ºé™· 5 æ¡ï¼ˆ>3 å¤©ï¼‰ï¼Œå½±å“ä¸Šçº¿èŠ‚å¥ï¼Œéœ€ç ”å‘ç»™ ETA',
                        'æµ‹è¯•è¦†ç›–éœ€æå‡è‡³ 70% ä»¥æ”¯æ’‘ä¸‹è½®å‘å¸ƒçª—å£',
                    ].join('\n');
                }
                if (mgrTomorrow) {
                    mgrTomorrow.value = [
                        'ç»„ç»‡ç¼ºé™·æ”¶æ•›ä¸“é¡¹ï¼Œè¦æ±‚å»¶æœŸç¼ºé™·æ˜ç¡®è´£ä»»ä¸æ—¶é—´è¡¨',
                        'ç¡®è®¤å‘å¸ƒçª—å£ä¸å›æ»šæ–¹æ¡ˆï¼Œå¯¹é½é¡¹ç›®å¹²ç³»äºº',
                        'è·Ÿè¿›æµ‹è¯•è¿›åº¦æé€Ÿæªæ–½ï¼Œå¢æ´äººæ‰‹æˆ–ä¼˜åŒ–ç”¨ä¾‹æ’æœŸ',
                    ].join('\n');
                }
                showToast('å·²å¡«å…¥ç®¡ç†ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Mgr sample filled');
                return;
            }

            if (roleSelect) {
                roleSelect.value = 'dev';
                updateRoleVisibility();
            }
            const projectSelect = document.getElementById('projects');
            if (projectSelect && projectSelect.options.length) {
                Array.from(projectSelect.options).forEach(o => o.selected = false);
                projectSelect.options[0].selected = true;
                if (projectSelect.options.length > 1) projectSelect.options[1].selected = true;
            }
            const devToday = document.getElementById('dev-today');
            const devProgress = document.getElementById('dev-progress');
            const devTomorrow = document.getElementById('dev-tomorrow');
            if (devToday) {
                devToday.value = [
                    '- å®Œæˆç™»å½•æ¨¡å— Token ç»­æœŸé€»è¾‘å¼€å‘ä¸è‡ªæµ‹ / Implemented and self-tested token renewal logic',
                    '- è°ƒæ•´ç½‘å…³å¤šä¼ä¸šè·¯ç”±é…ç½®ï¼Œæ”¯æŒä¼ä¸šç²’åº¦éš”ç¦» / Adjusted multi-tenant routing for enterprise isolation',
                ].join('\n');
            }
            if (devProgress) {
                devProgress.value = '- ç½‘å…³ç°åº¦å‘å¸ƒè„šæœ¬ä»åœ¨è°ƒè¯•é˜¶æ®µï¼Œé¢„è®¡è¿˜éœ€ 0.5 å¤© / Gateway canary script still being tuned (~0.5 day)';
            }
            if (devTomorrow) {
                devTomorrow.value = [
                    '- å®Œæˆç½‘å…³å‘å¸ƒè„šæœ¬ä¼˜åŒ–ä¸è”è°ƒ / Finish gateway release script & integration',
                    '- é…åˆæµ‹è¯•ä¿®å¤ç™»å½• / ç¾¤èŠç›¸å…³ Bug / Work with QA on login & group chat bugs',
                ].join('\n');
            }
            showToast('å·²å¡«å…¥ç¤ºä¾‹ï¼Œå¯ä¿®æ”¹åæäº¤ / Sample data filled');
        });
    }
</script>
{% endblock %}
