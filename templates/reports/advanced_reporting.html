{% extends "base_topbar.html" %}
{% load static %}

{% block title %}高级报表 / Advanced Reporting{% endblock %}

{% block extra_styles %}
<style>
    .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center;
        z-index: 10; font-weight: 600; color: var(--primary);
    }
    .chart-card { position: relative; min-height: 200px; padding: 20px; background: #fff; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .filter-section { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .pagination-controls { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    [v-cloak] { display: none; }
</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/apexcharts@3.41.0/dist/apexcharts.min.css">
{% endblock %}

{% block content %}
<div id="app" class="page-container" v-cloak>
    <!-- Filter -->
    <div class="filter-section">
        <div class="filter-grid" style="display: flex; gap: 20px; align-items: flex-end;">
             <div class="form-group" style="flex: 1; max-width: 300px;">
                <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">选择项目 / Select Project</label>
                <select class="form-select" v-model="projectId" @change="handleProjectChange" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <option value="">所有项目 / All Projects</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }} ({{ project.code }})</option>
                    {% endfor %}
                </select>
             </div>
             <div class="filter-actions">
                 <button class="btn btn-primary" @click="refreshAll" :disabled="loadingAny" style="background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">
                    <i class="fa-solid fa-rotate" :class="{'fa-spin': loadingAny}"></i> 刷新 / Refresh
                 </button>
             </div>
        </div>
    </div>

    <!-- Gantt Chart -->
    <div class="chart-card">
        <div class="chart-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h5 class="chart-title" style="margin: 0; font-size: 18px;">项目甘特图 / Project Gantt Chart</h5>
            <div class="pagination-controls" v-if="ganttTotal > 0">
                <button class="btn btn-sm" :disabled="ganttPage <= 1" @click="prevGanttPage" style="padding: 4px 10px;">&lt;</button>
                <span>[[ ganttPage ]] / [[ ganttTotalPages ]]</span>
                <button class="btn btn-sm" :disabled="ganttPage >= ganttTotalPages" @click="nextGanttPage" style="padding: 4px 10px;">&gt;</button>
            </div>
        </div>
        <div id="ganttChart" style="height: 500px;"></div>
        <div v-if="ganttLoading" class="loading-overlay">Loading Data...</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Burndown Chart (Async) -->
        <div class="chart-card">
            <div class="chart-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h5 class="chart-title" style="margin: 0; font-size: 18px;">燃尽图 / Burndown</h5>
                <span v-if="burndownStatus === 'running'" style="color: #f59e0b; font-size: 12px;">Computing...</span>
                <span v-if="burndownStatus === 'failed'" style="color: #ef4444; font-size: 12px;">Failed</span>
            </div>
            <div id="burndownChart" style="height: 400px;"></div>
            <div v-if="burndownStatus === 'pending' || burndownStatus === 'running'" class="loading-overlay">Processing...</div>
        </div>

        <!-- CFD Chart (Async) -->
        <div class="chart-card">
            <div class="chart-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h5 class="chart-title" style="margin: 0; font-size: 18px;">累积流图 / CFD</h5>
                <span v-if="cfdStatus === 'running'" style="color: #f59e0b; font-size: 12px;">Computing...</span>
            </div>
            <div id="cfdChart" style="height: 400px;"></div>
            <div v-if="cfdStatus === 'pending' || cfdStatus === 'running'" class="loading-overlay">Processing...</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://npm.elemecdn.com/apexcharts@3.41.0/dist/apexcharts.min.js"></script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

function getStatusColor(status) {
    const key = status ? status.replace('gantt-bar-', '') : 'todo';
    const colorMap = {
        'todo': '#94a3b8',
        'in_progress': '#3b82f6',
        'in_review': '#f59e0b',
        'blocked': '#ef4444',
        'done': '#22c55e',
        'closed': '#64748b'
    };
    return colorMap[key] || '#cbd5e1';
}

// Hook: usePagination
function usePagination(fetchFn, initialPage = 1, initialLimit = 50) {
    const page = ref(initialPage);
    const limit = ref(initialLimit);
    const total = ref(0);
    const data = ref([]);
    const loading = ref(false);
    const error = ref(null);

    const totalPages = computed(() => Math.ceil(total.value / limit.value) || 1);

    const fetchData = async () => {
        loading.value = true;
        try {
            const res = await fetchFn(page.value, limit.value);
            data.value = res.data;
            total.value = res.total;
        } catch (e) {
            error.value = e.message;
        } finally {
            loading.value = false;
        }
    };

    const next = () => {
        if (page.value < totalPages.value) {
            page.value++;
            fetchData();
        }
    };

    const prev = () => {
        if (page.value > 1) {
            page.value--;
            fetchData();
        }
    };

    return { page, limit, total, totalPages, data, loading, error, fetchData, next, prev };
}

// Hook: useReportJob
function useReportJob(type) {
    const status = ref('idle');
    const result = ref(null);
    const error = ref(null);
    let pollInterval = null;

    const startJob = async (projectId) => {
        status.value = 'pending';
        try {
            const res = await fetch('/reports/api/jobs/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ type, project_id: projectId })
            }).then(r => r.json());
            
            if (res.status === 'done') {
                status.value = 'done';
                result.value = res.result;
            } else if (res.job_id) {
                status.value = 'running';
                poll(res.job_id);
            } else {
                throw new Error(res.error || 'Unknown error');
            }
        } catch (e) {
            status.value = 'failed';
            error.value = e.message;
        }
    };

    const poll = (jobId) => {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`/reports/api/jobs/${jobId}/`).then(r => r.json());
                if (res.status === 'done') {
                    status.value = 'done';
                    result.value = res.result;
                    clearInterval(pollInterval);
                } else if (res.status === 'failed') {
                    status.value = 'failed';
                    error.value = res.error;
                    clearInterval(pollInterval);
                }
            } catch (e) {
                clearInterval(pollInterval);
            }
        }, 1000); 
    };

    return { status, result, error, startJob };
}

createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const projectId = ref('{{ selected_project_id|default:"" }}');
        
        const fetchGantt = async (p, l) => {
            const url = `/reports/api/advanced/gantt/?project_id=${projectId.value}&page=${p}&limit=${l}`;
            return await fetch(url).then(r => r.json());
        };
        const gantt = usePagination(fetchGantt);
        const burndown = useReportJob('burndown');
        const cfd = useReportJob('cfd');
        
        let ganttChartObj = null;
        let burndownChartObj = null;
        let cfdChartObj = null;

        const renderGantt = () => {
            if (ganttChartObj) ganttChartObj.destroy();
            if (!gantt.data.value.length) return;
            
            const series = [{
                data: gantt.data.value.map(t => ({
                    x: t.name,
                    y: [new Date(t.start).getTime(), new Date(t.end).getTime()],
                    fillColor: getStatusColor(t.custom_class)
                }))
            }];
            ganttChartObj = new ApexCharts(document.querySelector("#ganttChart"), {
                series,
                chart: { height: 500, type: 'rangeBar', toolbar: {show: false} },
                plotOptions: { bar: { horizontal: true, barHeight: '60%', borderRadius: 4 } },
                xaxis: { type: 'datetime' },
                grid: { borderColor: '#f1f5f9' }
            });
            ganttChartObj.render();
        };

        const renderBurndown = () => {
            if (!burndown.result.value) return;
            if (burndownChartObj) burndownChartObj.destroy();
            const data = burndown.result.value;
            if (!data.labels || !data.labels.length) return;
            
            burndownChartObj = new ApexCharts(document.querySelector("#burndownChart"), {
                series: [
                    { name: 'Ideal', data: data.ideal, color: '#94a3b8' },
                    { name: 'Actual', data: data.actual, color: '#ef4444' }
                ],
                chart: { height: 400, type: 'line', toolbar: {show: false} },
                stroke: { curve: 'straight', width: [2, 3], dashArray: [5, 0] },
                xaxis: { categories: data.labels },
                grid: { borderColor: '#f1f5f9' }
            });
            burndownChartObj.render();
        };
        
        const renderCfd = () => {
            if (!cfd.result.value) return;
            if (cfdChartObj) cfdChartObj.destroy();
            const data = cfd.result.value;
            if (!data.labels || !data.labels.length) return;
            
            cfdChartObj = new ApexCharts(document.querySelector("#cfdChart"), {
                series: data.datasets,
                chart: { height: 400, type: 'area', stacked: true, toolbar: {show: false} },
                colors: ['#cbd5e1', '#22c55e'],
                dataLabels: { enabled: false },
                fill: { type: 'solid', opacity: 0.6 },
                xaxis: { categories: data.labels },
                grid: { borderColor: '#f1f5f9' }
            });
            cfdChartObj.render();
        };

        watch(gantt.data, renderGantt);
        watch(burndown.result, renderBurndown);
        watch(cfd.result, renderCfd);

        const refreshAll = () => {
            gantt.fetchData();
            burndown.startJob(projectId.value);
            cfd.startJob(projectId.value);
        };

        const handleProjectChange = () => {
            gantt.page.value = 1;
            refreshAll();
        };

        onMounted(() => {
            refreshAll();
        });

        const loadingAny = computed(() => gantt.loading.value || burndown.status.value === 'running' || cfd.status.value === 'running');

        return {
            projectId,
            handleProjectChange,
            refreshAll,
            loadingAny,
            ganttPage: gantt.page,
            ganttTotalPages: gantt.totalPages,
            ganttTotal: gantt.total,
            ganttLoading: gantt.loading,
            prevGanttPage: gantt.prev,
            nextGanttPage: gantt.next,
            burndownStatus: burndown.status,
            cfdStatus: cfd.status
        };
    }
}).mount('#app');
</script>
{% endblock %}
