{% extends "base_topbar.html" %}
{% load static %}

{% block title %}高级报表 / Advanced Reporting{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="高级报表 / Advanced Reporting" nav_subtitle="可视化项目进度与趋势分析 / Visualizing project progress and trends" %}{% endblock %}

{% block extra_styles %}
<style>
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- Page Layout --- */
    .page-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 24px 80px 24px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 800;
        color: var(--text-main);
        margin: 0 0 4px 0;
        font-family: 'Space Grotesk', sans-serif;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0;
    }

    /* --- Filter Section --- */
    .filter-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .form-select {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background-color: #fff;
        color: var(--text-main);
        width: 100%;
        transition: var(--transition);
    }

    .form-select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 16px;
    }

    /* --- Buttons --- */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
        line-height: 1.5;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-hover);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .btn-outline {
        background: white;
        border-color: var(--border-color);
        color: var(--text-main);
    }

    .btn-outline:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    /* --- Charts Cards --- */
    .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }

    .chart-card:hover {
        box-shadow: var(--shadow-md);
    }

    .chart-header {
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }

    .chart-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* --- Empty State --- */
    .empty-state {
        text-align: center;
        padding: 64px 24px;
        color: var(--text-secondary);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--border-color);
    }
    
    .empty-state h4 {
        color: var(--text-main);
        margin: 16px 0 8px 0;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header (Hidden in favor of Topbar, or kept for print/structure?) -->
    <!-- We already have nav_header, so we can remove the duplicate page-header or style it as a sub-header -->
    <div class="page-header" style="display: none;">
        <div>
            <h1 class="page-title">高级报表 / Advanced Reporting</h1>
            <p class="page-subtitle">可视化项目进度与趋势分析 / Visualizing project progress and trends</p>
        </div>
    </div>
    
    <!-- Filter -->
    <div class="filter-section">
        <form method="GET" id="reportFilterForm">
            <div class="filter-grid">
                <div class="form-group">
                    <label for="projectSelect" class="form-label">选择项目 / Select Project</label>
                    <select class="form-select" id="projectSelect" name="project_id" onchange="this.form.submit()">
                        <option value="">所有项目 / All Projects</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}" 
                                {% if project.id == selected_project_id %}selected{% endif %}>
                                {{ project.name }} ({{ project.code }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <a href="{% url 'tasks:admin_task_export' %}?project={{ selected_project_id }}" class="btn btn-outline">
                    <i class="fa-solid fa-download"></i>
                    导出任务 / Export Tasks
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-filter"></i>
                    应用筛选 / Apply Filter
                </button>
            </div>
        </form>
    </div>
    
    {% if gantt_data %}
    <div class="chart-card">
        <div class="chart-header">
            <h5 class="chart-title">项目甘特图 / Project Gantt Chart</h5>
        </div>
        <div id="ganttChart" style="height: 500px;"></div>
    </div>
    {% endif %}
    
    {% if burn_down_data.labels %}
    <div class="chart-card">
        <div class="chart-header">
            <h5 class="chart-title">项目燃尽图 / Project Burndown Chart</h5>
        </div>
        <div id="burnDownChart" style="height: 400px;"></div>
    </div>
    {% endif %}

    {% if cfd_data.labels %}
    <div class="chart-card">
        <div class="chart-header">
            <h5 class="chart-title">累积流图 / Cumulative Flow Diagram (CFD)</h5>
        </div>
        <div id="cfdChart" style="height: 400px;"></div>
    </div>
    {% endif %}
    
    {% if not gantt_data and not burn_down_data.labels and not cfd_data.labels %}
    <div class="empty-state">
        <i class="fa-regular fa-file-lines empty-icon" style="font-size: 48px; display: block; margin: 0 auto 16px;"></i>
        <h4>暂无数据 / No Data Available</h4>
        <p>请选择一个项目或确保该项目下有任务数据。 / Please select a project or ensure tasks exist.</p>
    </div>
    {% endif %}
</div>

<link rel="stylesheet" href="https://npm.elemecdn.com/apexcharts@3.41.0/dist/apexcharts.min.css">
<script src="https://npm.elemecdn.com/apexcharts@3.41.0/dist/apexcharts.min.js"></script>

<!-- Data Injection -->
{{ gantt_data|json_script:"gantt-data" }}
{{ burn_down_data|json_script:"burndown-data" }}
{{ cfd_data|json_script:"cfd-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function for colors
    function getStatusColor(status) {
        // Updated to match Django Task model status choices
        const colorMap = {
            'todo': '#94a3b8',         // Slate 400
            'pending': '#94a3b8',      // Fallback
            'in_progress': '#3b82f6',  // Blue 500
            'in_review': '#f59e0b',    // Amber 500
            'blocked': '#ef4444',      // Red 500
            'done': '#22c55e',         // Green 500
            'completed': '#22c55e',    // Fallback
            'closed': '#64748b'        // Slate 500
        };
        // Normalize status key (remove gantt-bar- prefix if present)
        const key = status.replace('gantt-bar-', '');
        return colorMap[key] || '#cbd5e1';
    }

    // Parse Data
    const ganttData = JSON.parse(document.getElementById('gantt-data').textContent || '[]');
    const burnDownData = JSON.parse(document.getElementById('burndown-data').textContent || '{}');
    const cfdData = JSON.parse(document.getElementById('cfd-data').textContent || '{}');

    // Common Chart Options
    const commonOptions = {
        fontFamily: "'Noto Sans SC', sans-serif",
        toolbar: { show: false }
    };

    // 初始化甘特图
    if (ganttData.length > 0) {
        var ganttSeriesData = ganttData.map(function(task) {
            return {
                x: task.name,
                y: [
                    new Date(task.start).getTime(),
                    new Date(task.end).getTime()
                ],
                fillColor: getStatusColor(task.custom_class)
            };
        });

        var ganttOptions = {
            ...commonOptions,
            series: [{
                data: ganttSeriesData
            }],
            chart: {
                height: 500,
                type: 'rangeBar',
                toolbar: { show: true }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    barHeight: '60%',
                    borderRadius: 4
                }
            },
            xaxis: {
                type: 'datetime'
            },
            grid: {
                borderColor: '#f1f5f9'
            },
            tooltip: {
                theme: 'light',
                x: {
                    format: 'dd MMM yyyy'
                }
            }
        };

        var ganttChart = new ApexCharts(document.querySelector("#ganttChart"), ganttOptions);
        ganttChart.render();
    }
    
    // 初始化燃尽图
    if (burnDownData.labels && burnDownData.labels.length > 0) {
        var burnDownOptions = {
            ...commonOptions,
            chart: {
                type: 'line',
                height: 400,
                zoom: { enabled: false }
            },
            series: [
                {
                    name: '理想剩余 / Ideal',
                    data: burnDownData.ideal,
                    color: '#94a3b8',
                    dashArray: 5
                },
                {
                    name: '实际剩余 / Actual',
                    data: burnDownData.actual,
                    color: '#ef4444'
                }
            ],
            xaxis: {
                categories: burnDownData.labels,
                type: 'datetime',
                labels: { style: { colors: '#64748b' } }
            },
            yaxis: {
                labels: { style: { colors: '#64748b' } }
            },
            stroke: {
                curve: 'straight',
                width: [2, 3],
                dashArray: [5, 0]
            },
            grid: {
                borderColor: '#f1f5f9'
            },
            legend: {
                position: 'top'
            }
        };

        var burnDownChart = new ApexCharts(document.querySelector("#burnDownChart"), burnDownOptions);
        burnDownChart.render();
    }

    // 初始化 CFD
    if (cfdData.labels && cfdData.labels.length > 0) {
        var cfdOptions = {
            ...commonOptions,
            series: cfdData.datasets,
            chart: {
                type: 'area',
                height: 400,
                stacked: true,
                zoom: { enabled: false }
            },
            colors: ['#cbd5e1', '#22c55e'], // Pending (Gray), Done (Green)
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            fill: {
                type: 'solid',
                opacity: 0.6
            },
            xaxis: {
                categories: cfdData.labels,
                type: 'datetime',
                labels: { style: { colors: '#64748b' } }
            },
            yaxis: {
                labels: { style: { colors: '#64748b' } }
            },
            grid: {
                borderColor: '#f1f5f9'
            },
            legend: {
                position: 'top'
            }
        };
        var cfdChart = new ApexCharts(document.querySelector("#cfdChart"), cfdOptions);
        cfdChart.render();
    }
});
</script>
{% endblock %}