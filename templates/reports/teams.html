{% extends "base_topbar.html" %}
{% load reports_filters %}
{% load core_tags %}
{% load humanize %}
{% block title %}å›¢é˜Ÿç®¡ç† / Team Management{% endblock %}
{% block nav_header %}{% include "partials/nav.html" with nav_title="å›¢é˜Ÿç®¡ç† / Team Management" nav_subtitle="ç®¡ç†æ‰€æœ‰æˆå‘˜ã€è§’è‰²åˆ†é…ä¸é¡¹ç›®å½’å± / Manage members, roles and project assignments" %}{% endblock %}

{% load reports_filters %}
{% block extra_styles %}
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background-color: var(--bg-page);
        color: var(--text-main);
    }

    /* --- Filter Section --- */
    .filter-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-input, .form-select {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        background-color: #fff;
        width: 100%;
    }

    .form-input:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 16px;
    }

    /* --- Tables --- */
    .table-container {
        overflow-x: auto;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        background: white;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th {
        background: #f8fafc; padding: 12px 16px; text-align: left;
        font-weight: 600; color: var(--text-secondary); white-space: nowrap;
        border-bottom: 1px solid var(--border-color);
    }
    .table td {
        padding: 12px 16px; border-bottom: 1px solid var(--border-color);
        color: var(--text-main); vertical-align: middle;
    }
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover { background: #f8fafc; }

    /* --- Team Grid --- */
    .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    /* --- Team Card --- */
    .team-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        position: relative;
        box-shadow: var(--shadow-sm);
    }

    .team-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: #cbd5e1;
    }

    .card-body {
        padding: 24px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .user-header {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .user-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #3b82f6);
        color: white;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
        flex-shrink: 0;
        border: 2px solid white;
    }

    .user-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .user-name {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 2px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .user-username {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
        line-height: 1.3;
    }

    /* Role Badges */
    .role-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        display: inline-block;
        white-space: nowrap;
    }
    .badge-dev { background: #e0f2fe; color: #0284c7; }
    .badge-qa { background: #fef9c3; color: #ca8a04; }
    .badge-pm { background: #f3e8ff; color: #9333ea; }
    .badge-ui { background: #fce7f3; color: #db2777; }
    .badge-ops { background: #ffedd5; color: #ea580c; }
    .badge-mgr { background: #dcfce7; color: #16a34a; }
    .badge-default { background: #f1f5f9; color: #475569; }

    .meta-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-top: 20px;
        border-top: 1px solid #f1f5f9;
        margin-top: auto;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
    }
    
    .meta-icon {
        width: 16px;
        height: 16px;
        color: var(--text-muted);
        flex-shrink: 0;
    }

    .project-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
    }

    .project-tag {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .project-tag:hover {
        background: #fff;
        border-color: #cbd5e1;
        color: var(--text-main);
    }

    .card-footer {
        padding: 16px 24px;
        background: #f8fafc;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-indicator {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        position: relative;
    }
    .status-active { 
        background: var(--success); 
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.15); 
    }
    .status-inactive { 
        background: var(--text-muted); 
    }

    /* --- Buttons --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }

    .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { border-color: #cbd5e1; background: #f8fafc; }

    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { background: var(--primary-light); color: var(--primary); }

    /* --- Pagination --- */
    .pagination-container {
        margin-top: 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }
    @media (min-width: 768px) {
        .pagination-container {
            flex-direction: row;
            justify-content: space-between;
        }
    }

    .pagination-info { font-size: 13px; color: var(--text-secondary); }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        background: white;
        padding: 4px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }

    .page-btn {
        display: flex; align-items: center; justify-content: center;
        min-width: 36px; height: 36px; padding: 0 8px;
        border-radius: 6px; color: var(--text-main);
        text-decoration: none; font-size: 13px; font-weight: 600;
        transition: var(--transition);
    }
    .page-btn:hover:not(.disabled):not(.active) { background: var(--bg-page); }
    .page-btn.active { background: var(--primary); color: white; }
    .page-btn.disabled { color: var(--text-muted); cursor: not-allowed; opacity: 0.6; }

    /* --- Empty State --- */
    .empty-state {
        text-align: center;
        padding: 64px 20px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--border-color);
        color: var(--text-secondary);
    }
    .empty-icon {
        width: 64px; height: 64px; color: var(--text-muted);
        margin-bottom: 16px; opacity: 0.5;
    }

    /* --- Modals (Keep existing) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(2px);
    }
    .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease-out; }
    
    .modal-content {
        background: white; width: 90%; max-width: 500px;
        border-radius: 16px; box-shadow: var(--shadow-lg);
        display: flex; flex-direction: column; max-height: 85vh;
    }
    
    .modal-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-size: 18px; font-weight: 700; margin: 0; }
    .close-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); }
    
    .modal-body { padding: 20px; overflow-y: auto; }
    .modal-section { margin-bottom: 24px; }
    .modal-section:last-child { margin-bottom: 0; }
    .modal-section-title {
        font-size: 12px; font-weight: 700; text-transform: uppercase;
        color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 0.05em;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Modal Specifics for Project List */
    .project-list-modal {
        display: flex; flex-direction: column; gap: 8px;
        max-height: 240px; overflow-y: auto;
        border: 1px solid var(--border-color); border-radius: 8px;
        padding: 8px; background: #f8fafc;
    }
    .project-item-modal {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 12px; background: white;
        border: 1px solid var(--border-color); border-radius: 6px;
        font-size: 13px; transition: var(--transition);
    }
    .project-item-modal:hover { border-color: #cbd5e1; }
    .btn-remove {
        color: var(--text-muted); cursor: pointer; padding: 4px;
        border-radius: 4px; background: transparent; border: none;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-remove:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
    
    @media (max-width: 640px) {
        .filter-grid { grid-template-columns: 1fr; }
        .team-grid { grid-template-columns: 1fr; }
    }
{% endblock %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto; padding-bottom: 40px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 800; color: var(--text-main); margin: 0 0 4px 0;">å›¢é˜Ÿç®¡ç† / Team Management</h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">å…± {{ total_count }} ä½æˆå‘˜ / Total {{ total_count }} members</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="view-tabs" style="display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color);">
            <button class="tab-btn active" onclick="switchTab('projects')" id="btn-projects" style="padding: 6px 16px; border-radius: 6px; border: none; background: transparent; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">
                ğŸ¢ é¡¹ç›®å›¢é˜Ÿ / Project Teams
            </button>
            <button class="tab-btn" onclick="switchTab('members')" id="btn-members" style="padding: 6px 16px; border-radius: 6px; border: none; background: transparent; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">
                ğŸ‘¥ æˆå‘˜åˆ—è¡¨ / Member Directory
            </button>
        </div>
    </div>

    <!-- TAB 1: Project Teams -->
    <div id="tab-projects" class="tab-pane">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
            {% for item in project_teams %}
            <div class="card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">{{ item.project.code }}</div>
                            <h3 style="font-size: 18px; font-weight: 700; color: var(--text-main); margin: 4px 0 0;">
                                <a href="{% url 'projects:project_detail' item.project.id %}" style="text-decoration: none; color: inherit; transition: color 0.2s;">
                                    {{ item.project.name }}
                                </a>
                            </h3>
                        </div>
                        <span class="badge" style="background: var(--primary-light); color: var(--primary);">{{ item.member_count }} Members</span>
                    </div>
                    
                    <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary);">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning);"></span>
                            Owner: {{ item.project.owner.get_full_name|default:item.project.owner.username|default:"None" }}
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></span>
                            Managers: {{ item.manager_count }}
                        </div>
                    </div>
                </div>
                
                <div style="padding: 16px 20px; background: #f8fafc;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">ROLE DISTRIBUTION</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for stat in item.role_stats %}
                            {% if stat.position %}
                            <span style="font-size: 12px; padding: 2px 8px; background: white; border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-secondary);">
                                {{ stat.position|upper }}: <b>{{ stat.count }}</b>
                            </span>
                            {% endif %}
                        {% empty %}
                            <span style="font-size: 12px; color: var(--text-muted);">No role data</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); text-align: right;">
                    <button type="button" class="btn btn-secondary btn-sm" style="font-size: 13px;" onclick="openProjectManageModal('{{ item.project.id }}', '{{ item.project.name|escapejs }}')">
                        ç®¡ç†å›¢é˜Ÿ / Manage Team &rarr;
                    </button>
                </div>
            </div>
            {% endfor %}
            
            <!-- Add New Project Placeholder -->
            <a href="{% url 'admin:projects_project_add' %}" class="card" style="display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed var(--border-color); background: transparent; color: var(--text-muted); text-decoration: none; min-height: 200px; transition: all 0.2s;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span style="font-weight: 600;">åˆ›å»ºæ–°é¡¹ç›® / Create Project</span>
            </a>
        </div>

        <!-- Pagination for Projects -->
        {% if project_page_obj.has_other_pages %}
        <div class="pagination-container">
            <div class="pagination-info">
                <span>å…± {{ project_page_obj.paginator.count }} ä¸ªé¡¹ç›® / Total {{ project_page_obj.paginator.count }} projects</span>
                <span>æ˜¾ç¤º {{ project_page_obj.start_index }}-{{ project_page_obj.end_index }}</span>
            </div>
    
            <div class="pagination-controls">
                {% if project_page_obj.has_previous %}
                <a href="?{% url_replace project_page=project_page_obj.previous_page_number %}" class="page-btn" title="ä¸Šä¸€é¡µ / Previous">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-btn disabled">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </span>
                {% endif %}
    
                {% for i in project_page_obj.paginator.page_range %}
                    {% if project_page_obj.number == i %}
                    <span class="page-btn active">{{ i }}</span>
                    {% elif i > project_page_obj.number|add:'-3' and i < project_page_obj.number|add:'3' %}
                    <a href="?{% url_replace project_page=i %}" class="page-btn">{{ i }}</a>
                    {% endif %}
                {% endfor %}
    
                {% if project_page_obj.has_next %}
                <a href="?{% url_replace project_page=project_page_obj.next_page_number %}" class="page-btn" title="ä¸‹ä¸€é¡µ / Next">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-btn disabled">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- TAB 2: Member Directory (Existing) -->
    <div id="tab-members" class="tab-pane" style="display: none;">
        <!-- Filter Bar -->
        <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="filter-grid">
                <!-- Search -->
                <div class="form-group" style="flex: 2; min-width: 240px;">
                    <label class="form-label" for="q">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        æœç´¢ / Search
                    </label>
                    <input type="text" id="q" name="q" class="form-input" placeholder="å§“åã€é‚®ç®±æˆ–ç”¨æˆ·å... / Name, Email or Username..." value="{{ q }}">
                </div>
                
                <!-- Role Filter -->
                <div class="form-group">
                    <label class="form-label" for="role">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        è§’è‰² / Role
                    </label>
                    <select id="role" name="role" class="form-select">
                        <option value="">å…¨éƒ¨è§’è‰² / All Roles</option>
                        {% for r_val, r_label in roles %}
                        <option value="{{ r_val }}" {% if role == r_val %}selected{% endif %}>{{ r_label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Project Filter -->
                <div class="form-group">
                    <label class="form-label" for="project">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        é¡¹ç›® / Project
                    </label>
                    <select id="project" name="project" class="form-select">
                        <option value="">å…¨éƒ¨é¡¹ç›® / All Projects</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}" {% if project_filter == p.id %}selected{% endif %}>{{ p.name }} ({{ p.code }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <a href="{% url 'reports:teams' %}" class="btn btn-ghost">é‡ç½® / Reset</a>
                <button type="submit" class="btn btn-primary" onclick="showLoading()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    ç­›é€‰ / Filter
                </button>
            </div>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; color: var(--primary);">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            <div style="margin-top: 12px; font-weight: 600; color: var(--text-main);">æ­£åœ¨åŠ è½½... / Loading...</div>
        </div>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
    <script>function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }</script>

    <!-- Team List (Table View) -->
    {% if users %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 250px;">æˆå‘˜ / Member</th>
                    <th>è§’è‰² / Role</th>
                    <th>é¡¹ç›® / Projects</th>
                    <th>çŠ¶æ€ / Status</th>
                    {% if request.user.is_superuser %}
                        <th>å…¥èŒ / Hire</th>
                        <th>è¯•ç”¨ / Prob.</th>
                        <th>è–ªèµ„ (P/O)</th>
                        <th>å¤‡æ³¨ / Note</th>
                    {% endif %}
                    <th style="text-align: right;">æ“ä½œ / Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="row-{{ user.id }}">
                    <td>
                        <div class="user-header" style="gap: 10px;">
                            <div class="user-avatar" style="width: 36px; height: 36px; font-size: 14px;">
                                {% with avatar_url=user|get_avatar_url %}
                                    {% if avatar_url %}
                                        <img src="{{ avatar_url }}" alt="{{ user.get_full_name }}" style="width:100%; height:100%; object-fit:cover; border-radius:inherit;">
                                    {% else %}
                                        {{ user.get_full_name|default:user.username|slice:":1"|upper }}
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div>
                                <div style="font-weight: 600;">{{ user.get_full_name|default:user.username }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">@{{ user.username }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if user.profile.position == 'dev' %}
                            <span class="role-badge badge-dev">Dev</span>
                        {% elif user.profile.position == 'qa' %}
                            <span class="role-badge badge-qa">QA</span>
                        {% elif user.profile.position == 'pm' %}
                            <span class="role-badge badge-pm">PM</span>
                        {% elif user.profile.position == 'ui' %}
                            <span class="role-badge badge-ui">UI</span>
                        {% elif user.profile.position == 'ops' %}
                            <span class="role-badge badge-ops">Ops</span>
                        {% elif user.profile.position == 'mgr' %}
                            <span class="role-badge badge-mgr">Mgr</span>
                        {% else %}
                            <span class="role-badge badge-default">--</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="project-tags">
                            {% for proj in user.project_memberships.all|slice:":3" %}
                                <span class="project-tag">{{ proj.code }}</span>
                            {% endfor %}
                            {% if user.project_memberships.all|length > 3 %}
                                <span class="project-tag">+{{ user.project_memberships.all|length|add:"-3" }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if request.user.is_superuser %}
                            <!-- Admin sees detailed employment status -->
                            {% if user.profile.employment_status == 'active' %}
                                <span class="status-indicator"><span class="status-dot status-active"></span> åœ¨èŒ</span>
                            {% else %}
                                <span class="status-indicator"><span class="status-dot status-inactive"></span> ç¦»èŒ</span>
                            {% endif %}
                        {% else %}
                            <!-- Regular user sees active/inactive -->
                            {% if user.is_active %}
                                <span class="status-indicator"><span class="status-dot status-active"></span> Active</span>
                            {% else %}
                                <span class="status-indicator"><span class="status-dot status-inactive"></span> Inactive</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    {% if request.user.is_superuser %}
                        <td data-field="hire_date">{{ user.profile.hire_date|date:"Y-m-d"|default:"--" }}</td>
                        <td data-field="probation">{{ user.profile.probation_months }} Mo.</td>
                        <td>
                            <div style="font-size: 12px;">
                                <div>P: {{ user.profile.probation_salary|default:"--"|floatformat:2|intcomma }} {{ user.profile.salary_currency }}</div>
                                <div>O: {{ user.profile.official_salary|default:"--"|floatformat:2|intcomma }} {{ user.profile.salary_currency }}</div>
                            </div>
                        </td>
                        <td data-field="note" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ user.profile.hr_note }}">
                            {{ user.profile.hr_note|default:"--" }}
                        </td>
                    {% endif %}
                    <td style="text-align: right;">
                        <div style="display: flex; justify-content: flex-end; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openUserManageModal('{{ user.id }}', '{{ user.get_full_name|default:user.username|escapejs }}', '{{ user.profile.position }}', JSON.parse('{{ user.project_memberships.all|to_project_json|escapejs }}'))">
                                æƒé™
                            </button>
                            {% if request.user.is_superuser %}
                            <button type="button" class="btn btn-primary btn-sm" onclick='openHRModal({{ user.id }}, "{{ user.get_full_name|default:user.username|escapejs }}", {
                                employment_status: "{{ user.profile.employment_status }}",
                                hire_date: "{{ user.profile.hire_date|date:"Y-m-d" }}",
                                probation_months: {{ user.profile.probation_months }},
                                probation_salary: "{{ user.profile.probation_salary|default:"" }}",
                                official_salary: "{{ user.profile.official_salary|default:"" }}",
                                salary_currency: "{{ user.profile.salary_currency }}",
                                resignation_date: "{{ user.profile.resignation_date|date:"Y-m-d" }}",
                                hr_note: "{{ user.profile.hr_note|escapejs }}",
                                intermediary_company: "{{ user.profile.intermediary_company|default:""|escapejs }}",
                                intermediary_fee_amount: "{{ user.profile.intermediary_fee_amount|default:"" }}",
                                intermediary_fee_currency: "{{ user.profile.intermediary_fee_currency|default:"CNY" }}"
                            })'>
                                äººäº‹
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <h3 style="font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 8px;">æœªæ‰¾åˆ°åŒ¹é…æˆå‘˜ / No members found</h3>
        <p style="margin-bottom: 24px;">è¯·å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶ã€‚/ Please adjust search or filters.</p>
        <a href="{% url 'reports:teams' %}" class="btn btn-secondary">æ¸…é™¤ç­›é€‰ / Clear Filters</a>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination-info">
            <span>å…± {{ total_count }} ä½æˆå‘˜ / Total {{ total_count }} members</span>
            <span>æ˜¾ç¤º {{ page_obj.start_index }}-{{ page_obj.end_index }}</span>
        </div>

        <div class="pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?{% url_replace member_page=page_obj.previous_page_number %}" class="page-btn" title="ä¸Šä¸€é¡µ / Previous">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </a>
            {% else %}
            <span class="page-btn disabled">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </span>
            {% endif %}

            {% for i in page_obj.paginator.page_range %}
                {% if page_obj.number == i %}
                <span class="page-btn active">{{ i }}</span>
                {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <a href="?{% url_replace member_page=i %}" class="page-btn">{{ i }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?{% url_replace member_page=page_obj.next_page_number %}" class="page-btn" title="ä¸‹ä¸€é¡µ / Next">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            {% else %}
            <span class="page-btn disabled">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </span>
            {% endif %}
        </div>
    </div>
    {% endif %}


    </div> <!-- End tab-members -->

    <script>
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(el => el.style.display = 'none');
            // Show selected tab
            document.getElementById('tab-' + tabId).style.display = 'block';
            
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
                el.style.background = 'transparent';
                el.style.color = 'var(--text-secondary)';
                el.style.boxShadow = 'none';
            });
            const btn = document.getElementById('btn-' + tabId);
            btn.classList.add('active');
            btn.style.background = 'var(--bg-card)';
            btn.style.color = 'var(--primary)';
            btn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
        }
        
        // Init active state style
        document.addEventListener('DOMContentLoaded', function() {
            // If URL has ?tab=members, switch to it
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('q') || urlParams.get('role') || urlParams.get('member_page')) {
                switchTab('members');
            } else {
                switchTab('projects');
            }
        });
    </script>

</div>

<!-- Project Management Modal -->
<div id="project-manage-modal" class="modal-overlay" onclick="if(event.target === this) closeProjectManageModal()">
    <div class="modal-content" style="max-width: 600px; height: 80vh;">
        <div class="modal-header">
            <h3 class="modal-title" id="pm-modal-title">é¡¹ç›®å›¢é˜Ÿç®¡ç† / Project Team</h3>
            <button type="button" class="close-btn" onclick="closeProjectManageModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Tabs inside Modal -->
            <div style="display: flex; border-bottom: 1px solid var(--border-color); background: #f8fafc; padding: 0 16px;">
                <button class="pm-tab active" onclick="switchPmTab('members')" id="pm-tab-members">æˆå‘˜ (Members)</button>
                <button class="pm-tab" onclick="switchPmTab('managers')" id="pm-tab-managers">ç®¡ç†å‘˜ (Admins)</button>
                <button class="pm-tab" onclick="switchPmTab('owner')" id="pm-tab-owner">è´Ÿè´£äºº (Owner)</button>
            </div>

            <!-- Content Area -->
            <div style="flex: 1; overflow-y: auto; padding: 20px;">
                
                <!-- MEMBERS TAB -->
                <div id="pm-view-members" class="pm-view">
                    <div class="search-box-wrapper">
                        <input type="text" id="pm-search-members" class="form-input" placeholder="æœç´¢ç”¨æˆ·æ·»åŠ ... / Search to add..." oninput="handleUserSearch('members', this.value)">
                        <div id="pm-results-members" class="search-results-dropdown" style="display:none;"></div>
                    </div>
                    <div style="margin-top: 16px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px;">EXISTING MEMBERS</div>
                        <div id="pm-list-members" class="user-list-container">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <!-- MANAGERS TAB -->
                <div id="pm-view-managers" class="pm-view" style="display: none;">
                    <div class="alert-box info">
                        ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘é¡¹ç›®ä¿¡æ¯ã€ç®¡ç†ä»»åŠ¡å’Œæˆå‘˜ã€‚ / Managers can edit project, manage tasks & members.
                    </div>
                    <div class="search-box-wrapper" style="margin-top: 12px;">
                        <input type="text" id="pm-search-managers" class="form-input" placeholder="æœç´¢ç”¨æˆ·æ·»åŠ ... / Search to add..." oninput="handleUserSearch('managers', this.value)">
                        <div id="pm-results-managers" class="search-results-dropdown" style="display:none;"></div>
                    </div>
                    <div style="margin-top: 16px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px;">MANAGERS</div>
                        <div id="pm-list-managers" class="user-list-container"></div>
                    </div>
                </div>

                <!-- OWNER TAB -->
                <div id="pm-view-owner" class="pm-view" style="display: none;">
                    <div class="alert-box warning">
                        âš ï¸ è½¬ç§»è´Ÿè´£äººæ˜¯æ•æ„Ÿæ“ä½œã€‚ / Transferring ownership is sensitive.
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">å½“å‰è´Ÿè´£äºº / Current Owner</div>
                        <div id="pm-current-owner" style="font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 24px;">
                            Loading...
                        </div>
                        
                        <div style="text-align: left;">
                            <label class="form-label">ç§»äº¤ç»™... / Transfer to...</label>
                            <div class="search-box-wrapper">
                                <input type="text" id="pm-search-owner" class="form-input" placeholder="æœç´¢æ–°è´Ÿè´£äºº... / Search new owner..." oninput="handleUserSearch('owner', this.value)">
                                <div id="pm-results-owner" class="search-results-dropdown" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    .pm-tab {
        padding: 12px 16px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }
    .pm-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    .pm-tab:hover:not(.active) {
        color: var(--text-main);
    }

    .search-box-wrapper { position: relative; }
    .search-results-dropdown {
        position: absolute; top: 100%; left: 0; right: 0;
        background: white; border: 1px solid var(--border-color);
        border-radius: 8px; box-shadow: var(--shadow-lg);
        max-height: 200px; overflow-y: auto; z-index: 10;
        margin-top: 4px;
    }
    .search-result-item {
        padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px;
    }
    .search-result-item:hover { background: var(--primary-light); }

    .user-list-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px; border: 1px solid var(--border-color);
        border-radius: 8px; margin-bottom: 8px; background: white;
    }
    .user-list-info { display: flex; align-items: center; gap: 10px; }
    .user-list-avatar {
        width: 32px; height: 32px; border-radius: 50%;
        background: var(--primary-light); color: var(--primary);
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: 700;
    }

    .alert-box {
        padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.4;
    }
    .alert-box.info { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
    .alert-box.warning { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
</style>

<!-- Single User Manage Modal -->
<div id="user-manage-modal" class="modal-overlay" onclick="if(event.target === this) closeUserManageModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="umm-title">ç®¡ç†æˆå‘˜ / Manage Member</h3>
            <button type="button" class="close-btn" onclick="closeUserManageModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body">
            <!-- 1. Role Update -->
            <div class="modal-section">
                <div class="modal-section-title">è§’è‰²è®¾ç½® / Role Settings</div>
                <form id="umm-role-form" method="post" style="display: flex; gap: 8px;">
                    {% csrf_token %}
                    <select id="umm-role-select" name="role" class="form-select" style="flex:1;">
                        {% for r_val, r_label in roles %}
                        <option value="{{ r_val }}">{{ r_label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">æ›´æ–° / Update</button>
                </form>
            </div>

            <!-- 2. Project List -->
            <div class="modal-section">
                <div class="modal-section-title" id="umm-projects-title">å‚ä¸é¡¹ç›® / Projects (0)</div>
                <div id="umm-project-list" class="project-list-modal">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- 3. Add Project -->
            <div class="modal-section">
                <div class="modal-section-title">æ·»åŠ é¡¹ç›® / Add Project</div>
                <form id="umm-add-project-form" method="post" style="display: flex; gap: 8px;" onsubmit="showAdding(this)">
                    {% csrf_token %}
                    <select name="project_id" class="form-select" style="flex:1;" required>
                        <option value="">é€‰æ‹©é¡¹ç›®... / Select Project...</option>
                        {% for p in projects %}
                            <option value="{{ p.id }}">{{ p.name }} ({{ p.code }})</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-secondary">æ·»åŠ  / Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if request.user.is_superuser %}
<!-- HR Manage Modal -->
<div id="hr-manage-modal" class="modal-overlay" onclick="if(event.target === this) closeHRModal()">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="hr-modal-title">ç¼–è¾‘æˆå‘˜äººäº‹ä¿¡æ¯</h3>
            <button type="button" class="close-btn" onclick="closeHRModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="hr-form" onsubmit="saveHRInfo(event)">
                <input type="hidden" id="hr-user-id">
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">æ˜¯å¦åœ¨èŒ / Employment Status</label>
                    <select id="hr-status" class="form-select" required>
                        <option value="active">åœ¨èŒ / Active</option>
                        <option value="terminated">ç¦»èŒ / Terminated</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">å…¥èŒæ—¶é—´ / Hire Date</label>
                        <input type="date" id="hr-hire-date" class="form-input">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ç¦»èŒæ—¶é—´ / Resignation Date</label>
                        <input type="date" id="hr-resignation-date" class="form-input">
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">è¯•ç”¨æ—¶é•¿ (æœˆ) / Probation (Months)</label>
                        <input type="number" id="hr-probation-months" class="form-input" min="1" max="6" value="3" required>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">è¯•ç”¨è–ªèµ„ / Probation Salary</label>
                        <input type="number" id="hr-probation-salary" class="form-input" step="0.01" min="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">æ­£å¼è–ªèµ„ / Official Salary</label>
                        <input type="number" id="hr-official-salary" class="form-input" step="0.01" min="0">
                    </div>
                    <div class="form-group" style="width: 80px;">
                        <label class="form-label">å•ä½ / Unit</label>
                        <select id="hr-salary-currency" class="form-select" required>
                            <option value="CNY">CNY</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section-title" style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px;">ä¸­ä»‹ä¿¡æ¯ / Intermediary Info</div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">ä¸­ä»‹å…¬å¸ / Intermediary Company</label>
                    <input type="text" id="hr-intermediary-company" class="form-input" placeholder="è¯·è¾“å…¥ä¸­ä»‹å…¬å¸åç§°">
                </div>

                <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: flex-end;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ä¸­ä»‹è´¹ç”¨ / Intermediary Fee</label>
                        <div style="position: relative; display: flex; align-items: center;">
                            <input type="number" id="hr-intermediary-fee-amount" class="form-input" step="0.01" min="0" style="padding-right: 30px;">
                            <span id="hr-fee-symbol" style="position: absolute; right: 10px; color: var(--text-muted); font-weight: 600;">Â¥</span>
                        </div>
                    </div>
                    <div class="form-group" style="width: 80px;">
                        <label class="form-label">å•ä½ / Unit</label>
                        <select id="hr-intermediary-fee-currency" class="form-select" onchange="updateFeeSymbol(this.value)">
                            <option value="CNY">CNY</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label">å¤‡æ³¨ / Note</label>
                    <textarea id="hr-note" class="form-input" rows="3" maxlength="500"></textarea>
                </div>
                
                <div id="hr-error-msg" class="alert-box warning" style="display: none; margin-bottom: 16px;"></div>
                
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeHRModal()">å–æ¶ˆ / Cancel</button>
                    <button type="submit" class="btn btn-primary" id="hr-save-btn">ä¿å­˜ / Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Toast Notification Container -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>

<script>
    // === WebSocket & Real-time Sync ===
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const teamWs = new WebSocket(`${wsScheme}://${window.location.host}/ws/team-updates/`);
    
    teamWs.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if(data.type === 'team_update') {
            handleTeamUpdate(data);
        }
    };
    
    function handleTeamUpdate(msg) {
        const userId = msg.user_id;
        const senderId = msg.sender_id;
        const currentUserId = {{ request.user.id }};
        
        // Update Table Row
        if(msg.action === 'update_role') {
            updateRowRole(userId, msg.data.role, msg.data.role_display);
        } else if(msg.action === 'add_project' || msg.action === 'remove_project') {
            updateRowProjects(userId, msg.data.projects);
        }
        
        // Update Modal if open for this user
        if(currentManageUserId == userId) {
            // Conflict detection/Sync
            if(senderId !== currentUserId) {
                showToast(`âš ï¸ æ­¤ç”¨æˆ·çš„æƒé™å·²è¢«å…¶ä»–ç®¡ç†å‘˜ä¿®æ”¹ / User permissions modified by another admin`, 'warning');
            }
            
            if(msg.action === 'add_project' || msg.action === 'remove_project') {
                renderModalProjects(msg.data.projects);
            } else if(msg.action === 'update_role') {
                 // Update select box if not focused? Or just let it be.
                 const select = document.getElementById('umm-role-select');
                 if(select && document.activeElement !== select) {
                     select.value = msg.data.role;
                 }
            }
        }
    }

    // === UI Helpers ===
    function showToast(message, type='success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.style.cssText = `
            padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out;
            display: flex; align-items: center; gap: 8px; min-width: 250px;
        `;
        
        if(type === 'success') toast.style.background = '#10b981';
        else if(type === 'error') toast.style.background = '#ef4444';
        else if(type === 'warning') toast.style.background = '#f59e0b';
        
        toast.innerHTML = `<span>${message}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'all 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function updateRowRole(userId, role, roleDisplay) {
        const row = document.getElementById(`row-${userId}`);
        if(!row) return;
        
        const cell = row.cells[1];
        // Map role to badge class
        const badgeMap = {
            'dev': 'badge-dev', 'qa': 'badge-qa', 'pm': 'badge-pm',
            'ui': 'badge-ui', 'ops': 'badge-ops', 'mgr': 'badge-mgr'
        };
        const badgeClass = badgeMap[role] || 'badge-default';
        cell.innerHTML = `<span class="role-badge ${badgeClass}">${roleDisplay}</span>`;
        
        // Update modal trigger data
        const btn = row.cells[row.cells.length-1].querySelector('.btn-secondary');
        if(btn) {
            // Update onclick params regex replace
             const oldOnClick = btn.getAttribute('onclick');
             // Param 3 is role. 
             // openUserManageModal('id', 'name', 'ROLE', ...)
             const newOnClick = oldOnClick.replace(/'[^']+', JSON/, `'${role}', JSON`);
             btn.setAttribute('onclick', newOnClick);
        }
    }
    
    function updateRowProjects(userId, projects) {
        const row = document.getElementById(`row-${userId}`);
        if(!row) return;
        
        const cell = row.cells[2];
        let html = '<div class="project-tags">';
        projects.slice(0, 3).forEach(p => {
            html += `<span class="project-tag">${p.code}</span>`;
        });
        if(projects.length > 3) {
            html += `<span class="project-tag">+${projects.length - 3}</span>`;
        }
        html += '</div>';
        cell.innerHTML = html;
        
        // Update modal trigger data
        const btn = row.cells[row.cells.length-1].querySelector('.btn-secondary');
        if(btn) {
            // Param 4 is JSON
            // We need to replace JSON.parse('...') with new JSON
            // But replacing complex string in onclick is fragile. 
            // Better: Store data in data attributes or fetch fresh on open.
            // For now, let's try to update the attribute carefully or just rely on fetch-on-open if we change strategy.
            // Given the complexity of replacing JSON in onclick string, we will switch `openUserManageModal` 
            // to fetch latest data or use the `projects` array passed in if we can.
            // Hack: Update the attribute by finding the JSON part.
            // Actually, `projects` is passed as JSON.parse('...').
            const jsonStr = JSON.stringify(projects).replace(/"/g, '&quot;');
            // Regex to find the JSON.parse part
            const newOnClick = btn.getAttribute('onclick').replace(/JSON\.parse\('.*?'\)/, `JSON.parse('${jsonStr}')`);
            btn.setAttribute('onclick', newOnClick);
        }
    }

    // === User Manage Modal Logic ===
    let currentManageUserId = null;
    const CSRF_TOKEN = '{{ csrf_token }}';

    function openUserManageModal(userId, userName, currentRole, projects) {
        currentManageUserId = userId;
        document.getElementById('umm-title').innerText = `ç®¡ç†æˆå‘˜ / Manage Member: ${userName}`;
        
        // Setup Role Form
        const roleSelect = document.getElementById('umm-role-select');
        roleSelect.value = currentRole;
        
        // Render Projects
        renderModalProjects(projects);
        
        // Reset Add Form
        document.getElementById('umm-add-project-form').reset();
        
        openModal('user-manage-modal');
    }
    
    function renderModalProjects(projects) {
        const projectList = document.getElementById('umm-project-list');
        projectList.innerHTML = '';
        document.getElementById('umm-projects-title').innerText = `å‚ä¸é¡¹ç›® / Projects (${projects.length})`;
        
        if (projects.length === 0) {
            projectList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">æš‚æœªå‚ä¸ä»»ä½•é¡¹ç›® / No projects assigned</div>';
        } else {
            projects.forEach(p => {
                const div = document.createElement('div');
                div.className = 'project-item-modal';
                div.innerHTML = `
                    <span style="font-weight: 500;">${p.name} <span style="color: var(--text-muted); font-weight: normal;">(${p.code})</span></span>
                    <button type="button" class="btn-remove" title="ç§»é™¤é¡¹ç›®" onclick="handleProjectRemove(${p.id}, this)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                projectList.appendChild(div);
            });
        }
    }

    function closeUserManageModal() {
        closeModal('user-manage-modal');
        currentManageUserId = null;
    }

    // === AJAX Handlers ===
    
    // Role Update
    document.getElementById('umm-role-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = 'Updating...';
        btn.disabled = true;
        
        const role = document.getElementById('umm-role-select').value;
        const formData = new FormData();
        formData.append('role', role);
        
        try {
            const res = await fetchWithRetry(`/reports/teams/${currentManageUserId}/role/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                showToast('è§’è‰²æ›´æ–°æˆåŠŸ / Role updated successfully');
                // Row update handled by WebSocket usually, but do it here for immediate feedback
                // updateRowRole(currentManageUserId, role, ...); // We need display name, wait for WS or use local map
            } else {
                showToast(data.message || 'Error updating role', 'error');
            }
        } catch(e) {
            showToast('Network error', 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
    
    // Add Project
    document.getElementById('umm-add-project-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        const select = this.querySelector('select');
        const projectId = select.value;
        if(!projectId) return;
        
        const originalText = btn.innerText;
        btn.innerText = 'Adding...';
        btn.disabled = true;
        
        const formData = new FormData();
        formData.append('project_id', projectId);
        
        try {
            const res = await fetchWithRetry(`/reports/teams/${currentManageUserId}/project/add/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                showToast('é¡¹ç›®æ·»åŠ æˆåŠŸ / Project added');
                renderModalProjects(data.projects); // Immediate update from response
                select.value = '';
            } else {
                showToast(data.message || 'Error adding project', 'error');
            }
        } catch(e) {
            showToast('Network error', 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
    
    // Remove Project
    async function handleProjectRemove(projectId, btn) {
        if(!confirm('ç¡®å®šè¦ç§»é™¤è¯¥é¡¹ç›®å—ï¼Ÿ/ Remove this project?')) return;
        
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
        btn.disabled = true;
        
        try {
            const res = await fetchWithRetry(`/reports/teams/${currentManageUserId}/project/${projectId}/remove/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                showToast('é¡¹ç›®å·²ç§»é™¤ / Project removed');
                renderModalProjects(data.projects);
            } else {
                showToast(data.message || 'Error removing project', 'error');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch(e) {
            showToast('Network error', 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }
    
    // Fetch Helper with Retry
    async function fetchWithRetry(url, options, retries = 3) {
        try {
            return await fetch(url, options);
        } catch(e) {
            if(retries > 0) {
                await new Promise(r => setTimeout(r, 500));
                return fetchWithRetry(url, options, retries - 1);
            }
            throw e;
        }
    }

    function openModal(id) {
        document.getElementById(id).classList.add('open');
    }
    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
    }
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            const openModals = document.querySelectorAll('.modal-overlay.open');
            openModals.forEach(modal => modal.classList.remove('open'));
            currentManageUserId = null;
        }
    });

    // === Existing Project Management Modal Logic (Keep as is but add CSRF) ===
    // (Preserved logic for Project Management Modal to ensure no regression)
    let currentPmProjectId = null;
    let searchDebounce = null;

    function openProjectManageModal(projectId, projectName) {
        currentPmProjectId = projectId;
        document.getElementById('pm-modal-title').innerText = `ç®¡ç†å›¢é˜Ÿ / Team: ${projectName}`;
        document.getElementById('project-manage-modal').classList.add('open');
        switchPmTab('members');
        loadProjectUsers();
    }

    function closeProjectManageModal() {
        document.getElementById('project-manage-modal').classList.remove('open');
        currentPmProjectId = null;
    }

    function switchPmTab(tabName) {
        document.querySelectorAll('.pm-view').forEach(el => el.style.display = 'none');
        document.getElementById(`pm-view-${tabName}`).style.display = 'block';
        document.querySelectorAll('.pm-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`pm-tab-${tabName}`).classList.add('active');
    }

    async function loadProjectUsers() {
        if(!currentPmProjectId) return;
        try {
            const res = await fetch(`/projects/api/${currentPmProjectId}/users/`);
            if(!res.ok) throw new Error('Failed to load users');
            const data = await res.json();
            renderUserList('members', data.members, true);
            renderUserList('managers', data.managers, true);
            renderOwner(data.owner);
        } catch (e) {
            console.error(e);
            showToast('åŠ è½½å¤±è´¥ / Load failed', 'error');
        }
    }

    function renderUserList(type, users, isRemovable=false) {
        const container = document.getElementById(`pm-list-${type}`);
        container.innerHTML = '';
        if(!users || users.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:12px; color:var(--text-muted); font-size:13px;">æš‚æ— äººå‘˜ / Empty</div>';
            return;
        }
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-list-item';
            let actionHtml = '';
            if(isRemovable) {
                const apiAction = type === 'managers' ? 'remove_manager' : 'remove_member';
                actionHtml = `<button class="btn-remove" onclick="updateProjectMember('${apiAction}', ${u.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
            }
            div.innerHTML = `
                <div class="user-list-info">
                    <div class="user-list-avatar">${u.avatar_char}</div>
                    <div>
                        <div style="font-size:13px; font-weight:600;">${u.full_name}</div>
                        <div style="font-size:11px; color:var(--text-secondary);">@${u.username}</div>
                    </div>
                </div>
                ${actionHtml}
            `;
            container.appendChild(div);
        });
    }

    function renderOwner(user) {
        const container = document.getElementById('pm-current-owner');
        if(user) {
            container.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:10px;"><div class="user-list-avatar" style="width:40px; height:40px; font-size:16px;">${user.avatar_char}</div><div>${user.full_name} (@${user.username})</div></div>`;
        } else {
            container.innerHTML = '<span style="color:var(--text-muted)">None</span>';
        }
    }

    function handleUserSearch(type, query) {
        if(searchDebounce) clearTimeout(searchDebounce);
        const container = document.getElementById(`pm-results-${type}`);
        if(!query.trim()) { container.style.display = 'none'; return; }
        
        searchDebounce = setTimeout(async () => {
            try {
                const res = await fetch(`{% url 'core:user_search_api' %}?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                container.innerHTML = '';
                if(data.results && data.results.length > 0) {
                    data.results.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.innerHTML = `<div class="user-list-avatar" style="width:24px; height:24px; font-size:10px;">${(u.full_name||u.username)[0].toUpperCase()}</div><div>${u.full_name || u.username} <span style="color:var(--text-muted)">@${u.username}</span></div>`;
                        div.onclick = () => {
                            let apiAction = '';
                            if(type === 'members') apiAction = 'add_member';
                            else if(type === 'managers') apiAction = 'add_manager';
                            else if(type === 'owner') apiAction = 'set_owner';
                            updateProjectMember(apiAction, u.id);
                            container.style.display = 'none';
                            document.getElementById(`pm-search-${type}`).value = '';
                        };
                        container.appendChild(div);
                    });
                    container.style.display = 'block';
                } else {
                    container.innerHTML = '<div style="padding:8px; font-size:12px; color:var(--text-muted); text-align:center;">No users found</div>';
                    container.style.display = 'block';
                }
            } catch(e) { console.error(e); }
        }, 300);
    }

    async function updateProjectMember(action, userId) {
        if(action === 'set_owner' && !confirm('ç¡®å®šè¦è½¬ç§»é¡¹ç›®è´Ÿè´£äººå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼ˆé™¤éç®¡ç†å‘˜å¹²é¢„ï¼‰ã€‚\nAre you sure to transfer ownership?')) return;
        const formData = new FormData();
        formData.append('action', action);
        formData.append('user_id', userId);
        try {
            const res = await fetch(`/projects/api/${currentPmProjectId}/manage-members/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                body: formData
            });
            const data = await res.json();
            if(data.status === 'success') {
                loadProjectUsers();
                if(data.message) showToast(data.message);
            } else {
                showToast(data.error || 'Operation failed', 'error');
            }
        } catch(e) {
            console.error(e);
            showToast('Request failed', 'error');
        }
    }

    // HR Modal Logic
    {% if request.user.is_superuser %}
    function updateFeeSymbol(currency) {
        const symbol = currency === 'USDT' ? 'â‚®' : 'Â¥';
        document.getElementById('hr-fee-symbol').innerText = symbol;
    }

    function openHRModal(userId, userName, data) {
        document.getElementById('hr-modal-title').innerText = `ç¼–è¾‘æˆå‘˜äººäº‹ä¿¡æ¯ - ${userName}`;
        document.getElementById('hr-user-id').value = userId;
        document.getElementById('hr-status').value = data.employment_status;
        document.getElementById('hr-hire-date').value = data.hire_date || '';
        document.getElementById('hr-probation-months').value = data.probation_months;
        document.getElementById('hr-probation-salary').value = data.probation_salary || '';
        document.getElementById('hr-official-salary').value = data.official_salary || '';
        document.getElementById('hr-salary-currency').value = data.salary_currency || 'CNY';
        document.getElementById('hr-resignation-date').value = data.resignation_date || '';
        document.getElementById('hr-note').value = data.hr_note || '';
        
        // Intermediary fields
        document.getElementById('hr-intermediary-company').value = data.intermediary_company || '';
        document.getElementById('hr-intermediary-fee-amount').value = data.intermediary_fee_amount || '';
        document.getElementById('hr-intermediary-fee-currency').value = data.intermediary_fee_currency || 'CNY';
        updateFeeSymbol(data.intermediary_fee_currency || 'CNY');

        document.getElementById('hr-error-msg').style.display = 'none';
        // Reset field highlights
        document.querySelectorAll('#hr-form .form-input, #hr-form .form-select').forEach(el => el.style.borderColor = '');

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('hr-hire-date').max = today;
        document.getElementById('hr-manage-modal').classList.add('open');
    }

    function closeHRModal() {
        document.getElementById('hr-manage-modal').classList.remove('open');
    }

    async function saveHRInfo(e) {
        e.preventDefault();
        const btn = document.getElementById('hr-save-btn');
        const originalText = btn.innerText;
        btn.innerText = 'ä¿å­˜ä¸­... / Saving...';
        btn.disabled = true;
        
        // Reset field highlights
        document.querySelectorAll('#hr-form .form-input, #hr-form .form-select').forEach(el => el.style.borderColor = '');
        
        const userId = document.getElementById('hr-user-id').value;
        const data = {
            employment_status: document.getElementById('hr-status').value,
            hire_date: document.getElementById('hr-hire-date').value,
            probation_months: document.getElementById('hr-probation-months').value,
            probation_salary: document.getElementById('hr-probation-salary').value,
            official_salary: document.getElementById('hr-official-salary').value,
            salary_currency: document.getElementById('hr-salary-currency').value,
            resignation_date: document.getElementById('hr-resignation-date').value,
            hr_note: document.getElementById('hr-note').value,
            intermediary_company: document.getElementById('hr-intermediary-company').value,
            intermediary_fee_amount: document.getElementById('hr-intermediary-fee-amount').value,
            intermediary_fee_currency: document.getElementById('hr-intermediary-fee-currency').value
        };

        // Client side joint validation
        let clientErrors = [];
        const hasCompany = data.intermediary_company.trim() !== '';
        const hasFee = data.intermediary_fee_amount !== '' && parseFloat(data.intermediary_fee_amount) > 0;
        
        if ((hasCompany && !hasFee) || (!hasCompany && hasFee)) {
            clientErrors.push('å¡«å†™ä¸­ä»‹è´¹ç”¨æ—¶ï¼Œå¿…é¡»åŒæ—¶å¡«å†™ä¸­ä»‹å…¬å¸ä¸è´§å¸å•ä½');
            document.getElementById('hr-intermediary-company').style.borderColor = 'var(--danger)';
            document.getElementById('hr-intermediary-fee-amount').style.borderColor = 'var(--danger)';
        }

        if (clientErrors.length > 0) {
            const errorDiv = document.getElementById('hr-error-msg');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = clientErrors.join('<br>');
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        try {
            const res = await fetchWithRetry(`/reports/api/admin/members/${userId}/hr-info/`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                const row = document.getElementById(`row-${userId}`);
                if (row) {
                    // ... existing row update logic ...
                     const statusCell = row.cells[3];
                     const statusText = data.employment_status === 'active' ? 'åœ¨èŒ' : 'ç¦»èŒ';
                     const statusClass = data.employment_status === 'active' ? 'status-active' : 'status-inactive';
                     statusCell.innerHTML = `<span class="status-indicator"><span class="status-dot ${statusClass}"></span> ${statusText}</span>`;
                     row.cells[4].innerText = data.hire_date || '--';
                     row.cells[5].innerText = data.probation_months + ' Mo.';
                     const pSal = data.probation_salary ? parseFloat(data.probation_salary).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
                     const oSal = data.official_salary ? parseFloat(data.official_salary).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
                     row.cells[6].innerHTML = `<div style="font-size: 12px;"><div>P: ${pSal} ${data.salary_currency}</div><div>O: ${oSal} ${data.salary_currency}</div></div>`;
                     row.cells[7].innerText = data.hr_note || '--';
                     row.cells[7].title = data.hr_note || '';
                     const btn = row.cells[8].querySelector('.btn-primary');
                     if(btn) {
                        const oldOnclick = btn.getAttribute('onclick');
                        const match = oldOnclick.match(/openHRModal\(\d+, "(.*?)",/);
                        if(match) {
                            const name = match[1];
                            const jsonStr = JSON.stringify(data).replace(/"/g, "&quot;");
                            btn.setAttribute('onclick', `openHRModal(${userId}, "${name}", ${jsonStr})`);
                        }
                     }
                }
                closeHRModal();
                showToast('äººäº‹ä¿¡æ¯å·²ä¿å­˜ / HR Info Saved');
            } else {
                const errorDiv = document.getElementById('hr-error-msg');
                errorDiv.style.display = 'block';
                if (result.errors) {
                    let msg = '';
                    for (const [key, val] of Object.entries(result.errors)) { msg += `${val}<br>`; }
                    errorDiv.innerHTML = msg;
                } else {
                    errorDiv.innerText = result.error || 'ä¿å­˜å¤±è´¥ / Save failed';
                }
            }
        } catch (err) {
            console.error(err);
            showToast('ç½‘ç»œé”™è¯¯ / Network error', 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    {% endif %}

</script>
{% endblock %}