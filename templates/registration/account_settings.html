{% extends 'base_topbar.html' %}
{% load static %}

{% block title %}个人中心 / Personal Center{% endblock %}

{% block nav_header %}
    {% include "partials/nav.html" with nav_title="个人中心 / Personal Center" nav_subtitle="管理您的个人信息、安全设置和通知偏好" %}
{% endblock %}

{% block extra_styles %}
<style>
    /* --- Design System (Consistent with Admin Task List) --- */
    :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-hover: #1d4ed8;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background-color: var(--bg-page);
        color: var(--text-main);
    }

    /* --- Page Header --- */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 800;
        color: var(--text-main);
        margin: 0 0 4px 0;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0;
    }

    /* --- Main Settings Container (Single White Module) --- */
    .settings-container {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        display: flex;
        min-height: 600px;
        overflow: hidden;
    }

    /* --- Sidebar Navigation --- */
    .settings-sidebar {
        width: 260px;
        background: #f1f5f9;
        border-right: 1px solid var(--border-color);
        padding: 24px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        border: 1px solid transparent;
    }

    .nav-item:hover {
        background-color: #e2e8f0;
        color: var(--text-main);
    }

    .nav-item.active {
        background-color: #ffffff;
        color: var(--primary);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
        font-weight: 700;
    }

    .nav-item svg {
        width: 18px;
        height: 18px;
    }

    /* --- Content Area --- */
    .settings-content {
        flex: 1;
        padding: 32px 40px;
        overflow-y: auto;
        background-color: #ffffff;
    }

    .tab-pane {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    .tab-pane.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(4px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 8px 0;
    }

    .section-desc {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0;
    }

    /* --- Overview Cards (Inside Content) --- */
    .overview-card {
        display: flex;
        align-items: center;
        gap: 24px;
        padding: 24px;
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
        box-shadow: var(--shadow-sm);
    }

    .user-avatar-lg {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-light);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 800;
        border: 1px solid rgba(37,99,235,0.2);
        overflow: hidden;
    }

    .user-avatar-lg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* --- Forms & Inputs --- */
    .form-group {
        margin-bottom: 20px;
        max-width: 480px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        background-color: #fff;
        color: var(--text-main);
    }

    .form-input:hover {
        border-color: #94a3b8;
    }

    .form-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        outline: none;
    }

    .form-input:disabled {
        background-color: #f1f5f9;
        cursor: not-allowed;
        color: var(--text-muted);
    }

    /* --- Buttons --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
        white-space: nowrap;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { border-color: #cbd5e1; background: #f8fafc; }

    /* --- Helpers --- */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        line-height: 1.5;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
    }
    .badge-container {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        min-width: 0;
    }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-warning { background: #ffedd5; color: #f97316; }

    /* Responsive text truncation for very small screens */
    @media (max-width: 375px) {
        .badge {
            max-width: 140px; /* Ensure 2 badges can stack or 1 badge fits */
        }
    }

    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        line-height: 1.5;
        margin-bottom: 24px;
        max-width: 600px;
    }
    .alert-warning { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
    .alert-success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }

    .help-text { font-size: 12px; color: var(--text-secondary); margin-top: 6px; }
    .text-danger { color: var(--danger); }
    .text-success { color: var(--success); }

    .password-strength-meter { height: 4px; background-color: #e2e8f0; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .password-strength-bar { height: 100%; width: 0; transition: width 0.3s ease, background-color 0.3s ease; }
    .strength-text { font-size: 11px; margin-top: 4px; text-align: right; font-weight: 500; color: var(--text-secondary); }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        .settings-container { flex-direction: column; min-height: auto; }
        .settings-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); flex-direction: row; overflow-x: auto; padding: 12px; }
        .nav-item { white-space: nowrap; padding: 8px 12px; }
        .settings-content { padding: 24px; }
        .overview-card { flex-direction: column; text-align: center; }
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto; padding-bottom: 60px;">

    <!-- Page Header (Outside) -->
    <div class="page-header">
        <div>
            <h1 class="page-title">个人中心 / Personal Center</h1>
            <p class="page-subtitle">管理您的个人信息、安全设置和通知偏好 / Manage your profile, security and preferences</p>
        </div>
    </div>

    <!-- Single White Module -->
    <div class="settings-container">
        <!-- Sidebar -->
        <nav class="settings-sidebar">
            <div class="nav-item active" onclick="switchTab('overview')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"></circle><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path></svg>
                概览 / Overview
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                个人资料 / Profile
            </div>
            <div class="nav-item" onclick="switchTab('security')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                账户安全 / Security
            </div>
            <div class="nav-item" onclick="switchTab('email')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                邮箱验证 / Email
            </div>
            <div class="nav-item" onclick="switchTab('privacy')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                隐私设置 / Privacy
            </div>
            <div class="nav-item" onclick="switchTab('notify')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                通知偏好 / Notifications
            </div>
        </nav>

        <!-- Content -->
        <div class="settings-content">
            
            <!-- Tab: Overview -->
            <div id="tab-overview" class="tab-pane active">
                <div class="section-header">
                    <h2 class="section-title">概览 / Overview</h2>
                    <p class="section-desc">您的账户状态与基本信息摘要 / Summary of your account status.</p>
                </div>

                <div class="overview-card">
                    <div class="user-avatar-lg" id="overview-avatar">
                        {% if user.profile.avatar_url %}
                        <img src="{{ user.profile.avatar_url }}" alt="Avatar">
                        {% else %}
                        {{ user.username|slice:":1"|upper }}
                        {% endif %}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <h3 style="margin: 0 0 4px 0; font-size: 18px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ user.get_full_name|default:user.username }}</h3>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ user.email }}</div>
                        <div class="badge-container">
                            <span class="badge" style="background: #f1f5f9; color: var(--text-secondary);" title="角色: {{ user.profile.get_position_display|default:'-' }}">角色: {{ user.profile.get_position_display|default:"-" }}</span>
                            {% if user.profile.email_verified %}
                            <span class="badge badge-success" title="已验证 / Verified">已验证 / Verified</span>
                            {% else %}
                            <span class="badge badge-warning" title="未验证 / Unverified">未验证 / Unverified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div style="text-align: right; min-width: 140px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">注册时间 / Joined</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">{{ user.date_joined|date:"Y-m-d" }}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">上次登录 / Last Login</div>
                        <div style="font-weight: 600;">{{ user.last_login|date:"Y-m-d"|default:"-" }}</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="padding: 20px; background: #ffffff; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">本周日报 / Reports this week</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--primary);">{{ week_report_count|default:"0" }}</div>
                    </div>
                    <div style="padding: 20px; background: #ffffff; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">参与项目 / Projects</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--text-main);">{{ project_count|default:"0" }}</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Profile -->
            <div id="tab-profile" class="tab-pane">
                <div class="section-header">
                    <h2 class="section-title">个人资料 / Profile</h2>
                    <p class="section-desc">管理您的公开信息和用户名 / Manage your public profile.</p>
                </div>

                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_name">
                    <div class="form-group">
                        <label class="form-label">用户名 / Username (ID)</label>
                        <input type="text" class="form-input" value="{{ user.username }}" disabled style="background-color: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                        <div class="help-text">用户名用于登录，不可更改 / Username is used for login and cannot be changed.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">当前姓名 / Current Name</label>
                        <div style="font-size: 15px; font-weight: 500; padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; color: var(--text-main);">
                            {{ user.get_full_name|default:"-" }}
                        </div>
                        <div class="help-text">姓名（昵称），用于前端展示，便于识别 / Name (Nickname), used for frontend display for easy identification</div>
                    </div>
                    <div class="form-group">
                        <label for="{{ name_form.full_name.id_for_label }}" class="form-label">新姓名 / New Name</label>
                        {{ name_form.full_name }}
                        {% if name_form.full_name.errors %}
                        <div class="help-text text-danger">{{ name_form.full_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ name_form.password.id_for_label }}" class="form-label">当前密码 / Current Password</label>
                        {{ name_form.password }}
                        {% if name_form.password.errors %}
                        <div class="help-text text-danger">{{ name_form.password.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary">保存姓名更改 / Save Name</button>
                </form>

                <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 32px 0;">

                <div class="form-group">
                    <label class="form-label">头像 / Avatar</label>
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <div class="user-avatar-lg" id="avatar-preview" style="width: 64px; height: 64px; font-size: 24px;">
                            {% if user.profile.avatar_url %}
                            <img src="{{ user.profile.avatar_url }}" alt="Avatar">
                            {% else %}
                            {{ user.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <label class="btn btn-secondary" style="cursor: pointer;">
                            上传新头像 / Upload New
                            <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                        </label>
                    </div>
                </div>

                <button type="button" id="profile-pref-save" class="btn btn-secondary">保存资料偏好 / Save Preferences</button>
            </div>

            <!-- Tab: Security -->
            <div id="tab-security" class="tab-pane">
                <div class="section-header">
                    <h2 class="section-title">账户安全 / Security</h2>
                    <p class="section-desc">保护您的账户，定期更新密码 / Protect your account.</p>
                </div>

                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_password">
                    {% for field in password_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="help-text text-danger">{{ field.errors.0 }}</div>
                        {% endif %}
                        {% if field.name == 'new_password1' %}
                        <div class="password-strength-meter"><div class="password-strength-bar" id="strength-bar"></div></div>
                        <div class="strength-text" id="strength-text"></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary">更新密码 / Update Password</button>
                </form>
            </div>

            <!-- Tab: Email -->
            <div id="tab-email" class="tab-pane">
                <div class="section-header">
                    <h2 class="section-title">邮箱验证 / Email</h2>
                    <p class="section-desc">验证邮箱以接收重要通知和找回密码 / Verify email for notifications.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">当前邮箱 / Current Email</label>
                    <div style="font-size: 15px; font-weight: 500;">{{ user.email }}</div>
                    {% if user.profile.email_verified %}
                    <div class="help-text text-success">✓ 已验证 / Verified</div>
                    {% else %}
                    <div class="help-text text-danger">! 未验证 / Unverified</div>
                    {% endif %}
                </div>

                <form method="post" id="email-form" style="margin-top: 24px;">
                    {% csrf_token %}
                    {% if pending_email %}
                        <div class="alert alert-warning">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            <div>验证码已发送至 / Code sent to <strong>{{ pending_email.email }}</strong></div>
                        </div>
                        <input type="hidden" name="email" value="{{ pending_email.email }}">
                    {% else %}
                        <div class="form-group">
                            <label for="{{ email_request_form.email.id_for_label }}" class="form-label">新邮箱地址 / New Email</label>
                            {{ email_request_form.email }}
                            {% if email_request_form.email.errors %}
                            <div class="help-text text-danger">{{ email_request_form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                    <div class="form-group">
                        <label for="{{ email_confirm_form.code.id_for_label }}" class="form-label">验证码 / Code</label>
                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1;">{{ email_confirm_form.code }}</div>
                            <button type="button" id="send-code-btn" class="btn btn-secondary" style="width: auto;">
                                {% if pending_email %}重发 / Resend{% else %}获取 / Get Code{% endif %}
                            </button>
                        </div>
                        {% if email_confirm_form.code.errors %}
                        <div class="help-text text-danger">{{ email_confirm_form.code.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" name="action" value="update_email" class="btn btn-primary">确认验证并更新 / Verify & Update</button>
                </form>
            </div>

            <!-- Tab: Privacy -->
            <div id="tab-privacy" class="tab-pane">
                <div class="section-header">
                    <h2 class="section-title">隐私设置 / Privacy</h2>
                    <p class="section-desc">控制您的信息在团队中的可见性 / Control visibility.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">公开信息 / Public Info</label>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input id="privacy-show-email" type="checkbox">
                            <span style="font-size: 14px;">公开显示邮箱 / Show Email</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input id="privacy-show-role" type="checkbox">
                            <span style="font-size: 14px;">公开显示角色 / Show Role</span>
                        </label>
                    </div>
                </div>
                <button type="button" id="privacy-save" class="btn btn-secondary">保存隐私偏好 / Save Privacy</button>
            </div>

            <!-- Tab: Notify -->
            <div id="tab-notify" class="tab-pane">
                <div class="section-header">
                    <h2 class="section-title">通知偏好 / Notifications</h2>
                    <p class="section-desc">选择您希望接收通知的方式 / Notification channels.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">通知渠道 / Channels</label>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input id="notify-email-digest" type="checkbox">
                            <span style="font-size: 14px;">邮件周报（绩效简报）/ Email Digest</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input id="notify-inapp" type="checkbox">
                            <span style="font-size: 14px;">站内通知（任务与日报提醒）/ In-App Notifications</span>
                        </label>
                    </div>
                </div>
                <button type="button" id="notify-save" class="btn btn-secondary">保存通知偏好 / Save Notifications</button>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Tabs Logic ---
    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const activeItem = document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`);
        if (activeItem) activeItem.classList.add('active');

        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        const activePane = document.getElementById(`tab-${tabName}`);
        if (activePane) activePane.classList.add('active');

        localStorage.setItem('settings_tab', tabName);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const savedTab = localStorage.getItem('settings_tab') || 'overview';
        switchTab(savedTab);

        // --- Styles & Validation ---
        const inputs = document.querySelectorAll('input[type="text"], input[type="password"], input[type="email"]');
        inputs.forEach(input => { if (!input.classList.contains('form-input')) { input.classList.add('form-input'); } });

        // --- Username Check ---
        const usernameInput = document.querySelector('input[name="username"]');
        const feedbackDiv = document.getElementById('username-feedback');
        if (usernameInput) {
            let timeout = null;
            usernameInput.addEventListener('input', function() {
                const username = this.value;
                clearTimeout(timeout);
                if (username.length > 0) {
                    timeout = setTimeout(() => {
                        fetch('{% url "core:username_check_api" %}?username=' + encodeURIComponent(username))
                            .then(response => response.json())
                            .then(data => {
                                const taken = (data.is_taken === true) || (data.available === false);
                                if (taken) {
                                    feedbackDiv.textContent = '用户名已被占用';
                                    feedbackDiv.className = 'help-text text-danger';
                                    usernameInput.style.borderColor = 'var(--danger)';
                                } else {
                                    feedbackDiv.textContent = '用户名可用';
                                    feedbackDiv.className = 'help-text text-success';
                                    usernameInput.style.borderColor = 'var(--success)';
                                }
                            });
                    }, 500);
                } else {
                    feedbackDiv.textContent = '';
                    usernameInput.style.borderColor = '';
                }
            });
        }

        // --- Password Meter ---
        const passwordInput = document.querySelector('input[name="new_password1"]');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0, color = '#e2e8f0', text = '';
                if (password.length > 0) {
                    if (password.length >= 8) strength += 1;
                    if (/[a-z]+/.test(password)) strength += 1;
                    if (/[A-Z]+/.test(password)) strength += 1;
                    if (/[0-9]+/.test(password)) strength += 1;
                    if (/[$@#&!]+/.test(password)) strength += 1;
                    if (strength <= 2) { color = 'var(--danger)'; text = '弱'; }
                    else if (strength <= 4) { color = 'var(--warning)'; text = '中'; }
                    else { color = 'var(--success)'; text = '强'; }
                }
                strengthBar.style.width = (strength * 20) + '%';
                strengthBar.style.backgroundColor = color;
                strengthText.textContent = text;
                strengthText.style.color = color;
            });
        }

        // --- Preferences API ---
        function prefGet(key, cb) {
            const url = '{% url "reports:preference_get_api" %}' + (key ? ('?key=' + encodeURIComponent(key)) : '');
            fetch(url).then(r => r.json()).then(d => cb && cb(d.data || {})).catch(() => cb && cb({}));
        }
        function prefSave(key, value, cb) {
            const formData = new FormData();
            formData.append('key', key);
            formData.append('value', JSON.stringify(value || {}));
            fetch('{% url "reports:preference_save_api" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: formData })
                .then(r => r.json()).then(d => cb && cb(d)).catch(() => cb && cb({ ok: false }));
        }

        // --- Load Prefs ---
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const overviewAvatar = document.getElementById('overview-avatar');
        
        prefGet('profile', (data) => {
            if (data.avatar_data_url) {
                const imgTag = `<img src="${data.avatar_data_url}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                if (avatarPreview) avatarPreview.innerHTML = imgTag;
                if (overviewAvatar) overviewAvatar.innerHTML = imgTag;
            }
        });

        // --- Save Prefs ---
        const profilePrefSave = document.getElementById('profile-pref-save');
        if (profilePrefSave) {
            profilePrefSave.addEventListener('click', function() {
                const img = avatarPreview.querySelector('img');
                const dataUrl = img ? img.src : '';
                prefSave('profile', { avatar_data_url: dataUrl }, function(resp) {
                    alert(resp.ok ? '保存成功' : '保存失败');
                });
            });
        }

        // --- Avatar Upload ---
        if (avatarInput) {
            avatarInput.addEventListener('change', function() {
                const file = this.files && this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    const imgTag = `<img src="${dataUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    avatarPreview.innerHTML = imgTag;
                    if (overviewAvatar) overviewAvatar.innerHTML = imgTag;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- Other Prefs ---
        const privacyShowEmail = document.getElementById('privacy-show-email');
        const privacyShowRole = document.getElementById('privacy-show-role');
        const privacySave = document.getElementById('privacy-save');
        prefGet('privacy', (data) => {
            if (privacyShowEmail) privacyShowEmail.checked = !!data.show_email;
            if (privacyShowRole) privacyShowRole.checked = !!data.show_role;
        });
        if (privacySave) {
            privacySave.addEventListener('click', () => {
                prefSave('privacy', { show_email: !!privacyShowEmail.checked, show_role: !!privacyShowRole.checked }, (r) => alert(r.ok ? '已保存' : '失败'));
            });
        }

        const notifyEmailDigest = document.getElementById('notify-email-digest');
        const notifyInapp = document.getElementById('notify-inapp');
        const notifySave = document.getElementById('notify-save');
        prefGet('notify', (data) => {
            if (notifyEmailDigest) notifyEmailDigest.checked = !!data.email_digest;
            if (notifyInapp) notifyInapp.checked = !!data.inapp;
        });
        if (notifySave) {
            notifySave.addEventListener('click', () => {
                prefSave('notify', { email_digest: !!notifyEmailDigest.checked, inapp: !!notifyInapp.checked }, (r) => alert(r.ok ? '已保存' : '失败'));
            });
        }

        // --- Email Code ---
        const sendCodeBtn = document.getElementById('send-code-btn');
        if (sendCodeBtn) {
            sendCodeBtn.addEventListener('click', function() {
                const emailInput = document.getElementById('id_email'); // from form
                let email = emailInput ? emailInput.value : '';
                if (!email) {
                    const hiddenEmail = document.querySelector('input[name="email"]');
                    if (hiddenEmail) email = hiddenEmail.value;
                }
                if (!email) { alert('请输入邮箱'); return; }
                
                sendCodeBtn.disabled = true;
                sendCodeBtn.innerText = '发送中...';
                fetch('{% url "core:send_email_code_api" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ email: email })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        alert(data.message);
                        let t = 60;
                        sendCodeBtn.innerText = t + 's';
                        const timer = setInterval(() => {
                            t--; sendCodeBtn.innerText = t + 's';
                            if (t <= 0) { clearInterval(timer); sendCodeBtn.disabled = false; sendCodeBtn.innerText = '重发'; }
                        }, 1000);
                    } else {
                        alert(data.error || '失败');
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.innerText = '重试';
                    }
                }).catch(() => {
                    alert('网络错误');
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerText = '重试';
                });
            });
        }
    });
</script>
{% endblock %}
