<div class="notification-center" id="notification-center">
    <button class="ghost-link icon-btn" id="bell-btn" aria-label="Notifications">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="badge" id="notification-badge" style="display: none;">0</span>
    </button>
    
    <div class="notification-dropdown" id="notification-dropdown">
        <div class="dropdown-header">
            <h3>é€šçŸ¥ / Notifications</h3>
            <button class="text-btn" id="mark-all-read">å…¨éƒ¨å·²è¯» / Mark all read</button>
        </div>
        <div class="notification-list" id="notification-list">
            <div class="empty-state">åŠ è½½ä¸­... / Loading...</div>
        </div>
        <div class="dropdown-footer">
            <a href="{% url 'reports:notification_list' %}">æŸ¥çœ‹å…¨éƒ¨ / View All</a>
        </div>
    </div>
</div>

<style>
    .notification-center {
        position: relative;
    }
    .icon-btn {
        padding: 8px;
        border-radius: 50%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    .badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 2px 5px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        border: 2px solid #fff;
    }
    .badge.pulse {
        animation: pulse-animation 1s infinite;
    }
    @keyframes pulse-animation {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    .notification-dropdown {
        position: absolute;
        top: 110%;
        right: -80px; /* Adjust alignment */
        width: 360px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid rgba(0,0,0,0.05);
        display: none;
        flex-direction: column;
        z-index: 1000;
        max-height: 500px;
    }
    .notification-dropdown.open {
        display: flex;
    }
    .dropdown-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .dropdown-header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
    }
    .text-btn {
        background: none;
        border: none;
        color: #3b82f6;
        font-size: 12px;
        cursor: pointer;
        padding: 0;
    }
    .text-btn:hover {
        text-decoration: underline;
    }
    .notification-list {
        overflow-y: auto;
        flex: 1;
        max-height: 400px;
    }
    .notification-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f8fafc;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }
    .notification-item:hover {
        background: #f8fafc;
    }
    .notification-item.unread {
        background: #eff6ff;
    }
    .notification-item.unread:hover {
        background: #e0f2fe;
    }
    .notif-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .notif-content {
        flex: 1;
    }
    .notif-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #0f172a;
    }
    .notif-msg {
        font-size: 12px;
        color: #64748b;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .notif-time {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 4px;
    }
    .dropdown-footer {
        padding: 10px;
        text-align: center;
        border-top: 1px solid #f1f5f9;
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }
    .dropdown-footer a {
        font-size: 12px;
        color: #64748b;
        text-decoration: none;
    }
    .empty-state {
        padding: 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 13px;
    }
    
    @media (max-width: 640px) {
        .notification-dropdown {
            position: fixed;
            top: 60px;
            left: 10px;
            right: 10px;
            width: auto;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const bellBtn = document.getElementById('bell-btn');
        const dropdown = document.getElementById('notification-dropdown');
        const list = document.getElementById('notification-list');
        const badge = document.getElementById('notification-badge');
        const markAllBtn = document.getElementById('mark-all-read');
        let socket = null;
        let isOpen = false;

        // Toggle Dropdown
        bellBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            isOpen = !isOpen;
            dropdown.classList.toggle('open', isOpen);
            if (isOpen) {
                fetchNotifications();
            }
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (isOpen && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
                isOpen = false;
                dropdown.classList.remove('open');
            }
        });

        // Fetch Notifications via API
        function fetchNotifications() {
            fetch("{% url 'reports:notification_list_api' %}")
                .then(response => response.json())
                .then(data => {
                    renderList(data.notifications);
                    updateBadge(data.unread_count);
                });
        }

        function updateBadge(count) {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
                // Add pulse animation
                badge.classList.add('pulse');
                setTimeout(() => badge.classList.remove('pulse'), 1000);
            } else {
                badge.style.display = 'none';
            }
        }

        function renderList(notifications) {
            if (notifications.length === 0) {
                list.innerHTML = '<div class="empty-state">æš‚æ— é€šçŸ¥ / No notifications</div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.is_read ? '' : 'unread'} ${n.priority === 'high' ? 'priority-high' : ''}" onclick="handleNotificationClick(${n.id}, '${n.notification_type}', '${n.data?.task_id || ''}')">
                    <div class="notif-icon">
                        ${getIcon(n.notification_type, n.priority)}
                    </div>
                    <div class="notif-content">
                        <div class="notif-title">
                            ${n.priority === 'high' ? '<span style="color:#ef4444;margin-right:2px;">!</span>' : ''}
                            ${n.title}
                        </div>
                        <div class="notif-msg">${n.message}</div>
                        <div class="notif-time">${n.time_since}</div>
                    </div>
                </div>
            `).join('');
        }

        function getIcon(type, priority) {
            if (priority === 'high') return 'âš ï¸';
            // Simple SVG icons based on type
            if (type === 'task_assigned') return 'ðŸ“‹';
            if (type === 'task_mention') return '@';
            if (type === 'task_updated') return 'ðŸ“';
            return 'ðŸ””';
        }

        // WebSocket Connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(protocol + '//' + window.location.host + '/ws/notifications/');

            socket.onopen = function(e) {
                // console.log('Notification WebSocket connected');
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                // console.log('New notification:', data);
                
                // Show badge increment
                const current = parseInt(badge.textContent) || 0;
                updateBadge(current + 1);
                
                // If open, prepend to list
                if (isOpen) {
                    // Re-fetch is easiest to keep sort order and format consistent
                    fetchNotifications(); 
                }
                
                // Optional: Sound or Toast
                playNotificationSound();
            };

            socket.onclose = function(e) {
                console.error('WebSocket closed. Reconnecting in 5s...');
                setTimeout(connectWebSocket, 5000);
            };
        }

        function playNotificationSound() {
            // Simple beep or check user preference
            // Audio context logic here if needed
        }

        // Mark All Read
        markAllBtn.addEventListener('click', () => {
            fetch("{% url 'reports:mark_all_read_api' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(() => {
                fetchNotifications();
            });
        });

        // Initialize
        if ("{{ request.user.is_authenticated }}" === "True") {
            fetchNotifications(); // Initial fetch for badge
            connectWebSocket();
        }

        // Global handler for click (needs to be attached to window or handled via event delegation above)
        window.handleNotificationClick = function(id, type, targetId) {
            // Mark read
            fetch(`/reports/api/notifications/${id}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(() => {
                // Redirect logic
                if (type.startsWith('task') && targetId) {
                    window.location.href = `/tasks/${targetId}/view/`;
                } else {
                    // Default redirect or just refresh
                    fetchNotifications();
                }
            });
        };
    });
</script>
