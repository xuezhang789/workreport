{% extends 'base_topbar.html' %}
{% load static %}

{% block title %}ä¸ªäººä¸­å¿ƒ / Personal Center{% endblock %}

{% block nav_header %}
    {% include "partials/nav.html" with nav_title="ä¸ªäººä¸­å¿ƒ / Personal Center" nav_subtitle="æŸ¥çœ‹æ‚¨çš„ä¸ªäººä¿¡æ¯ã€å·¥ä½œç»Ÿè®¡å’Œè´¦æˆ·è®¾ç½®" %}
{% endblock %}

{% block extra_styles %}
<style>
    /* === Enhanced Design System with Premium Gradients === */
    :root {
        --primary: #2563eb;
        --primary-2: #3b82f6;
        --primary-3: #60a5fa;
        --accent: #06b6d4;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --bg-page: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --bg-card: rgba(255, 255, 255, 0.95);
        --bg-glass: rgba(255, 255, 255, 0.25);
        --border-color: rgba(255, 255, 255, 0.18);
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
        --shadow-md: 0 8px 32px rgba(0,0,0,0.1);
        --shadow-lg: 0 16px 48px rgba(0,0,0,0.15);
        --shadow-xl: 0 24px 64px rgba(0,0,0,0.2);
        --radius-md: 12px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: var(--bg-page);
        color: var(--text-main);
        min-height: 100vh;
        position: relative;
        font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        z-index: -2;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.2) 0%, transparent 50%);
        z-index: -1;
        animation: gradientShift 10s ease-in-out infinite;
    }

    @keyframes gradientShift {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* === Hero Section === */
    .user-hero {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        border: 1px solid var(--border-color);
        padding: 40px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
    }

    .user-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
        animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .hero-content {
        display: flex;
        align-items: center;
        gap: 32px;
        position: relative;
        z-index: 2;
    }

    .user-avatar-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }

    .user-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: 700;
        color: white;
        position: relative;
        box-shadow: var(--shadow-lg);
        transition: var(--transition);
    }

    .user-avatar:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-xl);
    }

    .avatar-badge {
        position: absolute;
        bottom: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--success);
        border: 3px solid white;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .user-info {
        flex: 1;
        color: white;
    }

    .user-name {
        font-size: 32px;
        font-weight: 800;
        margin: 0 0 8px 0;
        background: linear-gradient(135deg, #fff, rgba(255,255,255,0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .user-role {
        display: inline-block;
        padding: 6px 16px;
        background: rgba(255,255,255,0.2);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 16px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .user-stats-row {
        display: flex;
        gap: 32px;
        margin-top: 24px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 800;
        color: white;
    }

    .stat-label {
        font-size: 12px;
        color: rgba(255,255,255,0.8);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* === Quick Actions === */
    .quick-actions {
        position: absolute;
        top: 40px;
        right: 40px;
        display: flex;
        gap: 12px;
    }

    .quick-action-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: var(--transition);
    }

    .quick-action-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-2px);
    }

    /* === Stats Cards Grid === */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        background: rgba(255, 255, 255, 0.35);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        opacity: 0;
        transition: var(--transition);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        background: linear-gradient(135deg, var(--primary), var(--accent));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-bottom: 16px;
        font-size: 24px;
    }

    .stat-card-title {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
    }

    .stat-card-value {
        font-size: 32px;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    .stat-card-change {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .stat-change-positive {
        color: var(--success);
    }

    .stat-change-negative {
        color: var(--danger);
    }

    /* === Settings Section === */
    .settings-section {
        margin-top: 32px;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 24px;
        font-weight: 800;
        color: white;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-subtitle {
        color: rgba(255,255,255,0.7);
        font-size: 14px;
        margin-top: 4px;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 24px;
    }

    .settings-card {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: var(--transition);
        position: relative;
    }

    .settings-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-xl);
        background: rgba(255, 255, 255, 0.35);
    }

    .card-status-bar {
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        width: 0;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-card:hover .card-status-bar {
        width: 100%;
    }
    .card-status-bar.active { background: linear-gradient(90deg, var(--primary), var(--accent)); }
    .card-status-bar.warning { background: linear-gradient(90deg, var(--warning), var(--danger)); }
    .card-status-bar.success { background: linear-gradient(90deg, var(--success), var(--accent)); }

    .card-body {
        padding: 28px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
        z-index: 2;
    }

    .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .card-title {
        font-size: 18px;
        font-weight: 800;
        margin: 0;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-icon {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 6px;
        color: white;
        padding: 4px;
    }

    /* === Enhanced Form Elements === */
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .required-indicator {
        color: var(--danger);
        font-weight: 800;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: var(--radius-md);
        font-size: 14px;
        transition: var(--transition);
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        color: var(--text-main);
        font-weight: 500;
    }

    .form-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        outline: none;
        background: white;
        transform: translateY(-2px);
    }

    .form-input:disabled {
        background: rgba(255,255,255,0.5);
        cursor: not-allowed;
        color: var(--text-muted);
        opacity: 0.7;
    }

    .form-input:hover:not(:disabled) {
        border-color: var(--accent);
        background: white;
    }

    /* === Premium Buttons === */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
        border: none;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
        background: rgba(255,255,255,0.9);
        color: var(--text-main);
        border: 2px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
    }

    .btn-secondary:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* === Premium Badges & Alerts === */
    .badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
    }
    
    .badge-success { 
        background: linear-gradient(135deg, var(--success), rgba(16, 185, 129, 0.8)); 
        color: white;
    }
    
    .badge-warning { 
        background: linear-gradient(135deg, var(--warning), rgba(245, 158, 11, 0.8)); 
        color: white;
    }

    .alert {
        padding: 16px 20px;
        border-radius: var(--radius-md);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 12px;
        line-height: 1.5;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
    }
    
    .alert-warning { 
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); 
        color: var(--warning); 
        border-color: rgba(245, 158, 11, 0.3);
    }
    
    .alert-success { 
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1)); 
        color: var(--success); 
        border-color: rgba(16, 185, 129, 0.3);
    }

    .help-text {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 6px;
        font-weight: 500;
    }
    
    .text-danger { color: var(--danger); font-weight: 600; }
    .text-success { color: var(--success); font-weight: 600; }

    /* === Enhanced Password Meter === */
    .password-strength-meter {
        height: 6px;
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(10px);
    }
    
    .password-strength-bar {
        height: 100%;
        width: 0;
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.4s ease;
        border-radius: 3px;
        position: relative;
        overflow: hidden;
    }
    
    .password-strength-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }
    
    .strength-text {
        font-size: 11px;
        margin-top: 6px;
        text-align: right;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* === Responsive Design === */
    @media (max-width: 860px) {
        .hero-content {
            flex-direction: column;
            text-align: center;
            gap: 24px;
        }
        
        .quick-actions {
            position: static;
            justify-content: center;
            margin-top: 20px;
        }
        
        .user-stats-row {
            justify-content: center;
            flex-wrap: wrap;
            gap: 24px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .settings-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .user-hero {
            padding: 24px;
        }
    }

    @media (max-width: 480px) {
        .user-name {
            font-size: 24px;
        }
        
        .stat-card-value {
            font-size: 24px;
        }
        
        .section-title {
            font-size: 20px;
        }
        
        .user-avatar {
            width: 100px;
            height: 100px;
            font-size: 40px;
        }
    }

    /* === Loading States === */
    .loading {
        position: relative;
        overflow: hidden;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { left: -100%; }
        100% { left: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px 40px 40px;">

    <!-- Hero Section -->
    <section class="user-hero">
        <div class="hero-content">
            <div class="user-avatar-section">
                <div class="user-avatar">
                    {{ user.username|slice:":1"|upper }}
                    <div class="avatar-badge"></div>
                </div>
                <div class="user-role">{{ user.profile.get_position_display }}</div>
            </div>
            
            <div class="user-info">
                <h1 class="user-name">{{ user.username }}</h1>
                <p class="section-subtitle">{{ user.email }}</p>
                <div class="user-stats-row">
                    <div class="stat-item">
                        <div class="stat-value">{{ week_report_count }}</div>
                        <div class="stat-label">æœ¬å‘¨æ—¥æŠ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ completion_rate }}%</div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ total_report_count }}</div>
                        <div class="stat-label">æ€»æ—¥æŠ¥æ•°</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="quick-action-btn" title="ç¼–è¾‘èµ„æ–™">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </button>
            <button class="quick-action-btn" title="æ¶ˆæ¯é€šçŸ¥">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
            </button>
            <button class="quick-action-btn" title="è®¾ç½®">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </section>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-card-title">ä»Šæ—¥ä»»åŠ¡</div>
            <div class="stat-card-value">{{ week_report_count }}</div>
            <div class="stat-card-change stat-change-positive">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                æœ¬å‘¨å·²å®Œæˆ
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-card-title">æœ¬æœˆå®Œæˆ</div>
            <div class="stat-card-value">{{ month_report_count }}</div>
            <div class="stat-card-change stat-change-positive">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                ç´¯è®¡å®Œæˆ
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">â±ï¸</div>
            <div class="stat-card-title">å®Œæˆç‡</div>
            <div class="stat-card-value">{{ completion_rate }}%</div>
            <div class="stat-card-change {% if completion_rate >= 80 %}stat-change-positive{% else %}stat-change-negative{% endif %}">
                {% if completion_rate >= 80 %}
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    ä¼˜ç§€è¡¨ç°
                {% else %}
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    éœ€è¦æå‡
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-card-title">é¡¹ç›®å‚ä¸</div>
            <div class="stat-card-value">{{ project_count }}</div>
            <div class="stat-card-change stat-change-positive">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                å‚ä¸é¡¹ç›®
            </div>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="settings-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">
                    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    è´¦æˆ·è®¾ç½®
                </h2>
                <p class="section-subtitle">ç®¡ç†æ‚¨çš„åŸºæœ¬ä¿¡æ¯ã€å®‰å…¨è®¾ç½®å’Œåå¥½é…ç½®</p>
            </div>
        </div>

        <div class="settings-grid">
        
        <!-- Profile Card -->
        <article class="settings-card">
            <div class="card-status-bar active"></div>
            <div class="card-body">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        åŸºæœ¬èµ„æ–™
                    </h3>
                </div>
                
                <form method="post" style="display: flex; flex-direction: column; gap: 20px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_username">
                    
                    <div class="form-group">
                        <label class="form-label">å½“å‰ç”¨æˆ·å</label>
                        <input type="text" class="form-input" value="{{ user.username }}" disabled>
                    </div>

                    <div class="form-group">
                        <label for="{{ username_form.new_username.id_for_label }}" class="form-label">
                            æ–°ç”¨æˆ·å <span class="required-indicator">*</span>
                        </label>
                        {{ username_form.new_username }}
                        {% if username_form.new_username.errors %}
                        <div class="help-text text-danger">{{ username_form.new_username.errors.0 }}</div>
                        {% endif %}
                        <div id="username-feedback" class="help-text"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        ä¿å­˜æ›´æ”¹
                    </button>
                </form>
            </div>
        </article>

        <!-- Security Card -->
        <article class="settings-card">
            <div class="card-status-bar warning"></div>
            <div class="card-body">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        å®‰å…¨è®¾ç½®
                    </h3>
                </div>

                <form method="post" style="display: flex; flex-direction: column; gap: 20px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_password">

                    {% for field in password_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }} 
                            {% if 'new' in field.name %}<span class="required-indicator">*</span>{% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="help-text text-danger">{{ field.errors.0 }}</div>
                        {% endif %}
                        {% if field.name == 'new_password1' %}
                        <div class="password-strength-meter">
                            <div class="password-strength-bar" id="strength-bar"></div>
                        </div>
                        <div class="strength-text" id="strength-text"></div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        æ›´æ–°å¯†ç 
                    </button>
                </form>
            </div>
        </article>

        <!-- Email Card -->
        <article class="settings-card">
            <div class="card-status-bar {% if user.profile.email_verified %}success{% else %}warning{% endif %}"></div>
            <div class="card-body">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        é‚®ç®±éªŒè¯
                    </h3>
                    {% if user.profile.email_verified %}
                        <span class="badge badge-success">å·²éªŒè¯</span>
                    {% else %}
                        <span class="badge badge-warning">æœªéªŒè¯</span>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">å½“å‰é‚®ç®±</label>
                    <div style="font-size: 15px; color: var(--text-main); font-weight: 500;">{{ user.email }}</div>
                </div>

                <form method="post" id="email-form" style="display: flex; flex-direction: column; gap: 20px;">
                    {% csrf_token %}
                    
                    {% if pending_email %}
                        <div class="alert alert-warning">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            <div>
                                éªŒè¯ç å·²å‘é€è‡³ <strong>{{ pending_email.email }}</strong>
                            </div>
                        </div>
                        <input type="hidden" name="email" value="{{ pending_email.email }}">
                    {% else %}
                        <div class="form-group">
                            <label for="{{ email_request_form.email.id_for_label }}" class="form-label">
                                æ–°é‚®ç®±åœ°å€ <span class="required-indicator">*</span>
                            </label>
                            {{ email_request_form.email }}
                            {% if email_request_form.email.errors %}
                            <div class="help-text text-danger">{{ email_request_form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="form-group">
                        <label for="{{ email_confirm_form.code.id_for_label }}" class="form-label">
                            éªŒè¯ç  <span class="required-indicator">*</span>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                {{ email_confirm_form.code }}
                            </div>
                            <button type="button" id="send-code-btn" class="btn btn-secondary" style="width: auto; min-width: 100px;">
                                {% if pending_email %}é‡å‘{% else %}è·å–éªŒè¯ç {% endif %}
                            </button>
                        </div>
                        {% if email_confirm_form.code.errors %}
                        <div class="help-text text-danger">{{ email_confirm_form.code.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <button type="submit" name="action" value="update_email" class="btn btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 19v-8.93a2 2 0 01.89-1.664l7-4.666a2 2 0 012.22 0l7 4.666A2 2 0 0121 10.07V19M3 19a2 2 0 002 2h14a2 2 0 002-2M3 19l6.75-4.5M21 19l-6.75-4.5M3 10l6.75 4.5M21 10l-6.75 4.5m0 0l-1.14.76a2 2 0 01-2.22 0l-1.14-.76"></path>
                        </svg>
                        ç¡®è®¤éªŒè¯å¹¶æ›´æ–°
                    </button>
                </form>
            </div>
        </article>

        <!-- Notifications Card -->
        <article class="settings-card">
            <div class="card-status-bar active"></div>
            <div class="card-body">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        é€šçŸ¥è®¾ç½®
                    </h3>
                </div>

                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 4px;">é‚®ä»¶é€šçŸ¥</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">æ¥æ”¶é‡è¦æ›´æ–°å’Œæé†’</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                            <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--success); border-radius: 34px; transition: var(--transition);">
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: var(--transition); transform: translateX(24px);"></span>
                            </span>
                        </label>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 4px;">æ¯æ—¥æŠ¥å‘Šæé†’</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">æé†’æ‚¨æäº¤æ¯æ—¥å·¥ä½œæŠ¥å‘Š</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                            <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--success); border-radius: 34px; transition: var(--transition);">
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: var(--transition); transform: translateX(24px);"></span>
                            </span>
                        </label>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 4px;">é¡¹ç›®æ›´æ–°</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">é¡¹ç›®çŠ¶æ€å˜æ›´é€šçŸ¥</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                            <input type="checkbox" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 34px; transition: var(--transition);">
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: var(--transition); transform: translateX(0);"></span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </article>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Enhanced Form Initialization ---
        const inputs = document.querySelectorAll('input[type="text"], input[type="password"], input[type="email"]');
        inputs.forEach(input => {
            if (!input.classList.contains('form-input')) {
                input.classList.add('form-input');
            }
        });

        // --- Enhanced Username Availability Check ---
        const usernameInput = document.querySelector('input[name="new_username"]');
        const feedbackDiv = document.getElementById('username-feedback');
        
        if (usernameInput) {
            let timeout = null;
            usernameInput.addEventListener('input', function() {
                const username = this.value.trim();
                clearTimeout(timeout);
                
                // Remove previous states
                feedbackDiv.textContent = '';
                usernameInput.style.borderColor = '';
                usernameInput.classList.remove('loading');
                
                if (username.length > 0) {
                    usernameInput.classList.add('loading');
                    timeout = setTimeout(() => {
                        fetch(`{% url 'username_check_api' %}?username=${encodeURIComponent(username)}`)
                            .then(response => response.json())
                            .then(data => {
                                usernameInput.classList.remove('loading');
                                if (data.is_taken) {
                                    feedbackDiv.textContent = 'âœ— ç”¨æˆ·åå·²è¢«å ç”¨';
                                    feedbackDiv.className = 'help-text text-danger';
                                    usernameInput.style.borderColor = 'var(--danger)';
                                } else {
                                    feedbackDiv.textContent = 'âœ“ ç”¨æˆ·åå¯ç”¨';
                                    feedbackDiv.className = 'help-text text-success';
                                    usernameInput.style.borderColor = 'var(--success)';
                                }
                            })
                            .catch(err => {
                                usernameInput.classList.remove('loading');
                                feedbackDiv.textContent = 'âœ— æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                                feedbackDiv.className = 'help-text text-danger';
                            });
                    }, 600);
                }
            });
        }

        // --- Enhanced Password Strength Meter ---
        const passwordInput = document.querySelector('input[name="new_password1"]');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');

        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let color = 'rgba(255,255,255,0.2)';
                let text = '';

                if (password.length > 0) {
                    if (password.length >= 8) strength += 1;
                    if (password.length >= 12) strength += 1;
                    if (password.match(/[a-z]+/)) strength += 1;
                    if (password.match(/[A-Z]+/)) strength += 1;
                    if (password.match(/[0-9]+/)) strength += 1;
                    if (password.match(/[^A-Za-z0-9]+/)) strength += 1;

                    const percentage = (strength / 6) * 100;
                    strengthBar.style.width = percentage + '%';

                    switch (strength) {
                        case 0: case 1: 
                            color = 'var(--danger)'; 
                            text = 'å¾ˆå¼±'; 
                            break;
                        case 2: case 3: 
                            color = 'var(--warning)'; 
                            text = 'ä¸­ç­‰'; 
                            break;
                        case 4: 
                            color = '#3b82f6'; 
                            text = 'å¼º'; 
                            break;
                        case 5: case 6: 
                            color = 'var(--success)'; 
                            text = 'å¾ˆå¼º'; 
                            break;
                    }
                } else {
                    strengthBar.style.width = '0%';
                }

                strengthBar.style.backgroundColor = color;
                strengthText.textContent = text;
                strengthText.style.color = color;
            });
        }

        // --- Enhanced Email Code Sending ---
        const sendCodeBtn = document.getElementById('send-code-btn');
        if (sendCodeBtn) {
            sendCodeBtn.addEventListener('click', function() {
                const emailInput = document.getElementById('id_email');
                let email = '';
                
                if (emailInput) {
                    email = emailInput.value.trim();
                } else {
                    const hiddenEmail = document.querySelector('input[name="email"]');
                    if (hiddenEmail) email = hiddenEmail.value.trim();
                }

                if (!email) {
                    showMessage('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                    return;
                }

                if (!isValidEmail(email)) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                    return;
                }

                sendCodeBtn.disabled = true;
                sendCodeBtn.classList.add('loading');
                const originalText = sendCodeBtn.innerText;
                sendCodeBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">â³</span> å‘é€ä¸­...';

                fetch('{% url "send_email_code_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    sendCodeBtn.classList.remove('loading');
                    if (data.success) {
                        showMessage(data.message || 'éªŒè¯ç å·²å‘é€', 'success');
                        startCountdown(sendCodeBtn);
                    } else {
                        showMessage(data.error || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.innerText = originalText;
                    }
                })
                .catch(err => {
                    sendCodeBtn.classList.remove('loading');
                    showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerText = originalText;
                });
            });
        }

        // --- Toggle Switches ---
        const toggles = document.querySelectorAll('input[type="checkbox"]');
        toggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const span = this.nextElementSibling;
                const innerSpan = span.querySelector('span:last-child');
                
                if (this.checked) {
                    span.style.backgroundColor = 'var(--success)';
                    innerSpan.style.transform = 'translateX(24px)';
                } else {
                    span.style.backgroundColor = '#cbd5e1';
                    innerSpan.style.transform = 'translateX(0)';
                }
            });
        });

        // --- Quick Actions ---
        const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        quickActionBtns.forEach((btn, index) => {
            btn.addEventListener('click', function() {
                const actions = ['ç¼–è¾‘èµ„æ–™åŠŸèƒ½å¾…å®ç°', 'æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½å¾…å®ç°', 'é«˜çº§è®¾ç½®åŠŸèƒ½å¾…å®ç°'];
                showMessage(actions[index], 'info');
            });
        });
    });

    // --- Utility Functions ---
    function showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        `;
        
        const colors = {
            success: 'linear-gradient(135deg, #10b981, #06b6d4)',
            error: 'linear-gradient(135deg, #ef4444, #f59e0b)',
            info: 'linear-gradient(135deg, #3b82f6, #8b5cf6)'
        };
        
        messageDiv.style.background = colors[type] || colors.info;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 300);
        }, 3000);
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function startCountdown(button) {
        let timeLeft = 60;
        button.innerText = `${timeLeft}s`;
        
        const timer = setInterval(() => {
            timeLeft--;
            button.innerText = `${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                button.disabled = false;
                button.innerText = 'é‡å‘';
            }
        }, 1000);
    }

    // --- Add CSS Animations ---
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
